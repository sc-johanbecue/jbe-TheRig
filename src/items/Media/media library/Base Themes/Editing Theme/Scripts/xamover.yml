---
ID: "62ee9b3c-e513-4b02-b08e-c7872a9ba575"
Parent: "b0652987-4e54-4675-9dd0-2d112ced361b"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: /sitecore/media library/Base Themes/Editing Theme/Scripts/xamover
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/62EE9B3CE5134B02B08EC7872A9BA575.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  BlobID: "62ee9b3c-e513-4b02-b08e-c7872a9ba575"
  Value: dmFyIFNYQTsNCihmdW5jdGlvbiAoU1hBKSB7DQogICAgdmFyIFN4YU1vdmVyID0gKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgZnVuY3Rpb24gU3hhTW92ZXIoc3hhSnF1ZXJ5KSB7DQogICAgICAgICAgICB0aGlzLmFsbG93ZWRSZW5kZXJpbmdzID0gW107DQogICAgICAgICAgICB0aGlzLm5vdGlmeVBsYWNlaG9sZGVyc1Bvc2l0aW9ucyA9IHt9Ow0KICAgICAgICAgICAgdGhpcy5ub3RpZnlCb3hQb3NpdGlvbnMgPSB7fTsNCiAgICAgICAgICAgIHRoaXMuZHJvcHBhYmxlUGxhY2Vob2xkZXJzID0ge307DQogICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVycyA9IHt9Ow0KICAgICAgICAgICAgdGhpcy5kcm9wcGFibGVQbGFjZWhvbGRlcnMgPSBbXTsNCiAgICAgICAgICAgIHRoaXMudG9vbGJveFBsYWNlaG9sZGVyID0gIiI7DQogICAgICAgICAgICB0aGlzLmlzVG9vbGJveERyb3AgPSBmYWxzZTsNCiAgICAgICAgICAgIHRoaXMubW91c2VNYW5hZ2VyID0gbmV3IE1vdXNlTWFuYWdlcigpOw0KICAgICAgICAgICAgdGhpcy5pbml0KCk7DQogICAgICAgICAgICB0aGlzLiQgPSBzeGFKcXVlcnk7DQogICAgICAgICAgICB0aGlzLnRvb2xib3hQbGFjZWhvbGRlciA9IHN4YUpxdWVyeSgiI3dyYXBwZXIiKVswXSA/ICIjd3JhcHBlciIgOiAiI19fbmV4dCI7DQogICAgICAgIH0NCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmdldE9wZW5lZFBsYWNlaG9sZGVyc0NvdW50ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgICAgIHZhciBvcGVuZWRQbGFjZWhvbGRlcnMgPSB0aGlzLiQoJy5zY3BtW2Nocm9tZXR5cGU9InBsYWNlaG9sZGVyIl1ba2luZD0ib3BlbiJdJyksIGNvdW50ID0gMDsNCiAgICAgICAgICAgIG9wZW5lZFBsYWNlaG9sZGVycy5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWxtZW50KSB7DQogICAgICAgICAgICAgICAgdmFyICRvcGVuQ29kZSA9IF90aGlzLiQoZWxtZW50KSwga2V5ID0gJG9wZW5Db2RlLmF0dHIoJ2tleScpLCBjaHJvbWVLZXksIGNocm9tZSwgaTsNCiAgICAgICAgICAgICAgICBpZiAoJG9wZW5Db2RlLnNpYmxpbmdzKCcuc2NFbXB0eVBsYWNlaG9sZGVyW3NjLXBsYWNlaG9sZGVyLWlkPSInICsgJG9wZW5Db2RlLmF0dHIoImlkIikgKyAiXCJdIikubGVuZ3RoICE9PSAwKSB7DQogICAgICAgICAgICAgICAgICAgIGNvdW50Kys7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IF90aGlzLmNocm9tZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgY2hyb21lID0gX3RoaXMuY2hyb21lc1tpXTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGNocm9tZS5fb3JpZ2luYWxET01FbGVtZW50Lmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZUtleSA9IGNocm9tZS5fb3JpZ2luYWxET01FbGVtZW50WzBdLmF0dHJpYnV0ZXNbImtleSJdOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNocm9tZUtleSAhPT0gdW5kZWZpbmVkICYmDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lS2V5ICE9PSBudWxsICYmDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lS2V5LnZhbHVlID09PSBrZXkgJiYNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUuZGF0YSAhPT0gdW5kZWZpbmVkICYmDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLmRhdGEuY3VzdG9tICE9PSB1bmRlZmluZWQgJiYNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUuZGF0YS5jdXN0b20uZWRpdGFibGUgPT09ICJ0cnVlIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIHJldHVybiBjb3VudDsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmNsZWFudXAgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB0aGlzLiQoIi5zeGEtdG9vbGJveC1kaXYudG9vbGJveC1kcm9wcGluZyIpLnJlbW92ZSgpOw0KICAgICAgICAgICAgdGhpcy4kKCIuc3hhLXRvb2xib3gtZHJvcHBhYmxlIikucmVtb3ZlQ2xhc3MoInN4YS10b29sYm94LWRyb3BwYWJsZSIpOw0KICAgICAgICAgICAgdGhpcy4kKCIudG9vbGJveC1kcm9wcGluZyIpLnJlbW92ZUNsYXNzKCJ0b29sYm94LWRyb3BwaW5nIik7DQogICAgICAgICAgICB0aGlzLiQoIi56Zy1oZWlnaHQtZml4IikucmVtb3ZlQ2xhc3MoInpnLWhlaWdodC1maXgiKTsNCiAgICAgICAgICAgIHRoaXMuJCgiLnN4YS1kaXNhYmxlZC1wbGFjZWhvbGRlciIpLnJlbW92ZUNsYXNzKCJzeGEtZGlzYWJsZWQtcGxhY2Vob2xkZXIiKTsNCiAgICAgICAgICAgIHRoaXMuJCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlIikucmVtb3ZlKCk7DQogICAgICAgICAgICB0aGlzLiQoIi5ub3RpZnktYm94IikucmVtb3ZlKCk7DQogICAgICAgICAgICB0aGlzLmN1cnJlbnRDaHJvbWUgPSBudWxsOw0KICAgICAgICAgICAgU2l0ZWNvcmUuUGFnZU1vZGVzLkNocm9tZUhpZ2hsaWdodE1hbmFnZXIuaGlnaGxpZ2h0Q2hyb21lcygpOw0KICAgICAgICAgICAgU2l0ZWNvcmUuUGFnZU1vZGVzLkNocm9tZUhpZ2hsaWdodE1hbmFnZXIucGxhblVwZGF0ZSgpOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUucHJlcGFyZURyb3BwYWJsZVBsYWNlaG9sZGVycyA9IGZ1bmN0aW9uIChyZW5kZXJpbmcsIGludm9rZXIpIHsNCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgICAgICB2YXIgb3BlbmVkUGxhY2Vob2xkZXJzID0gdGhpcy4kKCIuc2NwbVtjaHJvbWV0eXBlPVwicGxhY2Vob2xkZXJcIl1ba2luZD1cIm9wZW5cIl0iKSwgcGxhY2Vob2xkZXJzUmVuZGVyaW5ncyA9IHRoaXMuZ2V0UGxhY2Vob2xkZXJzUmVuZGVyaW5ncygpLCBpc01vdmluZ0NvbXBvbmVudCA9IHJlbmRlcmluZy5kYXRhKCJtb3ZpbmciKSAhPT0gdW5kZWZpbmVkLCBjaGVjayA9IHJlbmRlcmluZy5kYXRhKCJnZXRQbGFjZWhvbGRlclBvc2l0aW9uQ2hhbmdlIikgfHwgKGZ1bmN0aW9uIChvLCBtLCBnKSB7IHJldHVybiAoLTEpOyB9KSwgY29tcG9uZW50UGxhY2Vob2xkZXI7DQogICAgICAgICAgICBpZiAocmVuZGVyaW5nLmRhdGEoImNvbXBvbmVudCIpICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICBjb21wb25lbnRQbGFjZWhvbGRlciA9IHRoaXMuJChyZW5kZXJpbmcuZGF0YSgiY29tcG9uZW50IikudHlwZS5nZXRQbGFjZWhvbGRlcigpLm9wZW5pbmdNYXJrZXIoKSkuYXR0cigia2V5Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBvcGVuZWRQbGFjZWhvbGRlcnMuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHsNCiAgICAgICAgICAgICAgICB2YXIgcGggPSBfdGhpcy4kKGVsZW1lbnQpLCBwbGFjZWhvbGRlclJlbmRlcmluZ3MgPSBwbGFjZWhvbGRlcnNSZW5kZXJpbmdzLmZpbHRlcihmdW5jdGlvbiAocGhyKSB7IHJldHVybiAocGhyLm5hbWUgPT09IHBoLmF0dHIoImtleSIpKTsgfSk7DQogICAgICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyc1JlbmRlcmluZ3MubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgZHN0UGggPSBwaFswXS5hdHRyaWJ1dGVzWydrZXknXS52YWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHNyY1BoID0gY29tcG9uZW50UGxhY2Vob2xkZXI7DQogICAgICAgICAgICAgICAgICAgIHZhciBwaFZhbGlkYXRvciA9IG5ldyBTWEEuRmVhdHVyZS5Db21wb3NpdGVzLkNvbXBvc2l0ZVBsYWNlaG9sZGVyVmFsaWRhdG9yKCk7DQogICAgICAgICAgICAgICAgICAgIGlmIChzcmNQaCA9PSBudWxsIHx8IHBoVmFsaWRhdG9yLnZhbGlkYXRlKGRzdFBoLCBzcmNQaCkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNyZWF0ZVBsYWNlaG9sZGVycy5jYWxsKF90aGlzLCBwaCwgcmVuZGVyaW5nLCBjb21wb25lbnRQbGFjZWhvbGRlciwgY2hlY2ssIGlzTW92aW5nQ29tcG9uZW50LCBwbGFjZWhvbGRlclJlbmRlcmluZ3NbMF0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBpZiAodHlwZW9mIGludm9rZXIgIT09ICJ1bmRlZmluZWQiKSB7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGljaygpOw0KICAgICAgICAgICAgICAgIGludm9rZXIuZHJvcHBhYmxlKHsNCiAgICAgICAgICAgICAgICAgICAgZHJvcDogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuaXNUb29sYm94RHJvcCA9IHRydWU7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHZhciBkcm9wUGxhY2VzID0gdGhpcy5nZXRQb3NzaWJsZURyb3BQbGFjZXMoKTsNCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZHJvcFBsYWNlcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgIHZhciBlbGVtZW4gPSBkcm9wUGxhY2VzW2ldOw0KICAgICAgICAgICAgICAgIHdoaWxlIChlbGVtZW4uYXR0cmlidXRlc1sna2V5J10gPT0gbnVsbCkgew0KICAgICAgICAgICAgICAgICAgICBlbGVtZW4gPSBlbGVtZW4ucHJldmlvdXNFbGVtZW50U2libGluZzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdmFyIGRzdFBoID0gZWxlbWVuLmF0dHJpYnV0ZXNbJ2tleSddLnZhbHVlOw0KICAgICAgICAgICAgICAgIHZhciBzcmNQaCA9IGNvbXBvbmVudFBsYWNlaG9sZGVyOw0KICAgICAgICAgICAgICAgIHZhciBwaFZhbGlkYXRvciA9IG5ldyBTWEEuRmVhdHVyZS5Db21wb3NpdGVzLkNvbXBvc2l0ZVBsYWNlaG9sZGVyVmFsaWRhdG9yKCk7DQogICAgICAgICAgICAgICAgaWYgKHNyY1BoID09IG51bGwgfHwgcGhWYWxpZGF0b3IudmFsaWRhdGUoZHN0UGgsIHNyY1BoKSkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXRpYWxpemVEcmFwYWJpbGl0eS5jYWxsKHRoaXMsIHRoaXMuJChkcm9wUGxhY2VzW2ldKSwgcmVuZGVyaW5nLCBjb21wb25lbnRQbGFjZWhvbGRlciwgaXNNb3ZpbmdDb21wb25lbnQpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuJCgiLnNjRW1wdHlQbGFjZWhvbGRlci51aS1kcm9wcGFibGUuc3hhLXRvb2xib3gtZHJvcHBhYmxlIikuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsZW0pIHsNCiAgICAgICAgICAgICAgICB2YXIgJGVsZW0gPSBfdGhpcy4kKGVsZW0pOw0KICAgICAgICAgICAgICAgIGlmICgkZWxlbS5wcmV2QWxsKCJjb2RlIikuYXR0cigiaWQiKSA9PT0gJGVsZW0uYXR0cigic2MtcGxhY2Vob2xkZXItaWQiKSkgew0KICAgICAgICAgICAgICAgICAgICAkZWxlbS5odG1sKF90aGlzLiQoZWxlbSkucHJldkFsbCgiY29kZSIpLmF0dHIoImtleSIpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5DaHJvbWVIaWdobGlnaHRNYW5hZ2VyLmhpZ2hsaWdodENocm9tZXMoKTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmNsZWFyRHJvcHBhYmxlUGxhY2Vob2xkZXJzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyIGk7DQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5kcm9wcGFibGVQbGFjZWhvbGRlcnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuZHJvcHBhYmxlUGxhY2Vob2xkZXJzW2ldLmhhc0NsYXNzKCJ0b29sYm94LWRyb3BwaW5nIikpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wcGFibGVQbGFjZWhvbGRlcnNbaV0ucmVtb3ZlKCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy5kcm9wcGFibGVQbGFjZWhvbGRlcnMgPSBbXTsNCiAgICAgICAgICAgIHRoaXMuJCgiLnN4YS10b29sYm94LWRpdi51aS1kcm9wcGFibGUsLnNjRW1wdHlQbGFjZWhvbGRlci5zeGEtdG9vbGJveC1kcm9wcGFibGUiKS5ub3QoIi50b29sYm94LWRyb3BwaW5nIikucmVtb3ZlQ2xhc3MoInN4YS10b29sYm94LWRyb3BwYWJsZSIpLmh0bWwoIiIpOw0KICAgICAgICAgICAgdGhpcy4kKCIuemctaGVpZ2h0LWZpeCIpLnJlbW92ZUNsYXNzKCJ6Zy1oZWlnaHQtZml4Iik7DQogICAgICAgICAgICB0aGlzLiQoIi5zeGEtZGlzYWJsZWQtcGxhY2Vob2xkZXIiKS5yZW1vdmVDbGFzcygic3hhLWRpc2FibGVkLXBsYWNlaG9sZGVyIik7DQogICAgICAgICAgICB0aGlzLiQoIi5ub3RpZnktYm94IikucmVtb3ZlKCk7DQogICAgICAgICAgICB0aGlzLm1vdXNlTWFuYWdlci5zdG9wVHJhY2tpbmcoKTsNCiAgICAgICAgICAgIHRoaXMubm90aWZ5UGxhY2Vob2xkZXJzUG9zaXRpb25zID0ge307DQogICAgICAgICAgICB0aGlzLm5vdGlmeUJveFBvc2l0aW9ucyA9IHt9Ow0KICAgICAgICAgICAgdGhpcy4kKCIuc2NFbXB0eVBsYWNlaG9sZGVyIikuY3NzKCJ3aWR0aCIsICIiKTsNCiAgICAgICAgICAgIHRoaXMuJCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlLWltYWdlIikuYXR0cigibGVmdCIsICItMjNweCIpOw0KICAgICAgICAgICAgU2l0ZWNvcmUuUGFnZU1vZGVzLkNocm9tZUhpZ2hsaWdodE1hbmFnZXIuaGlnaGxpZ2h0Q2hyb21lcygpOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUucmVmcmVzaENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgaSwgaiwgY2hyb21lLCBjaHJvbWVLZXk7DQogICAgICAgICAgICBpZiAoIVhBLmhhc1BhZ2VNb2RlcygpKQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIHRoaXMuYWxsb3dlZFJlbmRlcmluZ3MgPSBbXTsNCiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXJzID0ge307DQogICAgICAgICAgICB0aGlzLmNocm9tZXMgPSBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lTWFuYWdlci5jaHJvbWVzKCk7DQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5jaHJvbWVzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgY2hyb21lID0gdGhpcy5jaHJvbWVzW2ldOw0KICAgICAgICAgICAgICAgIGlmIChjaHJvbWUuZGF0YSAhPT0gdW5kZWZpbmVkICYmIGNocm9tZS5kYXRhLmN1c3RvbSAhPT0gdW5kZWZpbmVkICYmIGNocm9tZS5kYXRhLmN1c3RvbS5hbGxvd2VkUmVuZGVyaW5ncyAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBjaHJvbWVSZW5kZXJpbmdzID0gY2hyb21lLmRhdGEuY3VzdG9tLmFsbG93ZWRSZW5kZXJpbmdzOw0KICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgY2hyb21lUmVuZGVyaW5ncy5sZW5ndGg7IGorKykgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJC5pbkFycmF5KGNocm9tZVJlbmRlcmluZ3Nbal0sIHRoaXMuYWxsb3dlZFJlbmRlcmluZ3MpID09PSAtMSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWxsb3dlZFJlbmRlcmluZ3MucHVzaChjaHJvbWVSZW5kZXJpbmdzW2pdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBpZiAoY2hyb21lLl9vcmlnaW5hbERPTUVsZW1lbnQubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lS2V5ID0gY2hyb21lLl9vcmlnaW5hbERPTUVsZW1lbnRbMF0uYXR0cmlidXRlc1sia2V5Il07DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hyb21lS2V5ICE9PSB1bmRlZmluZWQgJiYgY2hyb21lS2V5ICE9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGFjZWhvbGRlcnNbY2hyb21lS2V5LnZhbHVlXSA9IGNocm9tZVJlbmRlcmluZ3M7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5nZXRDdXJyZW50Q2hyb21lID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudENocm9tZTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmdldEFsbG93ZWRSZW5kZXJpbmdzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWxsb3dlZFJlbmRlcmluZ3M7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5pbml0TW92ZUNvbXBvbmVudFBsdWdJbiA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywgc2l0ZWNvcmVTb3J0aW5nLCBzY0luc2VydFNvcnRpbmdIYW5kbGUsIHN4YUluc2VydFNvcnRpbmdIYW5kbGUsIHNjU29ydGluZ0hhbmRsZXI7DQogICAgICAgICAgICBpZiAoIVhBLmhhc1BhZ2VNb2RlcygpKQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIHNpdGVjb3JlU29ydGluZyA9IFNpdGVjb3JlLlBhZ2VNb2Rlcy5DaHJvbWVUeXBlcy5QbGFjZWhvbGRlclNvcnRpbmcucHJvdG90eXBlOw0KICAgICAgICAgICAgc2NJbnNlcnRTb3J0aW5nSGFuZGxlID0gc2l0ZWNvcmVTb3J0aW5nLmluc2VydFNvcnRpbmdIYW5kbGU7DQogICAgICAgICAgICB2YXIgdmFsaWRhdG9yID0gbmV3IFNYQS5GZWF0dXJlLkNvbXBvc2l0ZXMuQ29tcG9zaXRlUGxhY2Vob2xkZXJWYWxpZGF0b3IoKTsNCiAgICAgICAgICAgIHN4YUluc2VydFNvcnRpbmdIYW5kbGUgPSBmdW5jdGlvbiAod2hlcmUsIGNocm9tZSwgaW5zZXJ0UG9zaXRpb24sIHBvc2l0aW9uQ291bnQpIHsNCiAgICAgICAgICAgICAgICB2YXIgY2xpY2tIYW5kbGVycywgbGFzdEhhbmRsZXIsIGJpbmRFdmVudDsNCiAgICAgICAgICAgICAgICBzY1NvcnRpbmdIYW5kbGVyID0gdGhpczsNCiAgICAgICAgICAgICAgICB2YXIgcnVpZCA9IHNjU29ydGluZ0hhbmRsZXIucmVuZGVyaW5nLl9vcmlnaW5hbERPTUVsZW1lbnQuYXR0cignaWQnKS5yZXBsYWNlKCJyXyIsICIiKTsNCiAgICAgICAgICAgICAgICB2YXIgc291cmNlUGggPSBTaXRlY29yZS5MYXlvdXREZWZpbml0aW9uLmdldFJlbmRlcmluZyhydWlkKVsiQHBoIl07DQogICAgICAgICAgICAgICAgdmFyIHRhcmdldFBoID0gc2NTb3J0aW5nSGFuZGxlci5wbGFjZWhvbGRlci5fb3JpZ2luYWxET01FbGVtZW50LmF0dHIoJ2tleScpOw0KICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdG9yLnZhbGlkYXRlKHNvdXJjZVBoLCB0YXJnZXRQaCkpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBzY0luc2VydFNvcnRpbmdIYW5kbGUuY2FsbChzY1NvcnRpbmdIYW5kbGVyLCB3aGVyZSwgY2hyb21lLCBpbnNlcnRQb3NpdGlvbiwgcG9zaXRpb25Db3VudCk7DQogICAgICAgICAgICAgICAgY2xpY2tIYW5kbGVycyA9IHNjU29ydGluZ0hhbmRsZXIuaGFuZGxlcy5zcGxpY2UoMCk7DQogICAgICAgICAgICAgICAgbGFzdEhhbmRsZXIgPSAkc2MoY2xpY2tIYW5kbGVyc1tjbGlja0hhbmRsZXJzLmxlbmd0aCAtIDFdKTsNCiAgICAgICAgICAgICAgICBsYXN0SGFuZGxlci51bmJpbmQoImNsaWNrIik7DQogICAgICAgICAgICAgICAgYmluZEV2ZW50ID0gZnVuY3Rpb24gKHApIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gcDsgfSgpOw0KICAgICAgICAgICAgICAgICAgICBsYXN0SGFuZGxlci5jbGljaygkc2MucHJveHkoZnVuY3Rpb24gKGUpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnRUcmVlID0gc2VsZi5nZXRDb21wb25lbnRUcmVlKHRoaXMucmVuZGVyaW5nKSwgY29tcG9uZW50ID0gdGhpcy5yZW5kZXJpbmc7DQogICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3AoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5EZXNpZ25NYW5hZ2VyLnNvcnRpbmdFbmQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5EZXNpZ25NYW5hZ2VyLm1vdmVDb250cm9sVG8oY29tcG9uZW50LCB0aGlzLnBsYWNlaG9sZGVyLCBwb3NpdGlvbik7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1vdmVDb21wb25lbnRUcmVlKGNvbXBvbmVudCwgY29tcG9uZW50VHJlZSk7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNb3ZlQWN0aW9ucyhjb21wb25lbnQpOw0KICAgICAgICAgICAgICAgICAgICB9LCBzY1NvcnRpbmdIYW5kbGVyKSk7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBiaW5kRXZlbnQoaW5zZXJ0UG9zaXRpb24pOw0KICAgICAgICAgICAgICAgIHNjU29ydGluZ0hhbmRsZXIuaGFuZGxlcyA9IGNsaWNrSGFuZGxlcnM7DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICBzaXRlY29yZVNvcnRpbmcuaW5zZXJ0U29ydGluZ0hhbmRsZSA9IHN4YUluc2VydFNvcnRpbmdIYW5kbGU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoZSkgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuaW5pdERlbGV0ZUNvbXBvbmVudFBsdWdJbiA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgICAgICBpZiAoIVhBLmhhc1BhZ2VNb2RlcygpKQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywgc2l0ZWNvcmVSZW5kZXJpbmcgPSBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lVHlwZXMuUmVuZGVyaW5nLnByb3RvdHlwZSwgc2l0ZWNvcmVEZWxldGVDb250cm9sID0gc2l0ZWNvcmVSZW5kZXJpbmcuZGVsZXRlQ29udHJvbCwgY3NzQ2xhc3MgPSAiemctY2FzY2FkZS1kZWxldGUiLCBzZXRTdHlsZVZpc2libGUgPSBmdW5jdGlvbiAodmlzaWJsZSwgaHRtbEVsZW1lbnRzKSB7DQogICAgICAgICAgICAgICAgdmFyIHRvU3R5bGUgPSBfdGhpcy4kKGh0bWxFbGVtZW50cykuZmlsdGVyKCIuc2NFbmFibGVkQ2hyb21lIik7DQogICAgICAgICAgICAgICAgaWYgKHZpc2libGUpIHsNCiAgICAgICAgICAgICAgICAgICAgdG9TdHlsZS5hZGRDbGFzcyhjc3NDbGFzcyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0b1N0eWxlLnJlbW92ZUNsYXNzKGNzc0NsYXNzKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LCBkb2VzVXNlckNvbmZpcm1DYXNjYWRlRGVsZXRlID0gZnVuY3Rpb24gKGNvbXBvbmVudFRyZWUpIHsNCiAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9ICJUaGlzIG9wZXJhdGlvbiB3aWxsIGRlbGV0ZSB0aGUgZm9sbG93aW5nIG5lc3RlZCBjb21wb25lbnRzOlxuIiwgY3VycmVudCwgaTsNCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29tcG9uZW50VHJlZS5iZnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGNvbXBvbmVudFRyZWUuYmZzW2ldOw0KICAgICAgICAgICAgICAgICAgICBtZXNzYWdlICs9ICJcdTAwQjcgIiArIGN1cnJlbnQubm9kZS5fZGlzcGxheU5hbWUgKyAiXG4iOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm4gY29uZmlybShtZXNzYWdlKTsNCiAgICAgICAgICAgIH0sIGRlbGV0ZU5lc3RlZENvbXBvbmVudHMgPSBmdW5jdGlvbiAoY29tcG9uZW50VHJlZSkgew0KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50LCBjb250ZXh0LCBpOw0KICAgICAgICAgICAgICAgIGZvciAoaSA9IGNvbXBvbmVudFRyZWUuYmZzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7DQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjb21wb25lbnRUcmVlLmJmc1tpXS5ub2RlOw0KICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY3VycmVudC50eXBlOw0KICAgICAgICAgICAgICAgICAgICBzaXRlY29yZURlbGV0ZUNvbnRyb2wuY2FsbChjb250ZXh0LCBjdXJyZW50LnR5cGUuY2hyb21lKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LCB6Z0RlbGV0ZUNvbnRyb2wgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBjb21wb25lbnQgPSBjb250ZXh0LmNocm9tZSwgaHRtbEVsZW1lbnRzLCBjb21wb25lbnRUcmVlID0gc2VsZi5nZXRDb21wb25lbnRUcmVlKGNvbXBvbmVudCk7DQogICAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudFRyZWUuYmZzLmxlbmd0aCAhPT0gMSkgew0KICAgICAgICAgICAgICAgICAgICBodG1sRWxlbWVudHMgPSBjb21wb25lbnRUcmVlLm5vZGUuZWxlbWVudDsNCiAgICAgICAgICAgICAgICAgICAgc2V0U3R5bGVWaXNpYmxlKHRydWUsIGh0bWxFbGVtZW50cyk7DQogICAgICAgICAgICAgICAgICAgIGlmIChkb2VzVXNlckNvbmZpcm1DYXNjYWRlRGVsZXRlKGNvbXBvbmVudFRyZWUpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGVOZXN0ZWRDb21wb25lbnRzKGNvbXBvbmVudFRyZWUpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHNldFN0eWxlVmlzaWJsZShmYWxzZSwgaHRtbEVsZW1lbnRzKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHNpdGVjb3JlRGVsZXRlQ29udHJvbC5jYWxsKGNvbnRleHQsIGNvbXBvbmVudCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgc2l0ZWNvcmVSZW5kZXJpbmcuZGVsZXRlQ29udHJvbCA9IHpnRGVsZXRlQ29udHJvbDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIChlKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5pbml0VG91Y2hEcmFnTkRyb3BQbHVnSW4gPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAhZnVuY3Rpb24gKGEpIHsNCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBmKGEsIGIpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCEoYS5vcmlnaW5hbEV2ZW50LnRvdWNoZXMubGVuZ3RoID4gMSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGEucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjID0gYS5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLCBkID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7DQogICAgICAgICAgICAgICAgICAgICAgICBkLmluaXRNb3VzZUV2ZW50KGIsICEwLCAhMCwgd2luZG93LCAxLCBjLnNjcmVlblgsIGMuc2NyZWVuWSwgYy5jbGllbnRYLCBjLmNsaWVudFksICExLCAhMSwgITEsICExLCAwLCBudWxsKSwgYS50YXJnZXQuZGlzcGF0Y2hFdmVudChkKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAoYS5zdXBwb3J0LnRvdWNoID0gIm9udG91Y2hlbmQiIGluIGRvY3VtZW50LCBhLnN1cHBvcnQudG91Y2gpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGUsIGIgPSBhLnVpLm1vdXNlLnByb3RvdHlwZSwgYyA9IGIuX21vdXNlSW5pdCwgZCA9IGIuX21vdXNlRGVzdHJveTsNCiAgICAgICAgICAgICAgICAgICAgYi5fdG91Y2hTdGFydCA9IGZ1bmN0aW9uIChhKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IHRoaXM7DQogICAgICAgICAgICAgICAgICAgICAgICAhZSAmJiBiLl9tb3VzZUNhcHR1cmUoYS5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdKSAmJiAoZSA9ICEwLCBiLl90b3VjaE1vdmVkID0gITEsIGYoYSwgIm1vdXNlb3ZlciIpLCBmKGEsICJtb3VzZW1vdmUiKSwgZihhLCAibW91c2Vkb3duIikpOw0KICAgICAgICAgICAgICAgICAgICB9LCBiLl90b3VjaE1vdmUgPSBmdW5jdGlvbiAoYSkgeyBlICYmICh0aGlzLl90b3VjaE1vdmVkID0gITAsIGYoYSwgIm1vdXNlbW92ZSIpKTsgfSwgYi5fdG91Y2hFbmQgPSBmdW5jdGlvbiAoYSkgeyBlICYmIChmKGEsICJtb3VzZXVwIiksIGYoYSwgIm1vdXNlb3V0IiksIHRoaXMuX3RvdWNoTW92ZWQgfHwgZihhLCAiY2xpY2siKSwgZSA9ICExKTsgfSwgYi5fbW91c2VJbml0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSB0aGlzOw0KICAgICAgICAgICAgICAgICAgICAgICAgYi5lbGVtZW50LmJpbmQoeyB0b3VjaHN0YXJ0OiBhLnByb3h5KGIsICJfdG91Y2hTdGFydCIpLCB0b3VjaG1vdmU6IGEucHJveHkoYiwgIl90b3VjaE1vdmUiKSwgdG91Y2hlbmQ6IGEucHJveHkoYiwgIl90b3VjaEVuZCIpIH0pLCBjLmNhbGwoYik7DQogICAgICAgICAgICAgICAgICAgIH0sIGIuX21vdXNlRGVzdHJveSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiID0gdGhpczsNCiAgICAgICAgICAgICAgICAgICAgICAgIGIuZWxlbWVudC51bmJpbmQoeyB0b3VjaHN0YXJ0OiBhLnByb3h5KGIsICJfdG91Y2hTdGFydCIpLCB0b3VjaG1vdmU6IGEucHJveHkoYiwgIl90b3VjaE1vdmUiKSwgdG91Y2hlbmQ6IGEucHJveHkoYiwgIl90b3VjaEVuZCIpIH0pLCBkLmNhbGwoYik7DQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSh0aGlzLiQpOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgICAgICBpZiAoIVhBLmhhc1BhZ2VNb2RlcygpKQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5DaHJvbWVNYW5hZ2VyLmNocm9tZXNSZXNldGVkLm9ic2VydmUoJHNjLnByb3h5KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBfdGhpcy5jbGVhbnVwKCk7DQogICAgICAgICAgICB9KSk7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5nZXRQb3NzaWJsZURyb3BQbGFjZXMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICAgICAgdmFyIGRyb3BQbGFjZXMgPSB0aGlzLiQoIi5zeGEtdG9vbGJveC1kaXYsLnNjRW1wdHlQbGFjZWhvbGRlciIpLm5vdCgiLnVpLWRyb3BwYWJsZSIpLnRvQXJyYXkoKTsNCiAgICAgICAgICAgIGRyb3BQbGFjZXMuc29ydChmdW5jdGlvbiAoZmlyc3QsIHNlY29uZCkgew0KICAgICAgICAgICAgICAgIHZhciBmaXJzdEtleSA9IF90aGlzLiQoZmlyc3QpLmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZSIpLmF0dHIoImtleSIpLCBzZWNvbmRLZXkgPSBfdGhpcy4kKHNlY29uZCkuZmluZCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlIikuYXR0cigia2V5Iik7DQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmaXJzdEtleSA9PT0gInVuZGVmaW5lZCIpIHsNCiAgICAgICAgICAgICAgICAgICAgZmlyc3RLZXkgPSBfdGhpcy4kKGZpcnN0KS5wcmV2QWxsKCJjb2RlIikNCiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuJChlbGVtZW50KS5hdHRyKCdrZXknKTsNCiAgICAgICAgICAgICAgICAgICAgfSkuYXR0cigia2V5Iik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2Vjb25kS2V5ID09PSAidW5kZWZpbmVkIikgew0KICAgICAgICAgICAgICAgICAgICBzZWNvbmRLZXkgPSBfdGhpcy4kKHNlY29uZCkucHJldkFsbCgiY29kZSIpLmZpbHRlcihmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy4kKGVsZW1lbnQpLmF0dHIoJ2tleScpOw0KICAgICAgICAgICAgICAgICAgICB9KS5hdHRyKCJrZXkiKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmNvdW50U2xhc2hlcyhmaXJzdEtleSkgLSBfdGhpcy5jb3VudFNsYXNoZXMoc2Vjb25kS2V5KTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgcmV0dXJuIGRyb3BQbGFjZXM7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5jb3VudFNsYXNoZXMgPSBmdW5jdGlvbiAocGgpIHsNCiAgICAgICAgICAgIHJldHVybiAocGgubWF0Y2goL1wvL2cpIHx8IFtdKS5sZW5ndGg7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5jcmVhdGVQbGFjZWhvbGRlckh0bWxFbGVtZW50ID0gZnVuY3Rpb24gKHBsYWNlaG9sZGVyLCBwbGhJZCwgZGlzYWJsZWQpIHsNCiAgICAgICAgICAgIGlmIChkaXNhYmxlZCA9PT0gdm9pZCAwKSB7IGRpc2FibGVkID0gdHJ1ZTsgfQ0KICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLm5leHQoKSAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgdmFyIHRlbXBQaElkID0gcGxhY2Vob2xkZXIubmV4dCgpLmF0dHIoImhpbnRuYW1lIik7DQogICAgICAgICAgICAgICAgdmFyIGluZGV4T2ZMYXN0U2xhc2ggPSBwbGhJZC5sYXN0SW5kZXhPZignLycpOw0KICAgICAgICAgICAgICAgIGlmIChpbmRleE9mTGFzdFNsYXNoID4gMCkgew0KICAgICAgICAgICAgICAgICAgICBwbGhJZCA9IHBsaElkLnN1YnN0cmluZygwLCBpbmRleE9mTGFzdFNsYXNoICsgMSkgKyB0ZW1wUGhJZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHBsaElkID0gdGVtcFBoSWQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdmFyIGRyb3BQbGFjZSA9IHRoaXMuJCgiPGRpdiBjbGFzcz1cInpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlXCIga2V5PVwiIiArIHBsaElkICsgIlwiIHN0eWxlPVwid2lkdGg6ICIgKyBwbGFjZWhvbGRlci5jc3MoIndpZHRoIikgKyAiOyB2aXNpYmlsaXR5OiBoaWRkZW5cIj4iICsNCiAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz1cImlubmVyXCI+PC9kaXY+IiArDQogICAgICAgICAgICAgICAgIjwvZGl2PiIpOw0KICAgICAgICAgICAgaWYgKGRpc2FibGVkKSB7DQogICAgICAgICAgICAgICAgcGxhY2Vob2xkZXIuYXBwZW5kKGRyb3BQbGFjZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBwbGFjZWhvbGRlci5hZGRDbGFzcygic3hhLXRvb2xib3gtZHJvcHBhYmxlIik7DQogICAgICAgICAgICBpZiAoIXBsYWNlaG9sZGVyLmhhc0NsYXNzKCJzeGEtdG9vbGJveC1kaXYiKSkgew0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLmNzcygid2lkdGgiLCBwbGFjZWhvbGRlci5wYXJlbnQoKS5jc3MoIndpZHRoIikpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLmhhc0NsYXNzKCJzY0VtcHR5UGxhY2Vob2xkZXIiKSkgew0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLnBhcmVudCgpLmFkZENsYXNzKCJ6Zy1oZWlnaHQtZml4Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIWRpc2FibGVkKSB7DQogICAgICAgICAgICAgICAgcGxhY2Vob2xkZXIucGFyZW50KCkuYWRkQ2xhc3MoInN4YS1kaXNhYmxlZC1wbGFjZWhvbGRlciIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuaW5pdGlhbGl6ZURyYXBhYmlsaXR5ID0gZnVuY3Rpb24gKHBsYWNlaG9sZGVyLCByZW5kZXJpbmcsIGNvbXBvbmVudFBsYWNlaG9sZGVyLCBpc01vdmluZ0NvbXBvbmVudCkgew0KICAgICAgICAgICAgdmFyIHBsaElkID0gcGxhY2Vob2xkZXIuYXR0cigic2MtcGxhY2Vob2xkZXItaWQiKSwgc2VsZiA9IHRoaXM7DQogICAgICAgICAgICBpZiAocGxhY2Vob2xkZXIucHJldkFsbCgiY29kZSIpLmF0dHIoImlkIikgPT09IHBsaElkKSB7DQogICAgICAgICAgICAgICAgcGxoSWQgPSBwbGFjZWhvbGRlci5wcmV2QWxsKCJjb2RlIikuYXR0cigia2V5Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoaXNNb3ZpbmdDb21wb25lbnQgJiYgcmVuZGVyaW5nLmRhdGEoImlzUGxhY2Vob2xkZXJOZXN0ZWRJbnNpZGVDb21wb25lbnQiKShjb21wb25lbnRQbGFjZWhvbGRlciwgcGxoSWQsIHJlbmRlcmluZykpIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAodGhpcy4kLmluQXJyYXkocmVuZGVyaW5nLmRhdGEoImlkIiksIHRoaXMucGxhY2Vob2xkZXJzW3BsaElkXSkgIT09IC0xKSB7DQogICAgICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLmNoaWxkcmVuKCIuemctZGVsaWdodGZ1bC1kcm9wcGFibGUiKS5sZW5ndGggPT09IDApIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVQbGFjZWhvbGRlckh0bWxFbGVtZW50KHBsYWNlaG9sZGVyLCBwbGhJZCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZSwgLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlLWltYWdlIikubm90KCIuaW5uZXIiKS5kcm9wcGFibGUoew0KICAgICAgICAgICAgICAgICAgICB0b2xlcmFuY2U6ICJwb2ludGVyIiwNCiAgICAgICAgICAgICAgICAgICAgb3V0OiBmdW5jdGlvbiAoZXZlbnQsIHVpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi4kKHRoaXMpLmhhc0NsYXNzKCJ6Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZS1pbWFnZSIpIHx8IHNlbGYuJCh0aGlzKS5wYXJlbnQoKS5oYXNDbGFzcygic2NFbXB0eVBsYWNlaG9sZGVyIikpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm5vdGlmeURyb3BQbGFjZS5jYWxsKHNlbGYsIHRydWUsIHNlbGYuJCh0aGlzKSk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIG92ZXI6IGZ1bmN0aW9uIChldmVudCwgdWkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi4kKF90aGlzKS5oYXNDbGFzcygiemctZGVsaWdodGZ1bC1kcm9wcGFibGUtaW1hZ2UiKSB8fCBzZWxmLiQoX3RoaXMpLnBhcmVudCgpLmhhc0NsYXNzKCJzY0VtcHR5UGxhY2Vob2xkZXIiKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm5vdGlmeURyb3BQbGFjZS5jYWxsKHNlbGYsIGZhbHNlLCBzZWxmLiQoX3RoaXMpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9LCA1MCk7DQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIGRyb3A6IGZ1bmN0aW9uIChldmVudCwgdWkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGxhY2Vob2xkZXJEcm9wKHJlbmRlcmluZywgcGxoSWQsIHVpLCBzZWxmLiQodGhpcykucGFyZW50KCkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgc2VsZi5oYW5kbGVJbWFnZU1vdXNlTW92ZXMuY2FsbChzZWxmLCBwbGFjZWhvbGRlcik7DQogICAgICAgICAgICAgICAgc2VsZi5oYW5kbGVFbXB0eVBsYWNlaG9sZGVycyhwbGFjZWhvbGRlcik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZVBsYWNlaG9sZGVySHRtbEVsZW1lbnQocGxhY2Vob2xkZXIsIHBsaElkLCBmYWxzZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5oYW5kbGVJbWFnZU1vdXNlTW92ZXMgPSBmdW5jdGlvbiAocGxhY2Vob2xkZXIpIHsNCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsNCiAgICAgICAgICAgIHBsYWNlaG9sZGVyLmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZS1pbWFnZSIpLm1vdXNlb3ZlcihmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICB2YXIgJGN1cnJlbnRFbGVtZW50ID0gc2VsZi4kKGV2ZW50LmN1cnJlbnRUYXJnZXQpOw0KICAgICAgICAgICAgICAgIGlmICgkY3VycmVudEVsZW1lbnQuYXR0cigicG9zaXRpb24iKSkgew0KICAgICAgICAgICAgICAgICAgICBzZWxmLiQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZVtrZXk9JyIgKyAkY3VycmVudEVsZW1lbnQuYXR0cigia2V5IikgKyAiJ11bcG9zaXRpb249IiArICRjdXJyZW50RWxlbWVudC5hdHRyKCJwb3NpdGlvbiIpICsgIl0iKS5hZGRDbGFzcygiaG92ZXJlZCIpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgc2VsZi4kKCIuemctZGVsaWdodGZ1bC1kcm9wcGFibGVba2V5PSciICsgJGN1cnJlbnRFbGVtZW50LmF0dHIoImtleSIpICsgIiddIikuYWRkQ2xhc3MoImhvdmVyZWQiKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgJGN1cnJlbnRFbGVtZW50LmFkZENsYXNzKCJob3ZlcmVkLWljb24iKTsNCiAgICAgICAgICAgIH0pLm1vdXNlb3V0KGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgICAgICAgIHZhciAkY3VycmVudEVsZW1lbnQgPSBzZWxmLiQoZXZlbnQuY3VycmVudFRhcmdldCk7DQogICAgICAgICAgICAgICAgaWYgKCRjdXJyZW50RWxlbWVudC5hdHRyKCJwb3NpdGlvbiIpKSB7DQogICAgICAgICAgICAgICAgICAgIHNlbGYuJCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlW2tleT0nIiArICRjdXJyZW50RWxlbWVudC5hdHRyKCJrZXkiKSArICInXVtwb3NpdGlvbj0iICsgJGN1cnJlbnRFbGVtZW50LmF0dHIoInBvc2l0aW9uIikgKyAiXSIpLnJlbW92ZUNsYXNzKCJob3ZlcmVkIik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBzZWxmLiQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZVtrZXk9JyIgKyAkY3VycmVudEVsZW1lbnQuYXR0cigia2V5IikgKyAiJ10iKS5yZW1vdmVDbGFzcygiaG92ZXJlZCIpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAkY3VycmVudEVsZW1lbnQucmVtb3ZlQ2xhc3MoImhvdmVyZWQtaWNvbiIpOw0KICAgICAgICAgICAgICAgICRjdXJyZW50RWxlbWVudC5jaGlsZHJlbigpLnJlbW92ZSgpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5oYW5kbGVFbXB0eVBsYWNlaG9sZGVycyA9IGZ1bmN0aW9uIChwbGFjZWhvbGRlcikgew0KICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOw0KICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLmhhc0NsYXNzKCJzY0VtcHR5UGxhY2Vob2xkZXIiKSkgew0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLm1vdXNlb3ZlcihmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgc2VsZi4kKGV2ZW50LmN1cnJlbnRUYXJnZXQpLmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZSIpLmFkZENsYXNzKCJob3ZlcmVkIikuY3NzKCJ2aXNpYmlsaXR5IiwgInZpc2libGUiKTsNCiAgICAgICAgICAgICAgICB9KS5tb3VzZW91dChmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCFldmVudC5jdXJyZW50VGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygidG9vbGJveC1kcm9wcGluZyIpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLiQoZXZlbnQuY3VycmVudFRhcmdldCkuZmluZCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlIikuY3NzKCJ2aXNpYmlsaXR5IiwgImhpZGRlbiIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5wbGFjZWhvbGRlckRyb3AgPSBmdW5jdGlvbiAocmVuZGVyaW5nLCBwbGhJZCwgdWksIHBsYWNlaG9sZGVyKSB7DQogICAgICAgICAgICBpZiAocmVuZGVyaW5nLmRhdGEoIm1vdmluZyIpICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tb3ZlQ29tcG9uZW50KHBsaElkLCByZW5kZXJpbmcsIHBsYWNlaG9sZGVyKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRyb3BDb21wb25lbnQodWksIHBsYWNlaG9sZGVyKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmNyZWF0ZVBsYWNlaG9sZGVycyA9IGZ1bmN0aW9uICgkb3BlbkNvZGUsIHJlbmRlcmluZywgY29tcG9uZW50UGxhY2Vob2xkZXIsIGNoZWNrLCBpc01vdmluZ0NvbXBvbmVudCwgcGxhY2Vob2xkZXJEYXRhKSB7DQogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICAgICAgdmFyIGtleSA9ICRvcGVuQ29kZS5hdHRyKCJrZXkiKSwgb3BlbmVkID0gZmFsc2UsICRzaWJsaW5nID0gbnVsbCwgaywgcG9zaXRpb24gPSAwLCByZW5kZXJpbmdzLCBhbGxTaWJsaW5ncywgYWxsUmVuZGVyaW5ncywgcG9zaXRpb25DaGFuZ2U7DQogICAgICAgICAgICBpZiAoIXRoaXMuc2hvdWxkQ3JlYXRlUGxhY2Vob2xkZXIocmVuZGVyaW5nLCAkb3BlbkNvZGUpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgYWxsU2libGluZ3MgPSAkb3BlbkNvZGUubmV4dEFsbCgiOm5vdChbY2hyb21ldHlwZT0nZmllbGQnXSkiKTsNCiAgICAgICAgICAgIGFsbFJlbmRlcmluZ3MgPSAkb3BlbkNvZGUuc2libGluZ3MoImRpdi5jb21wb25lbnQsZGl2Lmpzb24tY29tcG9uZW50LXdyYXBwZXIiKTsNCiAgICAgICAgICAgIGlmIChpc01vdmluZ0NvbXBvbmVudCAmJiByZW5kZXJpbmcuZGF0YSgiaXNQbGFjZWhvbGRlck5lc3RlZEluc2lkZUNvbXBvbmVudCIpKGNvbXBvbmVudFBsYWNlaG9sZGVyLCBrZXksIHJlbmRlcmluZykpIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoYWxsUmVuZGVyaW5ncy5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgcmVuZGVyaW5ncyA9IHBsYWNlaG9sZGVyRGF0YS5yZW5kZXJpbmdzOw0KICAgICAgICAgICAgICAgIGlmIChyZW5kZXJpbmdzLmxlbmd0aCA8PSAxICYmIGlzTW92aW5nQ29tcG9uZW50ICYmIGNvbXBvbmVudFBsYWNlaG9sZGVyID09PSBwbGFjZWhvbGRlckRhdGEubmFtZSkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCByZW5kZXJpbmdzLmxlbmd0aDsgaysrKSB7DQogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uQ2hhbmdlID0gY2hlY2socmVuZGVyaW5nLCBrLCBhbGxTaWJsaW5ncyk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRHJvcHBhYmxlR3JpZFBsYWNlaG9sZGVyKHRoaXMuJChyZW5kZXJpbmdzW2tdKSwgdHJ1ZSwgcG9zaXRpb24sIHBsYWNlaG9sZGVyRGF0YS5uYW1lKTsNCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24rKzsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGsgPT09IHJlbmRlcmluZ3MubGVuZ3RoIC0gMSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVEcm9wcGFibGVHcmlkUGxhY2Vob2xkZXIodGhpcy4kKHJlbmRlcmluZ3Nba10pLCBmYWxzZSwgcG9zaXRpb24sIHBsYWNlaG9sZGVyRGF0YS5uYW1lKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBhbGxTaWJsaW5ncy5sZW5ndGg7IGsrKykgew0KICAgICAgICAgICAgICAgICAgICAkc2libGluZyA9IHRoaXMuJChhbGxTaWJsaW5nc1trXSk7DQogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uQ2hhbmdlID0gY2hlY2socmVuZGVyaW5nLCBrLCBhbGxTaWJsaW5ncyk7DQogICAgICAgICAgICAgICAgICAgIGlmIChpc01vdmluZ0NvbXBvbmVudCAmJiBwb3NpdGlvbkNoYW5nZSA+PSAwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSBwb3NpdGlvbkNoYW5nZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGlmICgkc2libGluZy5wcm9wKCJ0YWdOYW1lIikgIT09ICJDT0RFIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wZW5lZCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVEcm9wcGFibGVQbGFjZWhvbGRlcigkc2libGluZywgdHJ1ZSwgcG9zaXRpb24sIGtleSk7DQogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbisrOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRzaWJsaW5nLmF0dHIoImtpbmQiKSA9PT0gIm9wZW4iKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BlbmVkID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZURyb3BwYWJsZVBsYWNlaG9sZGVyKCRzaWJsaW5nLCB0cnVlLCBwb3NpdGlvbiwga2V5KTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbisrOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRzaWJsaW5nLmF0dHIoImtpbmQiKSA9PT0gImNsb3NlIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkc2libGluZy5hdHRyKCJrZXkiKSAhPT0ga2V5KSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5lZCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHZhciBjb25kaXRpb24gPSBhbGxTaWJsaW5ncy5maWx0ZXIoZnVuY3Rpb24gKGlkeCwgZSkgeyByZXR1cm4gKF90aGlzLiQoZSkuYXR0cigia2luZCIpID09PSAib3BlbiIpOyB9KS5sZW5ndGg7DQogICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9uID4gMCAmJiBjb25kaXRpb24gIT09IHBvc2l0aW9uIC0gMSkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZURyb3BwYWJsZVBsYWNlaG9sZGVyKCRzaWJsaW5nLCBmYWxzZSwgcG9zaXRpb24sIGtleSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuY3JlYXRlRHJvcHBhYmxlUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAoJHNpYmxpbmcsIGJlZm9yZSwgcG9zaXRpb24sIHBsYWNlaG9sZGVyS2V5KSB7DQogICAgICAgICAgICB2YXIgJGRpdiA9IHRoaXMuJCgiPGRpdiBjbGFzcz1cInN4YS10b29sYm94LWRpdlwiIHNjLXBsYWNlaG9sZGVyLWlkPVwiIiArIHBsYWNlaG9sZGVyS2V5ICsgIlwiIHBvc2l0aW9uPVwiIiArIHBvc2l0aW9uICsgIlwiID4iICsNCiAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz0nemctZGVsaWdodGZ1bC1kcm9wcGFibGUtaW1hZ2UnIHBvc2l0aW9uPVwiIiArIHBvc2l0aW9uICsgIlwiIGtleT1cIiIgKyBwbGFjZWhvbGRlcktleSArICJcIj48L2Rpdj4iICsNCiAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz1cInpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlXCIgcG9zaXRpb249XCIiICsgcG9zaXRpb24gKyAiXCIga2V5PVwiIiArIHBsYWNlaG9sZGVyS2V5ICsgIlwiPjxkaXYgY2xhc3M9XCJpbm5lclwiPjwvZGl2PjwvZGl2PiIgKw0KICAgICAgICAgICAgICAgICI8L2Rpdj4iKTsNCiAgICAgICAgICAgICRkaXYud2lkdGgoJHNpYmxpbmcucGFyZW50KCkud2lkdGgoKSk7DQogICAgICAgICAgICB0aGlzLmRyb3BQbGFjZWhvbGRlcihiZWZvcmUsICRkaXYsICRzaWJsaW5nKTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmNyZWF0ZURyb3BwYWJsZUdyaWRQbGFjZWhvbGRlciA9IGZ1bmN0aW9uICgkc2libGluZywgYmVmb3JlLCBwb3NpdGlvbiwgcGxhY2Vob2xkZXJLZXkpIHsNCiAgICAgICAgICAgIHZhciAkZGl2ID0gdGhpcy4kKCI8ZGl2IGNsYXNzPVwic3hhLXRvb2xib3gtZGl2XCIgc2MtcGxhY2Vob2xkZXItaWQ9XCIiICsgcGxhY2Vob2xkZXJLZXkgKyAiXCIgcG9zaXRpb249XCIiICsgcG9zaXRpb24gKyAiXCIgPiIgKw0KICAgICAgICAgICAgICAgICI8ZGl2IGNsYXNzPSd6Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZS1pbWFnZScgcG9zaXRpb249XCIiICsgcG9zaXRpb24gKyAiXCIga2V5PVwiIiArIHBsYWNlaG9sZGVyS2V5ICsgIlwiPjwvZGl2PiIgKw0KICAgICAgICAgICAgICAgICI8ZGl2IGNsYXNzPVwiemctZGVsaWdodGZ1bC1kcm9wcGFibGVcIiBwb3NpdGlvbj1cIiIgKyBwb3NpdGlvbiArICJcIiBrZXk9XCIiICsgcGxhY2Vob2xkZXJLZXkgKyAiXCI+PGRpdiBjbGFzcz1cImlubmVyXCI+PC9kaXY+PC9kaXY+IiArDQogICAgICAgICAgICAgICAgIjwvZGl2PiIpLCByZW5kZXJpbmdQb3NpdGlvbiA9ICRzaWJsaW5nLnBvc2l0aW9uKCksIG91dGVySGVpZ2h0ID0gJHNpYmxpbmcub3V0ZXJIZWlnaHQoKTsNCiAgICAgICAgICAgIGlmIChvdXRlckhlaWdodCA8IDIwKSB7DQogICAgICAgICAgICAgICAgb3V0ZXJIZWlnaHQgKz0gODsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRkaXYuY3NzKHsNCiAgICAgICAgICAgICAgICB3aWR0aDogJHNpYmxpbmcub3V0ZXJXaWR0aCgpLA0KICAgICAgICAgICAgICAgICJwb3NpdGlvbiI6ICJhYnNvbHV0ZSIsDQogICAgICAgICAgICAgICAgdG9wOiBiZWZvcmUgPyByZW5kZXJpbmdQb3NpdGlvbi50b3AgOiAocmVuZGVyaW5nUG9zaXRpb24udG9wICsgb3V0ZXJIZWlnaHQpLA0KICAgICAgICAgICAgICAgIGxlZnQ6IHJlbmRlcmluZ1Bvc2l0aW9uLmxlZnQNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgaWYgKCFiZWZvcmUpIHsNCiAgICAgICAgICAgICAgICAkZGl2LmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZS1pbWFnZSIpLmFkZENsYXNzKCJyb3RhdGVkIik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLmRyb3BQbGFjZWhvbGRlcihiZWZvcmUsICRkaXYsICRzaWJsaW5nKTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmRyb3BDb21wb25lbnQgPSBmdW5jdGlvbiAodWksICRwbGgpIHsNCiAgICAgICAgICAgIHZhciAkcGxoLCBwbGhJZCwgY2hyb21lLCBpOw0KICAgICAgICAgICAgaWYgKHRoaXMuaXNUb29sYm94RHJvcCkgew0KICAgICAgICAgICAgICAgIHRoaXMuaXNUb29sYm94RHJvcCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRDaHJvbWUgIT09IG51bGwpIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICAkcGxoLmFkZENsYXNzKCJ0b29sYm94LWRyb3BwaW5nIik7DQogICAgICAgICAgICBwbGhJZCA9ICRwbGguYXR0cigic2MtcGxhY2Vob2xkZXItaWQiKTsNCiAgICAgICAgICAgIGlmICgkcGxoLnByZXZBbGwoImNvZGUiKS5hdHRyKCJpZCIpID09PSBwbGhJZCkgew0KICAgICAgICAgICAgICAgIHBsaElkID0gJHBsaC5wcmV2QWxsKCJjb2RlIikuYXR0cigia2V5Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5jaHJvbWVzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgY2hyb21lID0gdGhpcy5jaHJvbWVzW2ldOw0KICAgICAgICAgICAgICAgIGlmIChjaHJvbWUuX29yaWdpbmFsRE9NRWxlbWVudC5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBjaHJvbWUuX29yaWdpbmFsRE9NRWxlbWVudFswXS5hdHRyaWJ1dGVzWyJrZXkiXTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gdW5kZWZpbmVkICYmIGtleSAhPT0gbnVsbCAmJiBrZXkudmFsdWUgPT09IHBsaElkKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRDaHJvbWUgPSBjaHJvbWU7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHBsaC5hdHRyKCJwb3NpdGlvbiIpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnR5cGUuX2luc2VydFBvc2l0aW9uID0gJHBsaC5hdHRyKCJwb3NpdGlvbiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnR5cGUuX2luc2VydFBvc2l0aW9uID0gMDsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5QYWdlRWRpdG9yLmxheW91dERlZmluaXRpb25Db250cm9sKCkudmFsdWUgPSBTaXRlY29yZS5QYWdlTW9kZXMuUGFnZUVkaXRvci5sYXlvdXQoKS52YWwoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5QYWdlRWRpdG9yLnBvc3RSZXF1ZXN0KCJ3ZWJlZGl0OmFkZHJlbmRlcmluZyhwbGFjZWhvbGRlcj0iICsgcGxoSWQgKyAiLHRvb2xib3hSZW5kZXJpbmc9IiArIHVpLmRyYWdnYWJsZS5kYXRhKCJpZCIpICsgIikiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLm1vdmVDb21wb25lbnQgPSBmdW5jdGlvbiAocGxhY2Vob2xkZXJJZCwgcmVuZGVyaW5nLCBwbGFjZWhvbGRlcikgew0KICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOw0KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICB2YXIgcGxhY2VIbGRyLCBwb3NpdGlvbiwgY29tcG9uZW50LCB0cmVlLCBkZXZpY2VJZCwgc2l0ZWNvcmVDaHJvbWUsIHJlbmRlcmluZ1VpZDsNCiAgICAgICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQgPSByZW5kZXJpbmcuZGF0YSgiY29tcG9uZW50Iik7DQogICAgICAgICAgICAgICAgICAgIHBsYWNlSGxkciA9IHNlbGYuZ2V0UGxhY2Vob2xkZXJGcm9tSWQocGxhY2Vob2xkZXJJZCk7DQogICAgICAgICAgICAgICAgICAgIGlmIChwbGFjZUhsZHIubGVuZ3RoIDwgMSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgIkNhbm5vdCBmaW5kIHBsYWNlaG9sZGVyIjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwbGFjZUhsZHIubGVuZ3RoID4gMSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIldhcm5pbmchIFlvdSBoYXZlIHR3byBwbGFjZWhvbGRlcnMgd2l0aCB0aGUgc2FtZSBwYXRoIG9uIHRoZSBwYWdlISIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gcGxhY2Vob2xkZXIuYXR0cigicG9zaXRpb24iKSB8fCAwOw0KICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbmRlcmluZy5kYXRhKCJpc1Bvc2l0aW9uQ2hhbmdlZCIpKGNvbXBvbmVudCwgcG9zaXRpb24sIHBsYWNlaG9sZGVySWQpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgdHJlZSA9IHJlbmRlcmluZy5kYXRhKCJ0cmVlIik7DQogICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5EZXNpZ25NYW5hZ2VyLm1vdmVDb250cm9sVG8oY29tcG9uZW50LCBwbGFjZUhsZHJbMF0sIHBvc2l0aW9uKTsNCiAgICAgICAgICAgICAgICAgICAgc2VsZi5tb3ZlQ29tcG9uZW50VHJlZShjb21wb25lbnQsIHRyZWUpOw0KICAgICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNb3ZlQWN0aW9ucyhjb21wb25lbnQpOw0KICAgICAgICAgICAgICAgICAgICBkZXZpY2VJZCA9IFNpdGVjb3JlLkxheW91dERlZmluaXRpb24uZ2V0RGV2aWNlSUQoKTsNCiAgICAgICAgICAgICAgICAgICAgc2l0ZWNvcmVDaHJvbWUgPSBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lTWFuYWdlci5zZWxlY3RlZENocm9tZSgpOw0KICAgICAgICAgICAgICAgICAgICByZW5kZXJpbmdVaWQgPSBzaXRlY29yZUNocm9tZS50eXBlLnVuaXF1ZUlkKCk7DQogICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5QYWdlRWRpdG9yLnBvc3RSZXF1ZXN0KCJ3ZWJlZGl0OnVwZGF0ZWxheW91dChkZXZpY2VJZD0iICsgZGV2aWNlSWQgKyAiLHJlbmRlcmluZ1VpZD0iICsgcmVuZGVyaW5nVWlkICsgIikiLCBudWxsLCBmYWxzZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0oKTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLm1vdmVDb21wb25lbnRUcmVlID0gZnVuY3Rpb24gKGNvbXBvbmVudCwgdHJlZSkgew0KICAgICAgICAgICAgdmFyIGMsIGN1cnJlbnQsIG5ld1Jvb3RQbGFjZWhvbGRlciwgbmV3UGxhY2Vob2xkZXIsIG9sZFBsYWNlaG9sZGVyLCBsYXlvdXREZWZpbml0aW9uLCBwcm9jZXNzZWRQbGFjZWhvbGRlcnMgPSB7fTsNCiAgICAgICAgICAgIHRyZWUgPSB0cmVlLmJmczsNCiAgICAgICAgICAgIGlmICh0cmVlLmxlbmd0aCA9PT0gMSkgew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIG9sZFBsYWNlaG9sZGVyID0gdHJlZVswXS5wbGFjZWhvbGRlcjsNCiAgICAgICAgICAgIG5ld1Jvb3RQbGFjZWhvbGRlciA9IHRoaXMuZ2V0UGxhY2Vob2xkZXJGdWxsUGF0aCh0cmVlWzBdLm5vZGUpOw0KICAgICAgICAgICAgbGF5b3V0RGVmaW5pdGlvbiA9IFNpdGVjb3JlLkxheW91dERlZmluaXRpb24uZ2V0TGF5b3V0RGVmaW5pdGlvbigpOw0KICAgICAgICAgICAgZm9yIChjID0gMTsgYyA8IHRyZWUubGVuZ3RoOyBjKyspIHsNCiAgICAgICAgICAgICAgICBjdXJyZW50ID0gdHJlZVtjXTsNCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudC5ub2RlLnR5cGUua2V5KCkgIT09ICJyZW5kZXJpbmciKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBuZXdQbGFjZWhvbGRlciA9IGN1cnJlbnQucGxhY2Vob2xkZXIucmVwbGFjZShvbGRQbGFjZWhvbGRlciwgbmV3Um9vdFBsYWNlaG9sZGVyKTsNCiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxheW91dERlZmluaXRpb24oY3VycmVudC5ub2RlLCBuZXdQbGFjZWhvbGRlciwgbGF5b3V0RGVmaW5pdGlvbik7DQogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVQbGFjZWhvbGRlcih0aGlzLmdldFBsYWNlaG9sZGVyRnVsbFBhdGgoY3VycmVudC5ub2RlKSwgbmV3UGxhY2Vob2xkZXIsIHByb2Nlc3NlZFBsYWNlaG9sZGVycyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBTaXRlY29yZS5MYXlvdXREZWZpbml0aW9uLnNldExheW91dERlZmluaXRpb24obGF5b3V0RGVmaW5pdGlvbik7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5nZXRDb21wb25lbnRUcmVlID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgew0KICAgICAgICAgICAgdmFyIHF1ZXVlID0gW10sIHJvb3QsIGN1cnJlbnQsIGMsIHBoLCBjaGlsZHJlbiwgcGxhY2Vob2xkZXJzQmVsb3dSb290ID0gW10sIG5vZGUsIGJmcyA9IFtdLCBpc0NvbXBvbmVudCA9IGZ1bmN0aW9uIChub2RlKSB7IHJldHVybiAobm9kZS50eXBlLmtleSgpID09PSAicmVuZGVyaW5nIik7IH0sIGlzUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAobm9kZSkgeyByZXR1cm4gKG5vZGUudHlwZS5rZXkoKSA9PT0gInBsYWNlaG9sZGVyIik7IH0sIGdldEZ1bGxQbGFjZWhvbGRlclBhdGggPSBmdW5jdGlvbiAocGFyZW50LCBjdXJyZW50KSB7DQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQudHlwZS5nZXRQbGFjZWhvbGRlciAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnQucGxhY2Vob2xkZXIgKyAiLyIgKyBjdXJyZW50LnR5cGUuZ2V0UGxhY2Vob2xkZXIoKS5kaXNwbGF5TmFtZSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudC5wbGFjZWhvbGRlcjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LCBnZXRQb3NpdGlvbkluUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAoY3VycmVudCkgew0KICAgICAgICAgICAgICAgIGlmIChjdXJyZW50LnR5cGUuZ2V0UGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gU2l0ZWNvcmUuTGF5b3V0RGVmaW5pdGlvbi5nZXRSZW5kZXJpbmdQb3NpdGlvbkluUGxhY2Vob2xkZXIoY3VycmVudC50eXBlLmdldFBsYWNlaG9sZGVyKCkuZGlzcGxheU5hbWUoKSwgY3VycmVudC50eXBlLnVuaXF1ZUlkKCkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm4gLTE7DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgcm9vdCA9IHsgcGFyZW50OiBudWxsLCBub2RlOiBjb21wb25lbnQsIHBsYWNlaG9sZGVyOiBjb21wb25lbnQudHlwZS5nZXRQbGFjZWhvbGRlcigpLm9wZW5pbmdNYXJrZXIoKS5hdHRyKCJrZXkiKSwgcG9zaXRpb246IDAgfTsNCiAgICAgICAgICAgIHF1ZXVlLnB1c2gocm9vdCk7DQogICAgICAgICAgICBiZnMucHVzaChyb290KTsNCiAgICAgICAgICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgY3VycmVudCA9IHF1ZXVlLnNoaWZ0KCk7DQogICAgICAgICAgICAgICAgY3VycmVudC5jaGlsZHJlbiA9IFtdOw0KICAgICAgICAgICAgICAgIGNoaWxkcmVuID0gY3VycmVudC5ub2RlLmdldENoaWxkQ2hyb21lcygpOw0KICAgICAgICAgICAgICAgIGZvciAoYyA9IDA7IGMgPCBjaGlsZHJlbi5sZW5ndGg7IGMrKykgew0KICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5bY10gIT09IGN1cnJlbnQubm9kZSAmJiBpc0NvbXBvbmVudChjaGlsZHJlbltjXSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiBjdXJyZW50LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IGNoaWxkcmVuW2NdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBnZXRGdWxsUGxhY2Vob2xkZXJQYXRoKGN1cnJlbnQsIGNoaWxkcmVuW2NdKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogZ2V0UG9zaXRpb25JblBsYWNlaG9sZGVyKGNoaWxkcmVuW2NdKQ0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2gobm9kZSk7DQogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50LmNoaWxkcmVuLnB1c2gobm9kZSk7DQogICAgICAgICAgICAgICAgICAgICAgICBiZnMucHVzaChub2RlKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc1BsYWNlaG9sZGVyKGNoaWxkcmVuW2NdKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcGggPSAoY3VycmVudC5wbGFjZWhvbGRlcilbMF0gPT09ICIvIiA/IGN1cnJlbnQucGxhY2Vob2xkZXIgOiAiLyIgKyBjdXJyZW50LnBsYWNlaG9sZGVyOw0KICAgICAgICAgICAgICAgICAgICAgICAgcGggKz0gIi8iICsgY2hpbGRyZW5bY10uZGlzcGxheU5hbWUoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyc0JlbG93Um9vdC5wdXNoKHBoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goeyBub2RlOiBjaGlsZHJlbltjXSwgcGxhY2Vob2xkZXI6IGN1cnJlbnQucGxhY2Vob2xkZXIgfSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICByb290LmJmcyA9IGJmczsNCiAgICAgICAgICAgIHJvb3QuZGVzY2VuZGFudFBsYWNlaG9sZGVycyA9IHBsYWNlaG9sZGVyc0JlbG93Um9vdDsNCiAgICAgICAgICAgIHJldHVybiByb290Ow0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUudXBkYXRlUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAob2xkUGxhY2Vob2xkZXIsIG5ld1BsYWNlaG9sZGVyLCBwcm9jZXNzZWRQbGFjZWhvbGRlcnMpIHsNCiAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlcjsNCiAgICAgICAgICAgIGlmICghcHJvY2Vzc2VkUGxhY2Vob2xkZXJzLmhhc093blByb3BlcnR5KG9sZFBsYWNlaG9sZGVyKSkgew0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyID0gdGhpcy4kKHRoaXMuZ2V0UGxhY2Vob2xkZXJGcm9tSWQob2xkUGxhY2Vob2xkZXIpWzBdLm9wZW5pbmdNYXJrZXIoKSk7DQogICAgICAgICAgICAgICAgcGxhY2Vob2xkZXIuYXR0cigia2V5IiwgbmV3UGxhY2Vob2xkZXIpOw0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLmF0dHIoImlkIiwgbmV3UGxhY2Vob2xkZXIucmVwbGFjZSgvXC8vZywgIl8iKS5yZXBsYWNlKC8tL2csICJfIikpOw0KICAgICAgICAgICAgICAgIHByb2Nlc3NlZFBsYWNlaG9sZGVyc1tvbGRQbGFjZWhvbGRlcl0gPSBuZXdQbGFjZWhvbGRlcjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLnVwZGF0ZUxheW91dERlZmluaXRpb24gPSBmdW5jdGlvbiAoY29tcG9uZW50LCBuZXdQbGFjZWhvbGRlciwgbGF5b3V0RGVmaW5pdGlvbikgew0KICAgICAgICAgICAgdmFyIHVpZCA9IGNvbXBvbmVudC50eXBlLnVuaXF1ZUlkKCksIHJlbmRlcmluZzsNCiAgICAgICAgICAgIHJlbmRlcmluZyA9IHRoaXMuJC5ncmVwKGxheW91dERlZmluaXRpb24uci5kWzBdLnIsIGZ1bmN0aW9uIChlbGVtZW50LCBpZHgpIHsgcmV0dXJuIChTaXRlY29yZS5MYXlvdXREZWZpbml0aW9uLmdldFNob3J0SUQoZWxlbWVudFsiQHVpZCJdKSA9PT0gdWlkKTsgfSk7DQogICAgICAgICAgICBpZiAocmVuZGVyaW5nLmxlbmd0aCA9PT0gMSkgew0KICAgICAgICAgICAgICAgIHJlbmRlcmluZyA9IHJlbmRlcmluZ1swXTsNCiAgICAgICAgICAgICAgICByZW5kZXJpbmdbIkBwaCJdID0gbmV3UGxhY2Vob2xkZXI7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5kcm9wUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAoYmVmb3JlLCAkZGl2LCAkc2libGluZykgew0KICAgICAgICAgICAgaWYgKCRkaXYud2lkdGgoKSA9PT0gMCAmJiAkc2libGluZy5wYXJlbnQoKS5pcygic3BhbiIpKSB7DQogICAgICAgICAgICAgICAgJGRpdi53aWR0aCgiMTAwJSIpOw0KICAgICAgICAgICAgICAgICRkaXYuaGVpZ2h0KDIwKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRkaXYuY3NzKCJ2aXNpYmlsaXR5IiwgImhpZGRlbiIpOw0KICAgICAgICAgICAgaWYgKGJlZm9yZSkgew0KICAgICAgICAgICAgICAgICRzaWJsaW5nLmJlZm9yZSgkZGl2KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICRzaWJsaW5nLmFmdGVyKCRkaXYpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy5kcm9wcGFibGVQbGFjZWhvbGRlcnMucHVzaCgkZGl2KTsNCiAgICAgICAgICAgIHRoaXMubW91c2VNYW5hZ2VyLnRyYWNrRHJvcFBsYWNlKCRkaXYuZmluZCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlLWltYWdlIikpOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUubm90aWZ5RHJvcFBsYWNlID0gZnVuY3Rpb24gKGlzVmlzaWJsZSwgcGxhY2Vob2xkZXIpIHsNCiAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlclRleHQsIHBsYWNlaG9sZGVyLCBwb3NpdGlvbiwgb2xkLCAkd3JhcHBlciA9IHRoaXMuJCh0aGlzLnRvb2xib3hQbGFjZWhvbGRlciksIG5vdGlmeUJveCwgbm90aWZ5SWNvbiwgbm90aWZ5VGV4dDsNCiAgICAgICAgICAgIHBsYWNlaG9sZGVyVGV4dCA9IHBsYWNlaG9sZGVyLmF0dHIoImtleSIpOw0KICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLmF0dHIoInBvc2l0aW9uIikpIHsNCiAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHBhcnNlSW50KHBsYWNlaG9sZGVyLmF0dHIoInBvc2l0aW9uIikpICsgMTsNCiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlclRleHQgKz0gIiAoIiArIHBvc2l0aW9uICsgIikiOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgb2xkID0gJHdyYXBwZXIuZmluZCgiLm5vdGlmeS1ib3giKTsNCiAgICAgICAgICAgIG9sZC5yZW1vdmUoKTsNCiAgICAgICAgICAgIG5vdGlmeUJveCA9IHRoaXMuJCgiPGRpdiAvPiIpOw0KICAgICAgICAgICAgbm90aWZ5SWNvbiA9IHRoaXMuJCgiPHNwYW4gLz4iKS5hZGRDbGFzcygibm90aWZ5LWljb24iKTsNCiAgICAgICAgICAgIG5vdGlmeVRleHQgPSB0aGlzLiQoIjxzcGFuIC8+IikuYWRkQ2xhc3MoIm5vdGlmeS10ZXh0Iik7DQogICAgICAgICAgICBub3RpZnlCb3guYWRkQ2xhc3MoIm5vdGlmeS1ib3giKTsNCiAgICAgICAgICAgIGlmICh0aGlzLiQoIi50b3VjaC12ZXJzaW9uIikubGVuZ3RoICE9PSAwKSB7DQogICAgICAgICAgICAgICAgbm90aWZ5Qm94LmFkZENsYXNzKCJ0b3VjaC12ZXJzaW9uIik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoISR3cmFwcGVyLmZpbmQoIi5ub3RpZnktYm94IikubGVuZ3RoKSB7DQogICAgICAgICAgICAgICAgJHdyYXBwZXIucHJlcGVuZChub3RpZnlCb3gpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKCFpc1Zpc2libGUpIHsNCiAgICAgICAgICAgICAgICBub3RpZnlCb3guYWRkQ2xhc3MoInZpc2libGUiKTsNCiAgICAgICAgICAgICAgICBub3RpZnlCb3guYXBwZW5kKG5vdGlmeUljb24pLmFwcGVuZChub3RpZnlUZXh0KTsNCiAgICAgICAgICAgICAgICBub3RpZnlUZXh0LnRleHQocGxhY2Vob2xkZXJUZXh0KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIG5vdGlmeUJveC5yZW1vdmVDbGFzcygidmlzaWJsZSIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy51cGRhdGVOb3RpZnlCb3hQb3NpdGlvbihub3RpZnlCb3gsIHBsYWNlaG9sZGVyKTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLnVwZGF0ZU5vdGlmeUJveFBvc2l0aW9uID0gZnVuY3Rpb24gKG5vdGlmeUJveCwgcGxhY2Vob2xkZXIpIHsNCiAgICAgICAgICAgIHZhciBpbWFnZSA9IHBsYWNlaG9sZGVyLnBhcmVudCgpLmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZS1pbWFnZSIpLCBub3RpZnlCb3hSZWN0LCBwbGFjZWhvbGRlclJlY3QsIGtleTsNCiAgICAgICAgICAgIGlmIChpbWFnZS5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAga2V5ID0gaW1hZ2UuYXR0cigia2V5IikgKyAiIyIgKyBpbWFnZS5hdHRyKCJwb3NpdGlvbiIpOw0KICAgICAgICAgICAgICAgIGlmICh0aGlzLm5vdGlmeVBsYWNlaG9sZGVyc1Bvc2l0aW9ucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7DQogICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyUmVjdCA9IHRoaXMubm90aWZ5UGxhY2Vob2xkZXJzUG9zaXRpb25zW2tleV07DQogICAgICAgICAgICAgICAgICAgIG5vdGlmeUJveFJlY3QgPSB0aGlzLm5vdGlmeUJveFBvc2l0aW9uc1trZXldOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXJSZWN0ID0gaW1hZ2VbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIG5vdGlmeUJveFJlY3QgPSBub3RpZnlCb3hbMF0uZ2V0Q2xpZW50UmVjdHMoKVswXTsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlQbGFjZWhvbGRlcnNQb3NpdGlvbnNba2V5XSA9IHBsYWNlaG9sZGVyUmVjdDsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlCb3hQb3NpdGlvbnNba2V5XSA9IG5vdGlmeUJveFJlY3Q7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIG5vdGlmeUJveC5jc3MoImxlZnQiLCAocGxhY2Vob2xkZXJSZWN0LmxlZnQgLSBub3RpZnlCb3hSZWN0LndpZHRoIC8gMikgKyAicHgiKTsNCiAgICAgICAgICAgICAgICBub3RpZnlCb3guY3NzKCJ0b3AiLCAocGxhY2Vob2xkZXJSZWN0LnRvcCAtIG5vdGlmeUJveC5oZWlnaHQoKSAqIDMpICsgInB4Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlclJlY3QgPSBwbGFjZWhvbGRlclswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsNCiAgICAgICAgICAgICAgICBub3RpZnlCb3guY3NzKCJsZWZ0IiwgcGxhY2Vob2xkZXJSZWN0LmxlZnQgLSAxMCArICJweCIpOw0KICAgICAgICAgICAgICAgIG5vdGlmeUJveC5jc3MoInRvcCIsIHBsYWNlaG9sZGVyUmVjdC50b3AgLSAxMCArICJweCIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuc2hvdWxkQ3JlYXRlUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAocmVuZGVyaW5nLCAkb3BlbkNvZGUpIHsNCiAgICAgICAgICAgIHZhciBrZXkgPSAkb3BlbkNvZGUuYXR0cigia2V5IiksIGNocm9tZUtleSwgY2hyb21lLCBpOw0KICAgICAgICAgICAgaWYgKCRvcGVuQ29kZS5zaWJsaW5ncygiLnNjRW1wdHlQbGFjZWhvbGRlcltzYy1wbGFjZWhvbGRlci1pZD1cIiIgKyAkb3BlbkNvZGUuYXR0cigiaWQiKSArICJcIl0iKS5sZW5ndGggIT09IDApIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAodGhpcy4kLmluQXJyYXkocmVuZGVyaW5nLmRhdGEoImlkIiksIHRoaXMucGxhY2Vob2xkZXJzW2tleV0pID09PSAtMSkgew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmNocm9tZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBjaHJvbWUgPSB0aGlzLmNocm9tZXNbaV07DQogICAgICAgICAgICAgICAgaWYgKGNocm9tZS5fb3JpZ2luYWxET01FbGVtZW50Lmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAgICAgICAgICAgY2hyb21lS2V5ID0gY2hyb21lLl9vcmlnaW5hbERPTUVsZW1lbnRbMF0uYXR0cmlidXRlc1sia2V5Il07DQogICAgICAgICAgICAgICAgICAgIGlmIChjaHJvbWVLZXkgIT09IHVuZGVmaW5lZCAmJiBjaHJvbWVLZXkgIT09IG51bGwgJiYgY2hyb21lS2V5LnZhbHVlID09PSBrZXkgJiYgY2hyb21lLmRhdGEgIT09IHVuZGVmaW5lZCAmJiBjaHJvbWUuZGF0YS5jdXN0b20gIT09IHVuZGVmaW5lZCAmJiBjaHJvbWUuZGF0YS5jdXN0b20uZWRpdGFibGUgPT09ICJmYWxzZSIpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuZ2V0UGxhY2Vob2xkZXJzUmVuZGVyaW5ncyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgICAgICByZXR1cm4gU2l0ZWNvcmUuUGFnZU1vZGVzLkRlc2lnbk1hbmFnZXIucGxhY2Vob2xkZXJzKCkubWFwKGZ1bmN0aW9uIChwaCkgew0KICAgICAgICAgICAgICAgIHZhciByZW5kZXJpbmdzID0gW10sIGk7DQogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBoLmVsZW1lbnQubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLiQocGguZWxlbWVudFtpXSkuaXMoIi5jb21wb25lbnQsLmpzb24tY29tcG9uZW50LXdyYXBwZXIiKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyaW5ncy5wdXNoKHBoLmVsZW1lbnRbaV0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgICAgIG5hbWU6IHBoLnR5cGUucGxhY2Vob2xkZXJLZXkoKSwNCiAgICAgICAgICAgICAgICAgICAgcmVuZGVyaW5nczogcmVuZGVyaW5ncw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLnBvc3RNb3ZlQWN0aW9ucyA9IGZ1bmN0aW9uIChjb21wb25lbnQpIHsNCiAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudElEID0gY29tcG9uZW50Lm9wZW5pbmdNYXJrZXIoKS5hdHRyKCJpZCIpOw0KICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5QYWdlRWRpdG9yLmxheW91dERlZmluaXRpb25Db250cm9sKCkudmFsdWUgPSBTaXRlY29yZS5QYWdlTW9kZXMuUGFnZUVkaXRvci5sYXlvdXQoKS52YWwoKTsNCiAgICAgICAgICAgICAgICBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lTWFuYWdlci5oYW5kbGVNZXNzYWdlKCJjaHJvbWU6cmVuZGVyaW5nOnByb3BlcnRpZXNjb21wbGV0ZWQiLCB7IGNvbnRyb2xJZDogY29tcG9uZW50SUQgfSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoZSkgew0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuZ2V0UGxhY2Vob2xkZXJGdWxsUGF0aCA9IGZ1bmN0aW9uIChjb21wb25lbnQpIHsNCiAgICAgICAgICAgIHZhciBwaCA9IFNpdGVjb3JlLkxheW91dERlZmluaXRpb24uZ2V0UmVuZGVyaW5nKGNvbXBvbmVudC50eXBlLnVuaXF1ZUlkKCkpWyJAcGgiXTsNCiAgICAgICAgICAgIGlmIChwaC5pbmRleE9mKCIvIikgPT09IDApIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gcGg7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gIi8iICsgcGg7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5nZXRQbGFjZWhvbGRlckZyb21JZCA9IGZ1bmN0aW9uIChwaElkKSB7DQogICAgICAgICAgICByZXR1cm4gU2l0ZWNvcmUuUGFnZU1vZGVzLkRlc2lnbk1hbmFnZXIucGxhY2Vob2xkZXJzKCkuZmlsdGVyKGZ1bmN0aW9uIChwKSB7IHJldHVybiAocC5vcGVuaW5nTWFya2VyKClbMF0uaWQgPT09IHBoSWQucmVwbGFjZSgvXC8vZywgIl8iKS5yZXBsYWNlKC8tL2csICJfIikpOyB9KTsNCiAgICAgICAgfTsNCiAgICAgICAgcmV0dXJuIFN4YU1vdmVyOw0KICAgIH0oKSk7DQogICAgU1hBLlN4YU1vdmVyID0gU3hhTW92ZXI7DQogICAgdmFyIE1vdXNlTWFuYWdlciA9IChmdW5jdGlvbiAoKSB7DQogICAgICAgIGZ1bmN0aW9uIE1vdXNlTWFuYWdlcigpIHsNCiAgICAgICAgICAgIHRoaXMuZHJvcFBsYWNlcyA9IFtdOw0KICAgICAgICAgICAgdGhpcy5kcm9wUGxhY2VzUG9zaXRpb25zID0ge307DQogICAgICAgICAgICB0aGlzLnRvbGxlcmFuY2VYID0gMTA7DQogICAgICAgICAgICB0aGlzLnRvbGxlcmFuY2VZID0gNTA7DQogICAgICAgICAgICB0aGlzLnJlZnJlc2hUaW1lID0gNTsNCiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZTsNCiAgICAgICAgICAgIHRoaXMucHJvY2Vzc2VkUGxhY2Vob2xkZXJJY29ucyA9IFtdOw0KICAgICAgICAgICAgdGhpcy51c2VMaW5lUHJveGltaXR5ID0gdHJ1ZTsNCiAgICAgICAgICAgIHRoaXMuJCA9IGpRdWVyeTsNCiAgICAgICAgICAgIHRoaXMuaW5pdCgpOw0KICAgICAgICB9DQogICAgICAgIE1vdXNlTWFuYWdlci5wcm90b3R5cGUudHJhY2tEcm9wUGxhY2UgPSBmdW5jdGlvbiAoZHJvcFBsYWNlKSB7DQogICAgICAgICAgICB2YXIga2V5ID0gZHJvcFBsYWNlLmF0dHIoImtleSIpICsgIiMiICsgZHJvcFBsYWNlLmF0dHIoInBvc2l0aW9uIiksIHNjcm9sbFRvcCA9IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AsIHJlY3QsIHRoYXQgPSB0aGlzOw0KICAgICAgICAgICAgaWYgKHRoaXMudXNlTGluZVByb3hpbWl0eSkgew0KICAgICAgICAgICAgICAgIGRyb3BQbGFjZSA9IGRyb3BQbGFjZS5uZXh0KCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICB0aGlzLnRvbGxlcmFuY2VYID0gMTAwOw0KICAgICAgICAgICAgICAgIHRoaXMudG9sbGVyYW5jZVkgPSAxMDA7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLmluaXQoKTsNCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIGlmICh0aGF0LmRyb3BQbGFjZXNQb3NpdGlvbnMuaGFzT3duUHJvcGVydHkoa2V5KSkgew0KICAgICAgICAgICAgICAgICAgICByZWN0ID0gdGhhdC5kcm9wUGxhY2VzUG9zaXRpb25zW2tleV07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICByZWN0ID0gZHJvcFBsYWNlWzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOw0KICAgICAgICAgICAgICAgICAgICB0aGF0LmRyb3BQbGFjZXNQb3NpdGlvbnNba2V5XSA9IHJlY3Q7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHRoYXQuZHJvcFBsYWNlcy5wdXNoKHsNCiAgICAgICAgICAgICAgICAgICAgImRyb3BQbGFjZSI6IGRyb3BQbGFjZSwNCiAgICAgICAgICAgICAgICAgICAgInRvcCI6IHJlY3QudG9wICsgc2Nyb2xsVG9wIC0gdGhhdC50b2xsZXJhbmNlWSwNCiAgICAgICAgICAgICAgICAgICAgImJvdHRvbSI6IHJlY3QuYm90dG9tICsgc2Nyb2xsVG9wICsgdGhhdC50b2xsZXJhbmNlWSwNCiAgICAgICAgICAgICAgICAgICAgImxlZnQiOiByZWN0LmxlZnQgLSB0aGF0LnRvbGxlcmFuY2VYLA0KICAgICAgICAgICAgICAgICAgICAicmlnaHQiOiByZWN0LnJpZ2h0ICsgdGhhdC50b2xsZXJhbmNlWA0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSwgMCk7DQogICAgICAgIH07DQogICAgICAgIE1vdXNlTWFuYWdlci5wcm90b3R5cGUuc3RvcFRyYWNraW5nID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdGhpcy5kcm9wUGxhY2VzID0gW107DQogICAgICAgICAgICB0aGlzLiQoZG9jdW1lbnQpLnVuYmluZCgibW91c2Vtb3ZlIik7DQogICAgICAgICAgICB0aGlzLmluaXRpYWxpemVkID0gZmFsc2U7DQogICAgICAgICAgICB0aGlzLnByb2Nlc3NlZFBsYWNlaG9sZGVySWNvbnMgPSBbXTsNCiAgICAgICAgICAgIHRoaXMuZHJvcFBsYWNlc1Bvc2l0aW9ucyA9IHt9Ow0KICAgICAgICB9Ow0KICAgICAgICBNb3VzZU1hbmFnZXIucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICAgICAgaWYgKCF0aGlzLmluaXRpYWxpemVkKSB7DQogICAgICAgICAgICAgICAgdGhpcy4kKGRvY3VtZW50KS5tb3VzZW1vdmUoZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy50aW1lcikgew0KICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KF90aGlzLnRpbWVyKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBfdGhpcy50aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMudHJhY2tNb3VzZVBvc2l0aW9uKGV2ZW50KTsNCiAgICAgICAgICAgICAgICAgICAgfSwgX3RoaXMucmVmcmVzaFRpbWUpOw0KICAgICAgICAgICAgICAgICAgICBfdGhpcy5pbml0aWFsaXplZCA9IHRydWU7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgdGhpcy4kKHdpbmRvdykucmVzaXplKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgX3RoaXMuZHJvcFBsYWNlc1Bvc2l0aW9ucyA9IHt9Ow0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBNb3VzZU1hbmFnZXIucHJvdG90eXBlLnRyYWNrTW91c2VQb3NpdGlvbiA9IGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgICAgdmFyIGRyb3BQbGFjZURhdGEsIHNob3dFbGVtZW50cyA9IFtdLCBuZXh0VG9Ecm9wUGxhY2UsIGxlbmd0aCA9IHRoaXMuZHJvcFBsYWNlcy5sZW5ndGgsIGk7DQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBkcm9wUGxhY2VEYXRhID0gdGhpcy5kcm9wUGxhY2VzW2ldOw0KICAgICAgICAgICAgICAgIG5leHRUb0Ryb3BQbGFjZSA9IHRoaXMudXNlTGluZVByb3hpbWl0eSA/IGRyb3BQbGFjZURhdGEuZHJvcFBsYWNlLnByZXYoKSA6IGRyb3BQbGFjZURhdGEuZHJvcFBsYWNlLm5leHQoKTsNCiAgICAgICAgICAgICAgICBpZiAoZXZlbnQucGFnZVkgPCBkcm9wUGxhY2VEYXRhLmJvdHRvbSAmJiBldmVudC5wYWdlWSA+IGRyb3BQbGFjZURhdGEudG9wICYmIGV2ZW50LnBhZ2VYID4gZHJvcFBsYWNlRGF0YS5sZWZ0ICYmIGV2ZW50LnBhZ2VYIDwgZHJvcFBsYWNlRGF0YS5yaWdodCkgew0KICAgICAgICAgICAgICAgICAgICBkcm9wUGxhY2VEYXRhLmRyb3BQbGFjZS5jc3MoInZpc2liaWxpdHkiLCAidmlzaWJsZSIpOw0KICAgICAgICAgICAgICAgICAgICBuZXh0VG9Ecm9wUGxhY2UuY3NzKCJ2aXNpYmlsaXR5IiwgInZpc2libGUiKTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudXNlTGluZVByb3hpbWl0eSAmJiBuZXh0VG9Ecm9wUGxhY2UubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0VsZW1lbnRzLnB1c2gobmV4dFRvRHJvcFBsYWNlKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dFbGVtZW50cy5wdXNoKGRyb3BQbGFjZURhdGEuZHJvcFBsYWNlKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIGlmIChkcm9wUGxhY2VEYXRhLmRyb3BQbGFjZS5jc3MoInZpc2liaWxpdHkiKSA9PT0gInZpc2libGUiKSB7DQogICAgICAgICAgICAgICAgICAgIGRyb3BQbGFjZURhdGEuZHJvcFBsYWNlLmNzcygidmlzaWJpbGl0eSIsICJoaWRkZW4iKTsNCiAgICAgICAgICAgICAgICAgICAgbmV4dFRvRHJvcFBsYWNlLmNzcygidmlzaWJpbGl0eSIsICJoaWRkZW4iKTsNCiAgICAgICAgICAgICAgICAgICAgc2hvd0VsZW1lbnRzID0gc2hvd0VsZW1lbnRzLmZpbHRlcihmdW5jdGlvbiAoZHJvcFBsYWNlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZHJvcFBsYWNlLmF0dHIoImtleSIpID09PSAodGhpcy51c2VMaW5lUHJveGltaXR5ID8gZHJvcFBsYWNlRGF0YS5kcm9wUGxhY2UucHJldigpLmF0dHIoImtleSIpIDogZHJvcFBsYWNlRGF0YS5kcm9wUGxhY2UuYXR0cigia2V5IikpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLm1vdmVEcm9wUGxhY2VzKHNob3dFbGVtZW50cyk7DQogICAgICAgIH07DQogICAgICAgIE1vdXNlTWFuYWdlci5wcm90b3R5cGUuY29sbGlkZSA9IGZ1bmN0aW9uIChncm91cEVsZW1lbnRzLCBlbGVtZW50KSB7DQogICAgICAgICAgICB2YXIgaSwgZWxlbWVudFRvQ2hlY2s7DQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZ3JvdXBFbGVtZW50cy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgIGVsZW1lbnRUb0NoZWNrID0gZ3JvdXBFbGVtZW50c1tpXTsNCiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFRvQ2hlY2suaGFzQ2xhc3MoInBvc2l0aW9uLXVwZGF0ZWQiKSB8fCAoZWxlbWVudFRvQ2hlY2suYXR0cigia2V5IikgPT09IGVsZW1lbnQuYXR0cigia2V5IikgJiYgZWxlbWVudFRvQ2hlY2suYXR0cigicG9zaXRpb24iKSA9PT0gZWxlbWVudC5hdHRyKCJwb3NpdGlvbiIpKSkgew0KICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYgKHRoaXMueUluc3RlcnNlY3Rpb24oZWxlbWVudFRvQ2hlY2ssIGVsZW1lbnQpICYmIHRoaXMueEluc3RlcnNlY3Rpb24oZWxlbWVudFRvQ2hlY2ssIGVsZW1lbnQpKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfTsNCiAgICAgICAgTW91c2VNYW5hZ2VyLnByb3RvdHlwZS5maW5kU21hbGxlc3RZID0gZnVuY3Rpb24gKGRpdjAsIGRpdjEpIHsNCiAgICAgICAgICAgIHJldHVybiAoZGl2MC5vZmZzZXQoKS50b3AgPCBkaXYxLm9mZnNldCgpLnRvcCkgPyBkaXYwIDogZGl2MTsNCiAgICAgICAgfTsNCiAgICAgICAgTW91c2VNYW5hZ2VyLnByb3RvdHlwZS55SW5zdGVyc2VjdGlvbiA9IGZ1bmN0aW9uIChkaXYwLCBkaXYxKSB7DQogICAgICAgICAgICB2YXIgZGl2WTAgPSB0aGlzLmZpbmRTbWFsbGVzdFkoZGl2MCwgZGl2MSksIGRpdlkxID0gKGRpdjAgIT09IGRpdlkwKSA/IGRpdjAgOiBkaXYxOw0KICAgICAgICAgICAgcmV0dXJuIChkaXZZMC5vZmZzZXQoKS50b3AgKyBkaXZZMC5oZWlnaHQoKSkgLSBkaXZZMS5vZmZzZXQoKS50b3AgPiAwOw0KICAgICAgICB9Ow0KICAgICAgICBNb3VzZU1hbmFnZXIucHJvdG90eXBlLmZpbmRTbWFsbGVzdFggPSBmdW5jdGlvbiAoZGl2MCwgZGl2MSkgew0KICAgICAgICAgICAgcmV0dXJuIChkaXYwLm9mZnNldCgpLmxlZnQgPCBkaXYxLm9mZnNldCgpLmxlZnQpID8gZGl2MCA6IGRpdjE7DQogICAgICAgIH07DQogICAgICAgIE1vdXNlTWFuYWdlci5wcm90b3R5cGUueEluc3RlcnNlY3Rpb24gPSBmdW5jdGlvbiAoZGl2MCwgZGl2MSkgew0KICAgICAgICAgICAgdmFyIGRpdlgwID0gdGhpcy5maW5kU21hbGxlc3RYKGRpdjAsIGRpdjEpLCBkaXZYMSA9IChkaXYwICE9PSBkaXZYMCkgPyBkaXYwIDogZGl2MTsNCiAgICAgICAgICAgIHJldHVybiAoZGl2WDAub2Zmc2V0KCkubGVmdCArIGRpdlgwLndpZHRoKCkpIC0gZGl2WDEub2Zmc2V0KCkubGVmdCA+IDA7DQogICAgICAgIH07DQogICAgICAgIE1vdXNlTWFuYWdlci5wcm90b3R5cGUubW92ZURyb3BQbGFjZXMgPSBmdW5jdGlvbiAoc2hvd0VsZW1lbnRzKSB7DQogICAgICAgICAgICB2YXIgaSwga2V5LCBwbGFjZWhvbGRlcktleSwgZ3JvdXBzID0ge30sIGdyb3VwRWxlbWVudHMsIGdyb3VwRWxlbWVudCwgcG9zaXRpb24sIHBvc2l0aW9ucywgc2hvd0VsZW1lbnQ7DQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2hvd0VsZW1lbnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgc2hvd0VsZW1lbnQgPSBzaG93RWxlbWVudHNbaV07DQogICAgICAgICAgICAgICAga2V5ID0gdGhpcy5ub3JtYWxpemVLZXkoc2hvd0VsZW1lbnQuYXR0cigia2V5IikpOw0KICAgICAgICAgICAgICAgIGlmIChncm91cHMuaGFzT3duUHJvcGVydHkoa2V5KSkgew0KICAgICAgICAgICAgICAgICAgICBncm91cHNba2V5XS5wdXNoKHNob3dFbGVtZW50KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGdyb3Vwc1trZXldID0gW3Nob3dFbGVtZW50XTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoc2hvd0VsZW1lbnRzLmxlbmd0aCA+IDEpIHsNCiAgICAgICAgICAgICAgICBmb3IgKHBsYWNlaG9sZGVyS2V5IGluIGdyb3Vwcykgew0KICAgICAgICAgICAgICAgICAgICBpZiAoZ3JvdXBzLmhhc093blByb3BlcnR5KHBsYWNlaG9sZGVyS2V5KSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBFbGVtZW50cyA9IGdyb3Vwc1twbGFjZWhvbGRlcktleV07DQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9ucyA9IFtdOw0KICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IGdyb3VwRWxlbWVudHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEVsZW1lbnQgPSBncm91cEVsZW1lbnRzW2ldOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZ3JvdXBFbGVtZW50Lmhhc0NsYXNzKCJwb3NpdGlvbi11cGRhdGVkIikgJiYgdGhpcy5jb2xsaWRlKGdyb3VwRWxlbWVudHMsIGdyb3VwRWxlbWVudCkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHBhcnNlSW50KGdyb3VwRWxlbWVudHNbMF0uY3NzKCJsZWZ0IikpIC0gMzU7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvc2l0aW9ucy5pbmRleE9mKHRoaXMucG9zaXRpb24pICE9PSAtMSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHRoaXMucG9zaXRpb25zW3RoaXMucG9zaXRpb25zLmxlbmd0aCAtIDFdIC0gMzU7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBFbGVtZW50LmNzcygibGVmdCIsIHRoaXMucG9zaXRpb24pOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEVsZW1lbnQuYWRkQ2xhc3MoInBvc2l0aW9uLXVwZGF0ZWQiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnMucHVzaCh0aGlzLnBvc2l0aW9uKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIE1vdXNlTWFuYWdlci5wcm90b3R5cGUubm9ybWFsaXplS2V5ID0gZnVuY3Rpb24gKGtleSkgew0KICAgICAgICAgICAgaWYgKGtleS5pbmRleE9mKCIvIikgPT09IDApIHsNCiAgICAgICAgICAgICAgICBrZXkgPSBrZXkuc3Vic3RyKDEsIGtleS5sZW5ndGgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKGtleS5pbmRleE9mKCIvIikgIT09IC0xKSB7DQogICAgICAgICAgICAgICAga2V5ID0ga2V5LnN1YnN0cigwLCBrZXkuaW5kZXhPZigiLyIpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiBrZXk7DQogICAgICAgIH07DQogICAgICAgIHJldHVybiBNb3VzZU1hbmFnZXI7DQogICAgfSgpKTsNCn0pKFNYQSB8fCAoU1hBID0ge30pKTsNCihmdW5jdGlvbiAoU1hBKSB7DQogICAgdmFyIEZlYXR1cmU7DQogICAgKGZ1bmN0aW9uIChGZWF0dXJlKSB7DQogICAgICAgIHZhciBDb21wb3NpdGVzOw0KICAgICAgICAoZnVuY3Rpb24gKENvbXBvc2l0ZXMpIHsNCiAgICAgICAgICAgIHZhciBDb21wb3NpdGVQbGFjZWhvbGRlclZhbGlkYXRvciA9IChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgZnVuY3Rpb24gQ29tcG9zaXRlUGxhY2Vob2xkZXJWYWxpZGF0b3IoKSB7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIENvbXBvc2l0ZVBsYWNlaG9sZGVyVmFsaWRhdG9yLnByb3RvdHlwZS5HZXRDb21wb3NpdGVJZCA9IGZ1bmN0aW9uIChwbGFjZWhvbGRlcikgew0KICAgICAgICAgICAgICAgICAgICB2YXIgc2VjdGlvbiA9IG5ldyBQbGFjZWhvbGRlcihwbGFjZWhvbGRlcikuR2V0Q29tcG9zaXRlU2VjdGlvblBsYWNlaG9sZGVyKCk7DQogICAgICAgICAgICAgICAgICAgIGlmIChzZWN0aW9uICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wID0gc2VjdGlvbi5tYXRjaCgvKHNlY3Rpb24tW1x3XSstKVxkKy1cZCsvZyk7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWRlbnRpZmllcnMgPSB0ZW1wWzBdLnJlcGxhY2UoL3NlY3Rpb24tW1x3XSstL2csICIiKS5zcGxpdCgnLScpOw0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRzSXRlbUluZGV4ID0gaWRlbnRpZmllcnNbMF07DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZHluYW1pY1BoSUQgPSBpZGVudGlmaWVyc1sxXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21wb3NpdGVQbGFjZWhvbGRlck5hbWUgPSBuZXcgUGxhY2Vob2xkZXIocGxhY2Vob2xkZXIpLkdldENvbXBvc2l0ZVBsYWNlaG9sZGVyTmFtZSgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBvc2l0ZVBsYWNlaG9sZGVyTmFtZSArICItIiArIGRzSXRlbUluZGV4ICsgZHluYW1pY1BoSUQ7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIiOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgQ29tcG9zaXRlUGxhY2Vob2xkZXJWYWxpZGF0b3IucHJvdG90eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24gKHBoWCwgcGhZKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBwYWdlRWRpdG9yID0gU2l0ZWNvcmUuUGFnZU1vZGVzLlBhZ2VFZGl0b3I7DQogICAgICAgICAgICAgICAgICAgIGlmIChwYWdlRWRpdG9yID09IG51bGwgfHwgcGFnZUVkaXRvci5vblBhZ2VFZGl0aW5nT2ZDb21wb3NpdGVzID09IG51bGwpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5HZXRDb21wb3NpdGVJZChwaFgpID09IHRoaXMuR2V0Q29tcG9zaXRlSWQocGhZKSk7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICByZXR1cm4gQ29tcG9zaXRlUGxhY2Vob2xkZXJWYWxpZGF0b3I7DQogICAgICAgICAgICB9KCkpOw0KICAgICAgICAgICAgQ29tcG9zaXRlcy5Db21wb3NpdGVQbGFjZWhvbGRlclZhbGlkYXRvciA9IENvbXBvc2l0ZVBsYWNlaG9sZGVyVmFsaWRhdG9yOw0KICAgICAgICAgICAgdmFyIFBsYWNlaG9sZGVyID0gKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBQbGFjZWhvbGRlcihwbGFjZWhvbGRlcikgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLlBhcnRzID0gcGxhY2Vob2xkZXIuc3BsaXQoJy8nKTsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5QYXJ0cyA9IHRoaXMuUGFydHMuZmlsdGVyKGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ICE9PSAnJzsgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIFBsYWNlaG9sZGVyLnByb3RvdHlwZS5HZXRMYXN0UGxhY2Vob2xkZXJOYW1lID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5QYXJ0cy5zbGljZSgtMSlbMF07DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBQbGFjZWhvbGRlci5wcm90b3R5cGUuR2V0UGFyZW50UGxhY2Vob2xkZXJOYW1lID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoKHRoaXMuUGFydHMubGVuZ3RoID4gMSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLlBhcnRzWyh0aGlzLlBhcnRzLmxlbmd0aCAtIDIpXTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5QYXJ0c1swXTsNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIFBsYWNlaG9sZGVyLnByb3RvdHlwZS5HZXRQYXJlbnRQbGFjZWhvbGRlclBhdGggPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgIGlmICgodGhpcy5QYXJ0cy5sZW5ndGggPiAxKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gdGhpcy5QYXJ0cy5zbGljZSgwLCAodGhpcy5QYXJ0cy5sZW5ndGggLSAxKSk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHBhcnRzLmxlbmd0aCA9PSAxKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIi8iICsgcGFydHMuam9pbigiLyIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLlBhcnRzWzBdOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgUGxhY2Vob2xkZXIucHJvdG90eXBlLkdldFBsYWNlaG9sZGVyUGF0aCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCh0aGlzLlBhcnRzICE9IG51bGwpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRoaXMuUGFydHMubGVuZ3RoID09IDEpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuUGFydHNbMF07DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIi8iICsgdGhpcy5QYXJ0cy5qb2luKCIvIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIiOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgUGxhY2Vob2xkZXIucHJvdG90eXBlLkdldENvbXBvc2l0ZVNlY3Rpb25QbGFjZWhvbGRlck5hbWUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0luU2hhcGVUeXBlOw0KICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLlBhcnRzLmxlbmd0aCAtIDE7DQogICAgICAgICAgICAgICAgICAgIGZvciAoOyBpbmRleCA+PSAwOyBpbmRleC0tKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5QYXJ0c1tpbmRleF0ubWF0Y2goL3NlY3Rpb24tW3RpdGxlfGNvbnRlbnRdKy1cZCstXGQrL2cpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNJblNoYXBlVHlwZSA9IHRoaXMuUGFydHNbaW5kZXhdOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcmV2aW91c0luU2hhcGVUeXBlOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgUGxhY2Vob2xkZXIucHJvdG90eXBlLkdldENvbXBvc2l0ZVNlY3Rpb25QbGFjZWhvbGRlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXAgPSBuZXcgUGxhY2Vob2xkZXIoIiIpOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLlBhcnRzLmZvckVhY2goZnVuY3Rpb24gKGUpIHsgdGVtcC5QYXJ0cy5wdXNoKGUpOyB9KTsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHNlY3Rpb24gPSB0ZW1wLkdldENvbXBvc2l0ZVNlY3Rpb25QbGFjZWhvbGRlck5hbWUoKTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKChzZWN0aW9uICE9IG51bGwpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSB0ZW1wLlBhcnRzLmxhc3RJbmRleE9mKHNlY3Rpb24pOw0KICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IChpIDwgaW5kZXgpOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wLlBhcnRzLnNoaWZ0KCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVtcC5HZXRQbGFjZWhvbGRlclBhdGgoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIFBsYWNlaG9sZGVyLnByb3RvdHlwZS5HZXRDb21wb3NpdGVQbGFjZWhvbGRlck5hbWUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBuZWFyZXN0Q29tcG9zaXRlU2VjdGlvblBsYWNlaG9sZGVyID0gdGhpcy5HZXRDb21wb3NpdGVTZWN0aW9uUGxhY2Vob2xkZXJOYW1lKCk7DQogICAgICAgICAgICAgICAgICAgIHZhciBzZWN0aW9uSW5kZXggPSB0aGlzLlBhcnRzLmxhc3RJbmRleE9mKG5lYXJlc3RDb21wb3NpdGVTZWN0aW9uUGxhY2Vob2xkZXIpOw0KICAgICAgICAgICAgICAgICAgICBpZiAoKHNlY3Rpb25JbmRleCA+PSAxKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuUGFydHNbKHNlY3Rpb25JbmRleCAtIDEpXTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIHJldHVybiBQbGFjZWhvbGRlcjsNCiAgICAgICAgICAgIH0oKSk7DQogICAgICAgICAgICBDb21wb3NpdGVzLlBsYWNlaG9sZGVyID0gUGxhY2Vob2xkZXI7DQogICAgICAgIH0pKENvbXBvc2l0ZXMgPSBGZWF0dXJlLkNvbXBvc2l0ZXMgfHwgKEZlYXR1cmUuQ29tcG9zaXRlcyA9IHt9KSk7DQogICAgfSkoRmVhdHVyZSA9IFNYQS5GZWF0dXJlIHx8IChTWEEuRmVhdHVyZSA9IHt9KSk7DQp9KShTWEEgfHwgKFNYQSA9IHt9KSk7DQo=
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 55475
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "ba3f86a2-4a1c-4d78-b63d-91c2779c1b5e"
  Hint: __Sortorder
  Value: 0
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20160509T085812Z
    - ID: "8cdc337e-a112-42fb-bbb4-4143751e123f"
      Hint: __Revision
      Value: "98dcab6e-f438-465e-af7e-f063b5e409bb"
