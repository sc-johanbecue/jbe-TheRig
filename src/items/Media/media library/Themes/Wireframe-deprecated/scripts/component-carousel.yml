---
ID: "8889ffb2-7f7b-4546-b3cc-6474172896d1"
Parent: "4039864c-e58d-4831-a7ab-33ffa08c5687"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: "/sitecore/media library/Themes/Wireframe-deprecated/scripts/component-carousel"
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/8889FFB27F7B4546B3CC6474172896D1.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  BlobID: "8889ffb2-7f7b-4546-b3cc-6474172896d1"
  Value: LyoqCiAqIFhBQ29udGV4dAogKgogKiBYQS5jb21wb25lbnQuY2Fyb3VzZWxzIG1vZHVsZS4KICoKICogRXhwb3NlcyByZWdpc3RlcihzZWxlY3Rvciwgb3B0aW9ucykgbWV0aG9kLCB3aGljaCBpbml0aWFsaXplcyBDYXJvdXNlbAogKiBmb3IgZWFjaCBlbGVtZW50cyB0aGF0IG1hdGNoIHRoZSBwcm92aWRlZCBzZWxlY3Rvciwgd2l0aCBnaXZlbiBvcHRpb25zLgogKiBFbGVtZW50IHVzZWQgYXMgYSBjYXJvdXNlbCBtdXN0IGNvbnRhaW4gYSA8dWwgY2xhc3M9InNsaWRlcyI+IHRhZy4KICogVGhhdCB0YWcgaGF2ZSB0byBiZSBmaWxsZWQgd2l0aCA8bGk+IGVsZW1lbnRzLiBFYWNoIDxsaT4gZWxlbWVudCB3aWxsIGJlIGNvbnNpZGVyZWQgYXMgYSBzbGlkZS4KICogRm9yIG1vcmUgZGV0YWlscyByZWFkIHRoZSBkb2N1bWVudGF0aW9uIG9mIGEgcmVnaXN0ZXIoc2VsZWN0b3IsIG9wdGlvbnMpIG1ldGhvZC4KICoKICogQHJlcXVpcmVzIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuNC40IG9yIGhpZ2hlcgogKi8KLyogZ2xvYmFsIEhhbW1lcjp0cnVlICovClhBLmNvbXBvbmVudC5jYXJvdXNlbHMgPSAoZnVuY3Rpb24gKCQpIHsKICB2YXIgcHViID0ge30sCiAgICBOYXZpZ2F0aW9uQnVpbGRlciA9IG51bGwsCiAgICBTbGlkZXJJbml0aWFsaXplciA9IG51bGw7CgogIC8qKgogICAqIFRpbWVyIGNsYXNzIHNhdmVzIHRpbWUgc3RhbXAgYW5kIGNvdW50cyB0aW1lIGRpZmZlcmVuY2UgYmV0d2VlbgogICAqIGN1cnJlbnQgdGltZSAodXBkYXRlKCkgbWV0aG9kKSBhbmQgc2F2ZWQgdGltZSBzdGFtcC4KICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBUaW1lcigpIHsKICAgIC8qKgogICAgICogVGltZSBkaWZmZXJlbmNlIGJldHdlZW4gbGFzdCB1cGRhdGUoKSBjYWxsIGFuZCBsYXN0IHNldCgpIGNhbGwKICAgICAqCiAgICAgKiBAbWVtYmVyIFRpbWVyCiAgICAgKi8KICAgIHRoaXMuZWxhcHNlZCA9IDA7CiAgICAvKioKICAgICAqIFRpbWUgc3RhbXAKICAgICAqCiAgICAgKiBAbWVtYmVyIFRpbWVyCiAgICAgKi8KICAgIHRoaXMuc3RhbXAgPSBudWxsOwogIH0KCiAgLyoqCiAgICogIENvdW50cyB0aW1lIGRpZmZlcmVuY2UgYmV0d2VlbiBjdXJyZW50IHRpbWUgYW5kIHNhdmVkIHRpbWUgc3RhbXAKICAgKgogICAqIEBtZW1iZXIgVGltZXIKICAgKi8KICBUaW1lci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuc3RhbXAgIT09IG51bGwpIHsKICAgICAgdGhpcy5lbGFwc2VkICs9IHRoaXMubmV3U3RhbXAoKSAtIHRoaXMuc3RhbXA7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogIFNhdmVzIG5ldyB0aW1lIHN0YW1wCiAgICoKICAgKiBAbWVtYmVyIFRpbWVyCiAgICovCiAgVGltZXIucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3RhbXAgPSB0aGlzLm5ld1N0YW1wKCk7CiAgfTsKCiAgLyoqCiAgICogIENvdW50cyB0aW1lIGRpZmZlcmVuY2UgYmV0d2VlbiBjdXJyZW50IHRpbWUgYW5kIHNhdmVkIHRpbWUgc3RhbXAKICAgKgogICAqIEBtZW1iZXIgVGltZXIKICAgKiBAcmV0dXJuIHN0YW1wIG9mIGEgY3VycmVudCB0aW1lCiAgICogQHR5cGUgTnVtYmVyCiAgICovCiAgVGltZXIucHJvdG90eXBlLm5ld1N0YW1wID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkudmFsdWVPZigpOwogIH07CgogIC8qKgogICAqICBSZXNldHMgZWxhcHNlZCB0aW1lLgogICAqCiAgICogQG1lbWJlciBUaW1lcgogICAqLwogIFRpbWVyLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuZWxhcHNlZCA9IDA7CiAgfTsKICAvKioKICAgKiBFbmQgb2YgVGltZXIgY2xhc3MKICAgKi8KCiAgLyoqCiAgICogVGltZUluZGljYXRvciBjbGFzcyBleHRlbmRzIFRpbWVyIGNsYXNzCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtPYmplY3R9ICQgICAgIGEgalF1ZXJ5IG9iamVjdAogICAqIEBwYXJhbSB7WEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3cy5WaWV3fSB2aWV3ICBhIHRpbWUgaW5kaWNhdG9yIHZpZXcuCiAgICogQHBhcmFtIHtOdW1iZXJ9IHRpbWVvdXQgICBhIHZpZXcgdGltZW91dAogICAqIEBiYXNlIFRpbWVyCiAgICovCiAgZnVuY3Rpb24gVGltZUluZGljYXRvcigkLCB2aWV3LCB0aW1lb3V0KSB7CiAgICAvKioKICAgICAqIEEgdGltZSBpbmRpY2F0b3Igdmlldy4KICAgICAqCiAgICAgKiBAbWVtYmVyIFRpbWVySW5kaWNhdG9yCiAgICAgKi8KICAgIHRoaXMudmlldyA9IHZpZXc7CgogICAgdGhpcy52aWV3LmluaXQodGltZW91dCk7CiAgfQogIFRpbWVJbmRpY2F0b3IucHJvdG90eXBlID0gbmV3IFRpbWVyKCk7CiAgVGltZUluZGljYXRvci5jb25zdHJ1Y3RvciA9IFRpbWVyOwoKICAvKioKICAgKiBQbGF5cyB0aGUgYXR0YWNoZWQgdmlldy4KICAgKgogICAqIEBtZW1iZXIgVGltZXJJbmRpY2F0b3IKICAgKi8KICBUaW1lSW5kaWNhdG9yLnByb3RvdHlwZS5wbGF5ID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy52aWV3LnBsYXkoKTsKICB9OwoKICAvKioKICAgKiBQYXVzZXMgdGhlIGF0dGFjaGVkIHZpZXcuCiAgICoKICAgKiBAbWVtYmVyIFRpbWVySW5kaWNhdG9yCiAgICovCiAgVGltZUluZGljYXRvci5wcm90b3R5cGUucGF1c2UgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnZpZXcucGF1c2UoKTsKICB9OwoKICAvKioKICAgKiBSZXNldHMgZWxhcHNlZCB0aW1lIGFuZCByZXNldHMgdGhlIGF0dGFjaGVkIHZpZXcuCiAgICoKICAgKiBAbWVtYmVyIFRpbWVySW5kaWNhdG9yCiAgICovCiAgVGltZUluZGljYXRvci5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICBUaW1lci5wcm90b3R5cGUucmVzZXQuY2FsbCh0aGlzKTsKICAgIHRoaXMudmlldy5yZXNldCgpOwogIH07CgogIC8qKgogICAqIENvdW50cyB0aW1lIGRpZmZlcmVuY2UgYmV0d2VlbiBjdXJyZW50IHRpbWUgYW5kIHNhdmVkIHRpbWUgc3RhbXAuCiAgICogYW5kIHVwZGF0ZXMgdGhlIGF0dGFjaGVkIHZpZXcKICAgKgogICAqIEBtZW1iZXIgVGltZXJJbmRpY2F0b3IKICAgKi8KICBUaW1lSW5kaWNhdG9yLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICBUaW1lci5wcm90b3R5cGUudXBkYXRlLmNhbGwodGhpcyk7CiAgICB0aGlzLnZpZXcudXBkYXRlKHRoaXMuZWxhcHNlZCk7CiAgfTsKICAvKioKICAgKiBlbmQgb2YgVGltZUluZGljYXRvciBjbGFzcwogICAqLwoKICAvKioKICAgKiBOYXZpZ2F0aW9uQnVpbGRlciBvYmplY3QgY3JlYXRlcyBuYXZpZ2F0aW9uIGl0ZW1zCiAgICovCiAgTmF2aWdhdGlvbkJ1aWxkZXIgPSAoZnVuY3Rpb24gKCQpIHsKICAgIGZ1bmN0aW9uIGNyZWF0ZUl0ZW0oc2V0dGluZ3MpIHsKICAgICAgdmFyIHRleHQgPSBzZXR0aW5ncy50ZXh0LAogICAgICAgICRuYXZJdGVtID0gbnVsbDsKCiAgICAgIHNldHRpbmdzLnRleHQgPSAiIjsKICAgICAgc2V0dGluZ3MuaHJlZiA9ICIjIjsKCiAgICAgICRuYXZJdGVtID0gJCgiPGE+Iiwgc2V0dGluZ3MpOwogICAgICAkKCI8c3Bhbj4iLCB7CiAgICAgICAgdGV4dDogdGV4dCwKICAgICAgfSkuYXBwZW5kVG8oJG5hdkl0ZW0pOwoKICAgICAgcmV0dXJuICRuYXZJdGVtOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIC8qKgogICAgICAgKiBSZXR1cm5zIHRoZSBlbGVtZW50KHMpIHRoYXQgbWF0Y2goZXMpIHRoZSBwcm92aWRlZCBzZWxlY3RvciBvciBudWxsCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvciBhIHNlbGVjdG9yIHVzZWQgZm9yIHNlYXJjaGluZwogICAgICAgKiBAcmV0dXJuIGEgalF1ZXJ5IG9iamVjdCBjb250YWluaW5nIGVsZW1lbnQocykgdGhhdCBtYXRjaChlcykgdGhlIHByb3ZpZGVkIHNlbGVjdG9yIG9yIG51bGwgaWYgbm8gZWxlbWVudCBtYXRjaAogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICovCiAgICAgIGdldEVsZW1lbnQ6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgIHZhciAkZWxlbWVudCA9ICQoc2VsZWN0b3IpOwoKICAgICAgICBpZiAoJGVsZW1lbnQubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAkZWxlbWVudCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJGVsZW1lbnQ7CiAgICAgIH0sCiAgICAgIC8qKgogICAgICAgKiBDcmVhdGVzIG5hdmlnYXRpb24gaXRlbXMgYW5kIGFwcGVuZHMgdGhlbSB0byAkY29udGFpbmVyLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gJGNvbnRhaW5lciAgIG5hdmlnYXRpb24gaXRlbXMgY29udGFpbmVyIChqUXVlcnkgb2JqZWN0KQogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbGFiZWwgICBuYXZpZ2F0aW9uIGl0ZW1zIGxhYmVsIHRlbXBsYXRlCiAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBjb3VudCAgICBudW1iZXIgb2YgbmF2aWdhdGlvbiBpdGVtcyB0byBjcmVhdGUKICAgICAgICovCiAgICAgIGNyZWF0ZUl0ZW1zOiBmdW5jdGlvbiAoJGNvbnRhaW5lciwgbGFiZWwsIGNvdW50KSB7CiAgICAgICAgdmFyIGksCiAgICAgICAgICBwYXR0ZXJuID0gLyNce2luZGV4XH0vZywKICAgICAgICAgIHNldHRpbmdzOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgIHRleHQ6IGxhYmVsLnJlcGxhY2UocGF0dGVybiwgaSArIDEpLAogICAgICAgICAgfTsKICAgICAgICAgIGNyZWF0ZUl0ZW0oc2V0dGluZ3MpLmFwcGVuZFRvKCRjb250YWluZXIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIENyZWF0ZXMgb3Igc2VsZWN0cyAncHJldmlvdXMnLyduZXh0JyBuYXZpZ2F0aW9uIGl0ZW0uCiAgICAgICAqIE1vZGUgb2YgYWN0aW9uIGRlcGVuZHMgb24gc2V0dGluZ3Mgb2JqZWN0OgogICAgICAgKiB2YXIgc2V0dGluZ3MgPSB7CiAgICAgICAqICAgICBpc0NvbnRhaW5lcjogQm9vbGVhbiB2YWx1ZSwKICAgICAgICogICAgIGxhYmVsOiBTdHJpbmcgdmFsdWUsCiAgICAgICAqICAgICBzZWxlY3RvcjogU3RyaW5nIHZhbHVlLAogICAgICAgKiAgICAgbWV0aG9kOiBTdHJpbmcgdmFsdWUKICAgICAgICogfTsKICAgICAgICoKICAgICAgICogSWYgc2V0dGluZ3Muc2VsZWN0b3IgPT09IG51bGwgb3IgaWYgc2V0dGluZ3Muc2VsZWN0b3IgIT09IG51bGwgYW5kIHNldHRpbmdzLmlzQ29udGFpbmVyID09IHRydWUKICAgICAgICogbmF2aWdhdGlvbiBpdGVtIGlzIGNyZWF0ZWQgYW5kIGF0dGFjaGVkIHRvICRlbGVtZW50LmZpcnN0KCkgKHVzaW5nIHNldHRpbmdzLm1ldGhvZCkuCiAgICAgICAqIElmIHNldHRpbmdzLnNlbGVjdG9yICE9PSBudWxsIGFuZCBzZXR0aW5ncy5pc0NvbnRhaW5lciA9PSBmYWxzZQogICAgICAgKiAkZWxlbWVudC5maXJzdCgpIGlzIHNlbGVjdGVkIGFzIG5hdmlnYXRpb24gaXRlbQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3Mgc2V0dGluZ3Mgb2YgbmF2aWdhdGlvbiBpdGVtCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtU2V0dGluZ3MgICBodG1sIGF0dHJpYnV0ZXMgb2YgbmF2aWdhdGlvbiBpdGVtCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSAkZWxlbWVudCAgICBuYXZpZ2F0aW9uIGl0ZW1zIGNvbnRhaW5lciAoalF1ZXJ5IG9iamVjdCkKICAgICAgICogQHJldHVybiBUaGUgJ3ByZXYnLyduZXh0JyBuYXZpZ2F0aW9uIGl0ZW0KICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqLwogICAgICBjcmVhdGVQcmV2TmV4dEl0ZW06IGZ1bmN0aW9uIChzZXR0aW5ncywgaXRlbVNldHRpbmdzLCAkZWxlbWVudCkgewogICAgICAgIHZhciAkaXRlbSA9IG51bGwsCiAgICAgICAgICBpc1NlbGVjdG9yRXhpc3RzID0gc2V0dGluZ3Muc2VsZWN0b3IgIT09IG51bGw7CgogICAgICAgIGlmIChpc1NlbGVjdG9yRXhpc3RzKSB7CiAgICAgICAgICAkZWxlbWVudCA9IHRoaXMuZ2V0RWxlbWVudChzZXR0aW5ncy5zZWxlY3Rvcik7CiAgICAgICAgfQoKICAgICAgICBpZiAoJGVsZW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgIGlmIChzZXR0aW5ncy5pc0NvbnRhaW5lciB8fCAhaXNTZWxlY3RvckV4aXN0cykgewogICAgICAgICAgICAkaXRlbSA9IGNyZWF0ZUl0ZW0oCiAgICAgICAgICAgICAgJC5leHRlbmQoCiAgICAgICAgICAgICAgICB7fSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdGV4dDogc2V0dGluZ3MubGFiZWwsCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaXRlbVNldHRpbmdzCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgICAgICAkZWxlbWVudC5maXJzdCgpW3NldHRpbmdzLm1ldGhvZF0oJGl0ZW0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJGl0ZW0gPSAkZWxlbWVudC5maXJzdCgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRpdGVtOwogICAgICB9LAogICAgfTsKICB9KSgkKTsKICAvKioKICAgKiBlbmQgb2YgTmF2aWdhdGlvbkJ1aWxkZXIgb2JqZWN0CiAgICovCgogIC8qKgogICAqIE5hdmlnYXRpb24gY2xhc3MgaG9sZHMgbmF2aWdhdGlvbiBpdGVtcy4KICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBOYXZpZ2F0aW9uKCQsICR3cmFwcGVyLCBvcHRpb25zKSB7CiAgICB2YXIgZGVmYXVsdHMgPSB7CiAgICAgICAgaXNFbmFibGVkOiB0cnVlLAogICAgICAgIGhhc1ByZXZOZXh0SXRlbXM6IHRydWUsCiAgICAgICAgaXRlbTogewogICAgICAgICAgbGFiZWw6ICIje2luZGV4fSIsCiAgICAgICAgICBzZWxlY3RvcjogbnVsbCwKICAgICAgICB9LAogICAgICAgIHByZXZJdGVtOiB7CiAgICAgICAgICBsYWJlbDogIjwiLAogICAgICAgICAgc2VsZWN0b3I6IG51bGwsCiAgICAgICAgICBpc0NvbnRhaW5lcjogZmFsc2UsCiAgICAgICAgfSwKICAgICAgICBuZXh0SXRlbTogewogICAgICAgICAgbGFiZWw6ICI+IiwKICAgICAgICAgIHNlbGVjdG9yOiBudWxsLAogICAgICAgICAgaXNDb250YWluZXI6IGZhbHNlLAogICAgICAgIH0sCiAgICAgICAgc2xpZGVzQ291bnQ6IDAsCiAgICAgIH0sCiAgICAgIHNldHRpbmdzID0gJC5leHRlbmQodHJ1ZSwge30sIGRlZmF1bHRzLCBvcHRpb25zKTsKCiAgICAvKioKICAgICAqIGpRdWVyeSBvYmplY3QKICAgICAqCiAgICAgKiBAbWVtYmVyIE5hdmlnYXRpb24KICAgICAqLwogICAgdGhpcy4kID0gJDsKICAgIC8qKgogICAgICogTmF2aWdhdGlvbiBpdGVtcyAob25lIGZvciBlYWNoIHNsaWRlIGlmIG5hdmlnYXRpb24gaXMgZW5hYmxlZCkuCiAgICAgKgogICAgICogQG1lbWJlciBOYXZpZ2F0aW9uCiAgICAgKi8KICAgIHRoaXMuJGl0ZW1zID0gJCgpOwogICAgLyoqCiAgICAgKiBOYXZpZ2F0aW9uICduZXh0JyBpdGVtIChpZiBwcmV2L25leHQgaXRlbXMgYXJlIGVuYWJsZWQpLgogICAgICoKICAgICAqIEBtZW1iZXIgTmF2aWdhdGlvbgogICAgICovCiAgICB0aGlzLiRuZXh0SXRlbSA9ICQoKTsKICAgIC8qKgogICAgICogTmF2aWdhdGlvbiAncHJldmlvdXMnIGl0ZW0gKGlmIHByZXYvbmV4dCBpdGVtcyBhcmUgZW5hYmxlZCkuCiAgICAgKgogICAgICogQG1lbWJlciBOYXZpZ2F0aW9uCiAgICAgKi8KICAgIHRoaXMuJHByZXZJdGVtID0gJCgpOwogICAgLyoqCiAgICAgKiBTZWxlY3RlZCBpdGVtIChvbmUgZnJvbSB0aGlzLiRpdGVtcyBvciBudWxsKS4KICAgICAqCiAgICAgKiBAbWVtYmVyIE5hdmlnYXRpb24KICAgICAqLwogICAgdGhpcy4kc2VsZWN0ZWRJdGVtID0gbnVsbDsKCiAgICAvL2luaXRpYWxpemF0aW9uCiAgICBpZiAoc2V0dGluZ3MuaXNFbmFibGVkKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5wcmVwYXJlSXRlbXMoc2V0dGluZ3MuaXRlbSwgc2V0dGluZ3Muc2xpZGVzQ291bnQsICR3cmFwcGVyKTsKICAgICAgICAvL3NlbGVjdCBmaXJzdCBpdGVtIG9uIGluaXQKICAgICAgICBzZWxmLnNlbGVjdEl0ZW0oMCk7CiAgICAgIH0sIDEwMDApOwoKICAgICAgJHdyYXBwZXIuZmluZCgiLm5hdiIpLnRyaWdnZXIoIm5hdmlnYXRpb24tY3JlYXRlZCIsIHRoaXMpOwogICAgfQogIH0KCiAgLyoqCiAgICogQ1NTIGNsYXNzbSB3aGljaCB3aWxsIGJlIHVzZWQgZm9yIG1hcmsgc2VsZWN0ZWQgaXRlbQogICAqCiAgICogQG1lbWJlciBOYXZpZ2F0aW9uCiAgICovCiAgTmF2aWdhdGlvbi5wcm90b3R5cGUuc2VsZWN0ZWRJdGVtQ2xhc3MgPSAiYWN0aXZlIjsKCiAgLyoqCiAgICogTWFyayBuYXZpZ2F0aW9uIGl0ZW0gd2l0aCBnaXZlbiBpbmRleCBhcyBzZWxlY3RlZC4KICAgKgogICAqIEBtZW1iZXIgTmF2aWdhdGlvbgogICAqIEBwYXJhbSB7TnVtYmVyfSBpbmRleCAgICAgaW5kZXggb2YgbmF2aWdhdGlvbiBpdGVtCiAgICovCiAgTmF2aWdhdGlvbi5wcm90b3R5cGUuc2VsZWN0SXRlbSA9IGZ1bmN0aW9uIChpbmRleCkgewogICAgaWYgKHRoaXMuJHNlbGVjdGVkSXRlbSAhPT0gbnVsbCkgewogICAgICB0aGlzLiRzZWxlY3RlZEl0ZW0ucmVtb3ZlQ2xhc3ModGhpcy5zZWxlY3RlZEl0ZW1DbGFzcyk7CiAgICB9CiAgICB0aGlzLiRzZWxlY3RlZEl0ZW0gPSB0aGlzLiRpdGVtcy5lcShpbmRleCkuYWRkQ2xhc3ModGhpcy5zZWxlY3RlZEl0ZW1DbGFzcyk7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlcyBvciBzZWxlY3RzIG5hdmlnYXRpb24gaXRlbXMgY29udGFpbmVyIGFuZCBmaWxscyBpdCB3aXRoIG5hdmlnYXRpb24gaXRlbXMuCiAgICogSWYgbmF2aWdhdGlvbiBpdGVtcyBjb250YWluZXIgaXMgbm90IGVtcHR5LCBjaGlsZCBlbGVtZW50cyBhcmUgYWRvcHRlZCBhcyBuYXZpZ2F0aW9uIGl0ZW1zLgogICAqIE1vZGUgb2YgYWN0aW9uIGRlcGVuZHMgb24gc2V0dGluZ3Mgb2JqZWN0OgogICAqIHZhciBzZXR0aW5ncyA9IHsKICAgKiAgICAgJ2xhYmVsJzogJyN7aW5kZXh9JywKICAgKiAgICAgJ3NlbGVjdG9yJzogbnVsbAogICAqIH07CiAgICogSWYgc2V0dGluZ3Muc2VsZWN0b3IgPT09IG51bGwgbmF2aWdhdGlvbiBpdGVtIGNvbnRhaW5lciBpcyBjcmVhdGVkLgogICAqIElmIHNldHRpbmdzLnNlbGVjdG9yICE9PSBudWxsIGVsZW1lbnQgdGhhdCBtYXRjaCBzZXR0aW5ncy5zZWxlY3RvciBpcyBhZGFwdGVkIGFzIG5hdmlnYWdhdGlvbiBpdGVtcyBjb250YWluZXIuCiAgICoKICAgKiBAbWVtYmVyIE5hdmlnYXRpb24KICAgKiBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3Mgc2V0dGluZ3Mgb2YgbmF2aWdhdGlvbiBpdGVtcwogICAqIEBwYXJhbSB7TnVtYmVyfSBjb3VudCAgIG51bWJlciBvZiBuYXZpZ2F0aW9uIGl0ZW1zCiAgICogQHBhcmFtIHtPYmplY3R9ICR3cmFwcGVyICAgIHdyYXBwZXIgb2YgbmF2aWdhdGlvbiBpdGVtcyBjb250YWluZXIgKGpRdWVyeSBvYmplY3QpCiAgICogQHJldHVybiBUaGUgY29udGFpbmVyIGZpbGxlZCB3aXRoIG5hdmlnYXRpb24gaXRlbXMuCiAgICogQHR5cGUgT2JqZWN0CiAgICovCiAgTmF2aWdhdGlvbi5wcm90b3R5cGUucHJlcGFyZUl0ZW1zID0gZnVuY3Rpb24gKHNldHRpbmdzLCBjb3VudCwgJHdyYXBwZXIpIHsKICAgIHZhciAkY29udGFpbmVyID0gbnVsbDsKCiAgICBpZiAoc2V0dGluZ3Muc2VsZWN0b3IgIT09IG51bGwpIHsKICAgICAgJGNvbnRhaW5lciA9IE5hdmlnYXRpb25CdWlsZGVyLmdldEVsZW1lbnQoc2V0dGluZ3Muc2VsZWN0b3IpOwogICAgfSBlbHNlIHsKICAgICAgJGNvbnRhaW5lciA9ICQoIjxkaXYvPiIsIHsKICAgICAgICBjbGFzczogIm5hdiIsCiAgICAgIH0pOwogICAgICAkY29udGFpbmVyLmFwcGVuZFRvKCR3cmFwcGVyKTsKICAgIH0KCiAgICBpZiAoJGNvbnRhaW5lciAhPT0gbnVsbCkgewogICAgICBpZiAoJGNvbnRhaW5lci5jaGlsZHJlbigpLmxlbmd0aCA9PT0gMCkgewogICAgICAgIE5hdmlnYXRpb25CdWlsZGVyLmNyZWF0ZUl0ZW1zKCRjb250YWluZXIsIHNldHRpbmdzLmxhYmVsLCBjb3VudCk7CiAgICAgIH0KICAgICAgdGhpcy4kaXRlbXMgPSAkY29udGFpbmVyLmNoaWxkcmVuKCkuc2xpY2UoMCwgY291bnQpOwogICAgfQoKICAgIHJldHVybiAkY29udGFpbmVyOwogIH07CgogIC8qKgogICAqIENyZWF0ZXMgb3Igc2VsZWN0cyBuYXZpZ2F0aW9uICdwcmV2aW91cycgYW5kICduZXh0JyBuYXZpZ2F0aW9uIGl0ZW1zIChAc2VlIE5hdmlnYXRpb25CdWlsZGVyLmNyZWF0ZVByZXZOZXh0SXRlbSgpKS4KICAgKiBJZiBuYXZpZ2F0aW9uIGl0ZW1zIGNvbnRhaW5lciBpcyBub3QgZW1wdHksIGNoaWxkIGVsZW1lbnRzIGFyZSBhZG9wdGVkIGFzIG5hdmlnYXRpb24gaXRlbXMuCiAgICoKICAgKiBAbWVtYmVyIE5hdmlnYXRpb24KICAgKiBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3Mgc2V0dGluZ3Mgb2YgbmF2aWdhdGlvbgogICAqIEBwYXJhbSB7T2JqZWN0fSAkY29udGFpbmVyICAgIG5hdmlnYXRpb24gaXRlbXMgY29udGFpbmVyIChqUXVlcnkgb2JqZWN0KQogICAqLwogIE5hdmlnYXRpb24ucHJvdG90eXBlLnByZXBhcmVQcmV2TmV4dEl0ZW1zID0gZnVuY3Rpb24gKHNldHRpbmdzLCAkY29udGFpbmVyKSB7CiAgICB2YXIgJGl0ZW07CgogICAgc2V0dGluZ3MucHJldkl0ZW0ubWV0aG9kID0gInByZXBlbmQiOwogICAgJGl0ZW0gPSBOYXZpZ2F0aW9uQnVpbGRlci5jcmVhdGVQcmV2TmV4dEl0ZW0oCiAgICAgIHNldHRpbmdzLnByZXZJdGVtLAogICAgICB7CiAgICAgICAgY2xhc3M6ICJwcmV2IiwKICAgICAgfSwKICAgICAgJGNvbnRhaW5lcgogICAgKTsKICAgIHRoaXMuJHByZXZJdGVtID0gJGl0ZW0gPT09IG51bGwgPyB0aGlzLiRwcmV2SXRlbSA6ICRpdGVtOwoKICAgIHNldHRpbmdzLm5leHRJdGVtLm1ldGhvZCA9ICJhcHBlbmQiOwogICAgJGl0ZW0gPSBOYXZpZ2F0aW9uQnVpbGRlci5jcmVhdGVQcmV2TmV4dEl0ZW0oCiAgICAgIHNldHRpbmdzLm5leHRJdGVtLAogICAgICB7CiAgICAgICAgY2xhc3M6ICJuZXh0IiwKICAgICAgfSwKICAgICAgJGNvbnRhaW5lcgogICAgKTsKICAgIHRoaXMuJG5leHRJdGVtID0gJGl0ZW0gPT09IG51bGwgPyB0aGlzLiRuZXh0SXRlbSA6ICRpdGVtOwogIH07CiAgLyoqCiAgICogZW5kIG9mIE5hdmlnYXRpb24gY2xhc3MKICAgKi8KCiAgLyoqCiAgICogY2xhc3MgU3dpcGVyIHlvdSBjYW4gZGVmaW5lIGhvcml6b250YWwgc3dpcGUgZm9yIGNob3NpbmcgZWxlbWVudCBhbmQgc2V0IGJlaGF2aW9yIG9mIHN3aXBlKGxlZnQvcmlnaHQpLgogICAqIFlvdSBjYW4gZXh0ZW5kIHRoaXMgY2xhc3Mgd2l0aCB2ZXJ0aWNhbCBzd2lwZSBpZiBpdCBuZWVkcwogICAqIEBwYXJhbSB0YXJnZXQgRWxlbWVudCBvciBxdWVyeSBvZiBxdWVyeVNlbGVjdG9yCiAgICovCiAgZnVuY3Rpb24gU3dpcGVyKHRhcmdldCkgewogICAgbGV0IHRvdWNoU3RhcnRYID0gMCwKICAgICAgdG91Y2hTdGFydFkgPSAwLAogICAgICB0b3VjaEVuZFggPSAwLAogICAgICB0b3VjaEVuZFkgPSAwLAogICAgICB0aHJlc2hvbGQgPSA1MDsKCiAgICBsZXQgb25Td2lwZUxlZnRBZ2VudCA9IG51bGwsCiAgICAgIG9uU3dpcGVSaWdodEFnZW50ID0gbnVsbCwKICAgICAgZWxlbWVudCA9IG51bGw7CgogICAgZWxlbWVudCA9CiAgICAgIHRhcmdldCBpbnN0YW5jZW9mIEV2ZW50VGFyZ2V0ID8gdGFyZ2V0IDogZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0YXJnZXQpOwoKICAgIG9uVG91Y2hTdGFydCA9IChldmVudCkgPT4gewogICAgICB0b3VjaFN0YXJ0WCA9IGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnNjcmVlblg7CiAgICAgIHRvdWNoU3RhcnRZID0gZXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0uc2NyZWVuWTsKICAgIH07CgogICAgb25Ub3VjaEVuZCA9IChldmVudCkgPT4gewogICAgICB0b3VjaEVuZFggPSBldmVudC5jaGFuZ2VkVG91Y2hlc1swXS5zY3JlZW5YOwogICAgICB0b3VjaEVuZFkgPSBldmVudC5jaGFuZ2VkVG91Y2hlc1swXS5zY3JlZW5ZOwogICAgICBoYW5kbGVHZXN0dXJlKGV2ZW50KTsKICAgIH07CgogICAgb25Nb3VzZURvd24gPSAoZXZlbnQpID0+IHsKICAgICAgdG91Y2hTdGFydFggPSBldmVudC5zY3JlZW5YOwogICAgICB0b3VjaFN0YXJ0WSA9IGV2ZW50LnNjcmVlblk7CiAgICB9OwoKICAgIG9uTW91c2VVcCA9IChldmVudCkgPT4gewogICAgICB0b3VjaEVuZFggPSBldmVudC5zY3JlZW5YOwogICAgICB0b3VjaEVuZFkgPSBldmVudC5zY3JlZW5ZOwogICAgICBoYW5kbGVHZXN0dXJlKGV2ZW50KTsKICAgIH07CgogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaHN0YXJ0Iiwgb25Ub3VjaFN0YXJ0LCBmYWxzZSk7CgogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaGVuZCIsIG9uVG91Y2hFbmQsIGZhbHNlKTsKCiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIG9uTW91c2VEb3duLCBmYWxzZSk7CgogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgb25Nb3VzZVVwLCBmYWxzZSk7CgogICAgLyoqCiAgICAgKiBtZXRob2Qgd2hpY2ggZGVmaW5lcyBzd2lwZSBsZWZ0CiAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuYwogICAgICovCiAgICB0aGlzLm9uU3dpcGVMZWZ0ID0gKGNhbGxiYWNrKSA9PiB7CiAgICAgIG9uU3dpcGVMZWZ0QWdlbnQgPSAoZXZlbnQpID0+IGNhbGxiYWNrLmNhbGwodGhpcywgZXZlbnQpOwogICAgfTsKCiAgICAvKioKICAgICAqIG1ldGhvZCB3aGljaCBkZWZpbmVzIHN3aXBlIHJpZ2h0CiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgdGhpcy5vblN3aXBlUmlnaHQgPSAoY2FsbGJhY2spID0+IHsKICAgICAgb25Td2lwZVJpZ2h0QWdlbnQgPSAoZXZlbnQpID0+IGNhbGxiYWNrLmNhbGwodGhpcywgZXZlbnQpOwogICAgfTsKCiAgICB0aGlzLmRlc3Ryb3kgPSAoKSA9PiB7CiAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigidG91Y2hzdGFydCIsIG9uVG91Y2hTdGFydCk7CiAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigidG91Y2hlbmQiLCBvblRvdWNoRW5kKTsKICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBvbk1vdXNlRG93bik7CiAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2V1cCIsIG9uTW91c2VVcCk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIGhhbmRsZUdlc3R1cmUoZXZlbnQpIHsKICAgICAgLyoqCiAgICAgICAqIHN3aXBlZCBsZWZ0CiAgICAgICAqLwogICAgICBpZiAodG91Y2hFbmRYICsgdGhyZXNob2xkIDw9IHRvdWNoU3RhcnRYKSB7CiAgICAgICAgb25Td2lwZUxlZnRBZ2VudCAmJiBvblN3aXBlTGVmdEFnZW50KGV2ZW50KTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqIHN3aXBlZCByaWdodAogICAgICAgKi8KICAgICAgaWYgKHRvdWNoRW5kWCAtIHRocmVzaG9sZCA+PSB0b3VjaFN0YXJ0WCkgewogICAgICAgIG9uU3dpcGVSaWdodEFnZW50ICYmIG9uU3dpcGVSaWdodEFnZW50KGV2ZW50KTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICogU2xpZGVyQ29udGV4dCBjbGFzcyBpcyBiaW5kZWQgdG8gYSBTbGlkZXIgY2xhc3MgaW5zdGFuY2UKICAgKiBhbmQgaG9sZHMgaXRzIHByb3BlcnRpZXMuCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gU2xpZGVyQ29udGV4dCgpIHsKICAgIC8qKgogICAgICogRmxhZywgd2hpY2ggZGV0ZXJtaW5lcyBpZiBzbGlkZSBjYW4gb3IgY2FuIG5vdCBiZSBjaGFuZ2VkIChmb3IgdXNlciByZXF1ZXN0KQogICAgICoKICAgICAqIEBtZW1iZXIgU2xpZGVyQ29udGV4dAogICAgICovCiAgICB0aGlzLmNhbkNoYW5nZVNsaWRlID0gdHJ1ZTsKICAgIC8qKgogICAgICogRGVmYXVsdCBTbGlkZXIgc2V0dGluZyBvYmplY3QgKEBzZWUgU2xpZGVyKQogICAgICoKICAgICAqIEBtZW1iZXIgU2xpZGVyQ29udGV4dAogICAgICovCiAgICB0aGlzLmRlZmF1bHRzID0gbnVsbDsKICAgIC8qKgogICAgICogTmF2aWdhdGlvbiBvYmplY3QgKEBzZWUgTmF2aWdhdGlvbikKICAgICAqCiAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQKICAgICAqLwogICAgdGhpcy5uYXZpZ2F0aW9uID0gbnVsbDsKICAgIC8qKgogICAgICogU2xpZGVyIG9iamVjdCwgd2hpY2ggdGhpcyBjb250ZXh0IGlzIGF0dGFjZWhkIHRvLgogICAgICoKICAgICAqIEBtZW1iZXIgU2xpZGVyQ29udGV4dAogICAgICovCiAgICB0aGlzLm93bmVyID0gbnVsbDsKICAgIC8qKgogICAgICogRmxhZywgd2hpY2ggZGV0ZXJtaW5lcyBpZiBjaGFuZ2Ugb2YgYSBzbGlkZSBjYW4gb3IgY2FuIG5vdCBiZSBzY2hlZHVsZWQKICAgICAqCiAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQKICAgICAqLwogICAgdGhpcy5wcmV2ZW50U2NoZWR1bGluZyA9IGZhbHNlOwogICAgLyoqCiAgICAgKiBTbGlkZXIgc2V0dGluZyBvYmplY3QKICAgICAqCiAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQKICAgICAqLwogICAgdGhpcy5zZXR0aW5ncyA9IG51bGw7CiAgICAvKioKICAgICAqIEluc3RhbmNlIG9mIFRpbWVyIGNsYXNzIChAc2VlIFRpbWVyKSwgd2hpY2ggaXMgdXNlZCB0byBzdG9yZSBob3cgbXVjaAogICAgICogdGltZSBpcyBsZWZ0IHRvIGNoYW5nZSB0aGUgc2xpZGUKICAgICAqCiAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQKICAgICAqLwogICAgdGhpcy5zbGlkZVRpbWVyID0gbmV3IFRpbWVyKCk7CiAgICAvKioKICAgICAqIEluc3RhbmNlIG9mIFRpbWVJbmRpY2F0b3IgY2xhc3MgKEBzZWUgVGltZUluZGljYXRvcikKICAgICAqCiAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQKICAgICAqLwogICAgdGhpcy50aW1lSW5kaWNhdG9yID0gbnVsbDsKICAgIC8qKgogICAgICogVGltZXJzIGFycmF5LgogICAgICoKICAgICAqIEBtZW1iZXIgU2xpZGVyQ29udGV4dAogICAgICovCiAgICB0aGlzLnRpbWVycyA9IFtdOwogICAgLyoqCiAgICAgKiBMYXN0IHRpbWVvdXQgaWRlbnRpZmllci4KICAgICAqCiAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQKICAgICAqLwogICAgdGhpcy50aW1lb3V0SWQgPSBudWxsOwogICAgLyoqCiAgICAgKiBUcmFuc2l0aW9uIChAc2VlIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuVHJhbnNpdGlvbnMuVHJhbnNpdGlvbikgdXNlZCB3aGlsZSBjaGFuZ2luZyBzbGlkZXMKICAgICAqCiAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQKICAgICAqLwogICAgdGhpcy50cmFuc2l0aW9uID0gbnVsbDsKICAgIC8qKgogICAgICogVHJhbnNpdGlvbiBzZXR0aW5ncyBvYmplY3QgKEBzZWUgWEEuY29tcG9uZW50LmNhcm91c2Vscy5UcmFuc2l0aW9ucy5UcmFuc2l0aW9uU2V0dGluZ3MpCiAgICAgKgogICAgICogQG1lbWJlciBTbGlkZXJDb250ZXh0CiAgICAgKi8KICAgIHRoaXMudHJhbnNpdGlvblNldHRpbmdzID0KICAgICAgbmV3IFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuVHJhbnNpdGlvbnMuVHJhbnNpdGlvblNldHRpbmdzKCk7CiAgICAvKioKICAgICAqIGpRdWVyeSBvYmplY3Qgd2hpY2ggY29udGFpbnMgYWxsIHNsaWRlcwogICAgICoKICAgICAqIEBtZW1iZXIgU2xpZGVyQ29udGV4dAogICAgICovCiAgICB0aGlzLiRzbGlkZXMgPSBudWxsOwogICAgLyoqCiAgICAgKiBqUXVlcnkgb2JqZWN0IGNvbnRhaW5pbmcgZWxlbWVudCB0aGF0IHdyYXBwcyBzbGlkZXMKICAgICAqCiAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQKICAgICAqLwogICAgdGhpcy4kd3JhcHBlciA9IG51bGw7CiAgICAvKioKICAgICAqIFJlZmVyZW5jZSB0byBtZXRob2QsIHdoaWNoIHNob3VsZCBjaGFuZ2UgY3VycmVudCBzbGlkZQogICAgICoKICAgICAqIEBtZW1iZXIgU2xpZGVyQ29udGV4dAogICAgICovCiAgICB0aGlzLmNoYW5nZUN1cnJlbnRTbGlkZSA9IG51bGw7CiAgICAvKioKICAgICAqIFJlZmVyZW5jZSB0byBtZXRob2QsIHdoaWNoIHNob3VsZCByZXR1cm4galF1ZXJ5IG9iamVjdCB3aXRoIGN1cnJlbnQgc2xpZGUKICAgICAqCiAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQKICAgICAqLwogICAgdGhpcy5nZXRDdXJyZW50U2xpZGUgPSBudWxsOwoKICAgIHRoaXMudGltZXJzLnB1c2godGhpcy5zbGlkZVRpbWVyKTsKICB9CiAgLyoqCiAgICogZW5kIG9mIFNsaWRlckNvbnRleHQgY2xhc3MKICAgKi8KCiAgLyoqCiAgICogU2xpZGVyIGNsYXNzIG1hbmFnZXMgY2hhbmdpbmcgb2Ygc2xpZGVzLgogICAqCiAgICogT3B0aW9ucyBvYmplY3Q6CiAgICogewogICAqICAgICAnbmF2aWdhdGlvbic6IE9iamVjdCB2YWx1ZSwgLy9uYXZpZ2F0aW9uIHNldHRpbmdzIG9iamVjdAogICAqICAgICAndGltZW91dCc6IE51bWJlciB2YWx1ZSwgLy90aW1lIGJldHdlZW4gc2xpZGVzIGNoYW5naW5nCiAgICogICAgICd0cmFuc2l0aW9uJzogU3RyaW5nIHZhbHVlLCAvL25hbWUgb2YgdHJhbnNpdGlvbiBjbGFzcyAoQHNlZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zLlRyYW5zaXRpb24pCiAgICogICAgICdpc1BhdXNlRW5hYmxlZCc6IEJvb2xlYW4gdmFsdWUsIC8vZmxhZywgd2hpY2ggZGV0ZXJtaW5lcyBpZiBwYXVzZSBmZWF0dXJlIGlzIGVuYWJsZWQKICAgKiAgICAgJ3RpbWVJbmRpY2F0b3InOiB7CiAgICogICAgICAgICAnaXNFbmFibGVkJzogQm9vbGVhbiB2YWx1ZSwgLy9mbGFnLCB3aGljaCBkZXRlcm1pbmVzIGlmIHRpbWUgaW5kaWNhdG9yIGlzIGVuYWJsZWQKICAgKiAgICAgICAgICdzZWxlY3Rvcic6IFN0cmluZyB2YWx1ZSwgLy9zZWxlY3RvciBvZiB0aW1lIGluZGljYXRvciBodG1sIGVsZW1lbnQKICAgKiAgICAgICAgICd2aWV3JzogU3RyaW5nIHZhbHVlLCAvL25hbWUgb2YgdmlldyBjbGFzcyAoQHNlZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvclZpZXdzLlZpZXcKICAgKiAgICAgICAgICdvcHRpb25zJzogT2JqZWN0IHZhbHVlIC8vb2JqZWN0IHdpdGggb3B0aW9ucywgd2hpY2ggd2lsbCBiZSBwYXNzZWQgdG8gYSB0aW1lIGluZGljYXRvciB2aWV3CiAgICogICAgIH0KICAgKiB9CiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtPYmplY3R9ICQgICAgIHRoZSBqUXVlcnkgb2JqZWN0CiAgICogQHBhcmFtIHtTbGlkZXJDb250ZXh0fSBjb250ZXh0ICAgIGluc3RhbmNlIG9mIFNsaWRlckNvbnRleHQgY2xhc3M7IG11c3QgYmUgc2VwYXJhdGUgZm9yIGVhY2ggaW5zdGFuY2UgKEBzZWUgU2xpZGVyQ29udGV4dCkKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAgICBTbGlkZXIgb3B0aW9ucyBvYmplY3QKICAgKi8KICBmdW5jdGlvbiBTbGlkZXIoJCwgY29udGV4dCwgb3B0aW9ucykgewogICAgdmFyIGRlZmF1bHRzID0gewogICAgICBuYXZpZ2F0aW9uOiB7fSwKICAgICAgdGltZW91dDogMTAwMDAsCiAgICAgIHRyYW5zaXRpb246ICJCYXNpY1RyYW5zaXRpb24iLAogICAgICBpc1BhdXNlRW5hYmxlZDogdHJ1ZSwKICAgICAgdGltZUluZGljYXRvcjogewogICAgICAgIGlzRW5hYmxlZDogZmFsc2UsCiAgICAgICAgc2VsZWN0b3I6IG51bGwsCiAgICAgICAgdmlldzogIlZpZXciLAogICAgICAgIG9wdGlvbnM6IHt9LAogICAgICB9LAogICAgfTsKCiAgICAvKioKICAgICAqIEluc3RhbmNlIG9mIFNsaWRlckNvbnRleHQgY2xhc3MgKEBzZWUgU2xpZGVyQ29udGV4dCkKICAgICAqCiAgICAgKiBAbWVtYmVyIE5hdmlnYXRpb24KICAgICAqLwogICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKCiAgICBjb250ZXh0Lm93bmVyID0gdGhpczsKICAgIGNvbnRleHQuZGVmYXVsdHMgPSBkZWZhdWx0czsKICAgIGNvbnRleHQuc2V0dGluZ3MgPSAkLmV4dGVuZCh0cnVlLCB7fSwgZGVmYXVsdHMsIG9wdGlvbnMpOwogICAgY29udGV4dC50cmFuc2l0aW9uU2V0dGluZ3MuJHNsaWRlcyA9IGNvbnRleHQuJHNsaWRlczsKICB9CgogIC8qKgogICAqIEV4ZWN1dGVzIG1ldGhvZCB3aXRoIGdpdmVuIG1ldGhvZE5hbWUgb24gZWFjaCBUaW1lciBpbiBjb250ZXh0LnRpbWVycyAoQHNlZSBUaW1lcikKICAgKgogICAqIEBtZW1iZXIgU2xpZGVyCiAgICogQHBhcmFtIHtTdHJpbmd9IG1ldGhvZE5hbWUgICBuYW1lIG9mIGEgbWV0aG9kLCB3aGljaCB3aWxsIGJlIGV4ZWN1dGVkIG9uIHRpbWVycwogICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgICBjdXJyZW50IGNvbnRleHQKICAgKi8KICBTbGlkZXIucHJvdG90eXBlLmV4ZWN1dGVPblRpbWVycyA9IGZ1bmN0aW9uIChtZXRob2ROYW1lLCBjb250ZXh0KSB7CiAgICB2YXIgaSA9IG51bGwsCiAgICAgIHRpbWVyID0gbnVsbCwKICAgICAgdGltZXJzID0gY29udGV4dC50aW1lcnM7CgogICAgZm9yIChpID0gMDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKykgewogICAgICB0aW1lciA9IHRpbWVyc1tpXTsKICAgICAgaWYgKHR5cGVvZiB0aW1lclttZXRob2ROYW1lXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRpbWVyW21ldGhvZE5hbWVdKCk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBEZXNjaGVkdWxlcyBjaGFuZ2Ugb2YgYSBzbGlkZSwgYnkgY2xlYXJpbmcgdGltZW91dCBwcmV2aW91c2x5IHNldCBieSBzZXRUaWVtb3V0KCkgZnVuY3Rpb24uCiAgICoKICAgKiBAbWVtYmVyIFNsaWRlcgogICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgICBjdXJyZW50IGNvbnRleHQKICAgKi8KICBTbGlkZXIucHJvdG90eXBlLmRlc2NoZWR1bGVTbGlkZSA9IGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICBpZiAoY29udGV4dC50aW1lb3V0SWQgIT09IG51bGwpIHsKICAgICAgY2xlYXJUaW1lb3V0KGNvbnRleHQudGltZW91dElkKTsKICAgICAgY29udGV4dC50aW1lb3V0SWQgPSBudWxsOwogICAgfQogIH07CgogIC8qKgogICAqIFNjaGVkdWxlcyBjaGFuZ2Ugb2YgYSBzbGlkZSwgYnkgc2V0dGluZyB0aW1lb3V0ICh1c2luZyBzZXRUaWVtb3V0KCkgZnVuY3Rpb24pIGlmIGNhbi4KICAgKiBJZiBjYW4ndCwgdHJpZXMgYWdhaW4gYWZ0ZXIgc2hvcnQgcGVyaW9kIG9mIHRpbWUuCiAgICoKICAgKiBAbWVtYmVyIFNsaWRlcgogICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgICBjdXJyZW50IGNvbnRleHQKICAgKi8KICBTbGlkZXIucHJvdG90eXBlLnNjaGVkdWxlU2xpZGUgPSBmdW5jdGlvbiAoY29udGV4dCkgewogICAgdmFyIG93bmVyID0gY29udGV4dC5vd25lcjsKCiAgICBvd25lci5kZXNjaGVkdWxlU2xpZGUoY29udGV4dCk7CgogICAgaWYgKCFjb250ZXh0LnByZXZlbnRTY2hlZHVsaW5nICYmIGNvbnRleHQuJHNsaWRlcy5sZW5ndGggPiAxKSB7CiAgICAgIG93bmVyLmV4ZWN1dGVPblRpbWVycygic2V0IiwgY29udGV4dCk7CgogICAgICBpZiAoY29udGV4dC5jYW5DaGFuZ2VTbGlkZSkgewogICAgICAgIGlmIChjb250ZXh0LnRpbWVJbmRpY2F0b3IgIT09IG51bGwpIHsKICAgICAgICAgIGNvbnRleHQudGltZUluZGljYXRvci5wbGF5KCk7CiAgICAgICAgfQogICAgICAgIGNvbnRleHQudGltZW91dElkID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBvd25lci5jaGFuZ2VDdXJyZW50U2xpZGVCeSgxLCBjb250ZXh0KTsKICAgICAgICB9LCBjb250ZXh0LnNldHRpbmdzLnRpbWVvdXQgLSBjb250ZXh0LnNsaWRlVGltZXIuZWxhcHNlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBvd25lci5zY2hlZHVsZVNsaWRlKGNvbnRleHQpOwogICAgICAgIH0sIDEwMCk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBDaGFuZ2VzIGN1cnJlbnQgc2xpZGUsIGJ5IG9mZnNldCBwZXJmb3JtaW5nIGNvbnRleHQudHJhbnNpdGlvbgogICAqIEFueSBvZmZzZXQgdmFsdWUgaXMgc2F2ZSAoaWYgaXQgaXMgYW4gaW50ZWdlcikuCiAgICoKICAgKiBAbWVtYmVyIFNsaWRlcgogICAqIEBwYXJhbSB7TnVtYmVyfSBvZmZzZXQgICAgdGhlIG9mZnNldCB0byBhbiBpbmRleCBvZiBhIG5ldyBzbGlkZQogICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgICBjdXJyZW50IGNvbnRleHQKICAgKi8KICBTbGlkZXIucHJvdG90eXBlLmNoYW5nZUN1cnJlbnRTbGlkZUJ5ID0gZnVuY3Rpb24gKG9mZnNldCwgY29udGV4dCkgewogICAgdmFyIHNldHRpbmdzID0gY29udGV4dC50cmFuc2l0aW9uU2V0dGluZ3MsCiAgICAgICRjdXJyZW50U2xpZGUgPSBjb250ZXh0LmdldEN1cnJlbnRTbGlkZSgpLAogICAgICAkc2xpZGVzID0gY29udGV4dC4kc2xpZGVzOwoKICAgIGlmIChvZmZzZXQgJSAkc2xpZGVzLmxlbmd0aCAhPT0gMCkgewogICAgICBjb250ZXh0LmNhbkNoYW5nZVNsaWRlID0gZmFsc2U7CgogICAgICBzZXR0aW5ncy5vZmZzZXQgPSBvZmZzZXQ7CiAgICAgIHNldHRpbmdzLiRjdXJyZW50U2xpZGUgPSAkY3VycmVudFNsaWRlOwogICAgICBzZXR0aW5ncy4kbmV4dFNsaWRlID0gJHNsaWRlcy5lcSgKICAgICAgICAoJGN1cnJlbnRTbGlkZS5pbmRleCgpICsgb2Zmc2V0KSAlICRzbGlkZXMubGVuZ3RoCiAgICAgICk7CgogICAgICBjb250ZXh0LmNoYW5nZUN1cnJlbnRTbGlkZShzZXR0aW5ncy4kbmV4dFNsaWRlKTsKICAgICAgY29udGV4dC50cmFuc2l0aW9uLnBlcmZvcm0oY29udGV4dC50cmFuc2l0aW9uU2V0dGluZ3MpOwogICAgICBjb250ZXh0Lm93bmVyLmV4ZWN1dGVPblRpbWVycygicmVzZXQiLCBjb250ZXh0KTsKICAgIH0KCiAgICB2YXIgJGNhcm91c2VsID0gJChjb250ZXh0LiR3cmFwcGVyKS5wYXJlbnRzKCIuY2Fyb3VzZWwiKTsKICAgICRjYXJvdXNlbC50cmlnZ2VyKCJzbGlkZS1jaGFuZ2VkIik7CiAgfTsKCiAgLyoqCiAgICogU3RhcnRzIGF1dG9tYXRpYyBzbGlkZXMgY2hhbmdpbmcKICAgKgogICAqIEBtZW1iZXIgU2xpZGVyCiAgICovCiAgU2xpZGVyLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmV4ZWN1dGVPblRpbWVycygicmVzZXQiLCB0aGlzLmNvbnRleHQpOwogICAgdGhpcy5zY2hlZHVsZVNsaWRlKHRoaXMuY29udGV4dCk7CiAgfTsKCiAgLyoqCiAgICogQ2FuY2VsIHRoZSBkZWZhdWx0IGFjdGlvbiBvZiBldmVudCBhbmQgY2hhbmdlcyBzbGlkZSBtYW51YWxseS4KICAgKgogICAqIEBtZW1iZXIgU2xpZGVyCiAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50ICAgICB0aGUgZXZlbnQKICAgKiBAcGFyYW0ge051bWJlcn0gb2Zmc2V0ICAgIHRoZSBvZmZzZXQgdG8gYW4gaW5kZXggb2YgYSBuZXcgc2xpZGUKICAgKiBAcGFyYW0ge1NsaWRlckNvbnRleHR9IGNvbnRleHQgICAgY3VycmVudCBjb250ZXh0CiAgICovCiAgU2xpZGVyLnByb3RvdHlwZS5vbkNoYW5nZUN1cnJlbnRTbGlkZSA9IGZ1bmN0aW9uIChldmVudCwgb2Zmc2V0LCBjb250ZXh0KSB7CiAgICB2YXIgb3duZXIgPSBjb250ZXh0Lm93bmVyOwoKICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICBpZiAoY29udGV4dC5jYW5DaGFuZ2VTbGlkZSkgewogICAgICBvd25lci5kZXNjaGVkdWxlU2xpZGUoY29udGV4dCk7CiAgICAgIG93bmVyLmNoYW5nZUN1cnJlbnRTbGlkZUJ5KG9mZnNldCwgY29udGV4dCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2VsZWN0cyBuYXZpZ2F0aW9uIGl0ZW0gd2l0aCBnaXZlbiBpbmRleC4KICAgKgogICAqIEBtZW1iZXIgU2xpZGVyCiAgICogQHBhcmFtIHtOdW1iZXJ9IGluZGV4ICAgICB0aGUgaW5kZXggb2YgbmF2aWdhdGlvbiBpdGVtCiAgICovCiAgU2xpZGVyLnByb3RvdHlwZS5zZWxlY3ROYXZpZ2F0aW9uSXRlbSA9IGZ1bmN0aW9uIChpbmRleCkgewogICAgdGhpcy5jb250ZXh0Lm5hdmlnYXRpb24uc2VsZWN0SXRlbShpbmRleCk7CiAgfTsKICAvKioKICAgKiBlbmQgb2YgU2xpZGVyIGNsYXNzCiAgICovCgogIC8qKgogICAqIFNsaWRlckluaXRpYWxpemVyIG9iamVjdCBzZXQgdXAgaW5zdGFuY2VzIG9mIFNsaWRlciBjbGFzcwogICAqLwogIFNsaWRlckluaXRpYWxpemVyID0gKGZ1bmN0aW9uICgkKSB7CiAgICAvKioKICAgICAqIEF0dGFjaGVzIGV2ZW50cyB0byBuYXZpZ2F0aW9uIGl0ZW1zLgogICAgICoKICAgICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgIGEgY29udGV4dCBvZiBhIFNsaWRlciBjbGFzcyBpbnN0YW5jZQogICAgICovCiAgICBmdW5jdGlvbiBhdHRhY2hOYXZpZ2F0aW9uRXZlbnRzKGNvbnRleHQpIHsKICAgICAgdmFyIG93bmVyID0gY29udGV4dC5vd25lciwKICAgICAgICAkbmF2TGlua3MgPSBjb250ZXh0LiR3cmFwcGVyLmZpbmQoIi5uYXYgYSIpLAogICAgICAgICRwcmV2SXRlbVR4dCA9IGNvbnRleHQuJHdyYXBwZXIuZmluZCgiLnByZXYtdGV4dCIpLAogICAgICAgICRuZXh0SXRlbVR4dCA9IGNvbnRleHQuJHdyYXBwZXIuZmluZCgiLm5leHQtdGV4dCIpOwoKICAgICAgY29udGV4dC5uYXZpZ2F0aW9uLiRpdGVtcy5lYWNoKGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgIHZhciAkc2xpZGUgPSBjb250ZXh0LiRzbGlkZXMuZXEoaW5kZXgpOwoKICAgICAgICAkKHRoaXMpLmNsaWNrKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgb3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoCiAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAkc2xpZGUuaW5kZXgoKSAtIGNvbnRleHQuZ2V0Q3VycmVudFNsaWRlKCkuaW5kZXgoKSwKICAgICAgICAgICAgY29udGV4dAogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICAkcHJldkl0ZW1UeHQuY2xpY2soZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgb3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZXZlbnQsIC0xLCBjb250ZXh0KTsKICAgICAgfSk7CgogICAgICAkbmV4dEl0ZW1UeHQuY2xpY2soZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgb3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZXZlbnQsIDEsIGNvbnRleHQpOwogICAgICB9KTsKCiAgICAgIGNvbnRleHQubmF2aWdhdGlvbi4kcHJldkl0ZW0uY2xpY2soZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgb3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZXZlbnQsIC0xLCBjb250ZXh0KTsKICAgICAgfSk7CgogICAgICBjb250ZXh0Lm5hdmlnYXRpb24uJG5leHRJdGVtLmNsaWNrKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIG93bmVyLm9uQ2hhbmdlQ3VycmVudFNsaWRlKGV2ZW50LCAxLCBjb250ZXh0KTsKICAgICAgfSk7CgogICAgICAkbmF2TGlua3Mub24oImtleWRvd24iLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzd2l0Y2ggKGV2ZW50LmtleUNvZGUpIHsKICAgICAgICAgIGNhc2UgMzc6CiAgICAgICAgICAgIG93bmVyLm9uQ2hhbmdlQ3VycmVudFNsaWRlKGV2ZW50LCAtMSwgY29udGV4dCk7CiAgICAgICAgICAgICQodGhpcykucGFyZW50KCkuZmluZCgiLmFjdGl2ZSIpLmZvY3VzKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOToKICAgICAgICAgICAgb3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZXZlbnQsIDEsIGNvbnRleHQpOwogICAgICAgICAgICAkKHRoaXMpLnBhcmVudCgpLmZpbmQoIi5hY3RpdmUiKS5mb2N1cygpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQXR0YWNoZXMgcGF1c2UgZXZlbnQgdG8gbmF2aWdhdGlvbiB3cmFwcGVyLgogICAgICoKICAgICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgIGEgY29udGV4dCBvZiBhIFNsaWRlciBjbGFzcyBpbnN0YW5jZQogICAgICovCiAgICBmdW5jdGlvbiBhdHRhY2hQYXVzZUV2ZW50KGNvbnRleHQpIHsKICAgICAgdmFyIG93bmVyID0gY29udGV4dC5vd25lciwKICAgICAgICAkZWxlbWVudCA9IGNvbnRleHQuJHdyYXBwZXIsCiAgICAgICAgJG5hdkxpbmtzID0gJGVsZW1lbnQuZmluZCgiLm5hdiBhIik7CgogICAgICB2YXIgY2FsbGJhY2tNb3VzZWVudGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNvbnRleHQucHJldmVudFNjaGVkdWxpbmcgPSB0cnVlOwogICAgICAgIG93bmVyLmRlc2NoZWR1bGVTbGlkZShjb250ZXh0KTsKCiAgICAgICAgb3duZXIuZXhlY3V0ZU9uVGltZXJzKCJ1cGRhdGUiLCBjb250ZXh0KTsKICAgICAgICBpZiAoY29udGV4dC50aW1lSW5kaWNhdG9yICE9PSBudWxsKSB7CiAgICAgICAgICBjb250ZXh0LnRpbWVJbmRpY2F0b3IucGF1c2UoKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICAkZWxlbWVudC5tb3VzZWVudGVyKGNhbGxiYWNrTW91c2VlbnRlcik7CiAgICAgICRuYXZMaW5rcy5vbigiZm9jdXMiLCBjYWxsYmFja01vdXNlZW50ZXIpOwoKICAgICAgdmFyIGNhbGxiYWNrTW91c2VMZWF2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBjb250ZXh0LnByZXZlbnRTY2hlZHVsaW5nID0gZmFsc2U7CiAgICAgICAgb3duZXIuc2NoZWR1bGVTbGlkZShjb250ZXh0KTsKICAgICAgfTsKCiAgICAgICRlbGVtZW50Lm1vdXNlbGVhdmUoY2FsbGJhY2tNb3VzZUxlYXZlKTsKICAgICAgJG5hdkxpbmtzLm9uKCJibHVyIiwgY2FsbGJhY2tNb3VzZUxlYXZlKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgdGltZSBpbmRpY2F0b3IgdmlldwogICAgICoKICAgICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgIGEgY29udGV4dCBvZiBhIFNsaWRlciBjbGFzcyBpbnN0YW5jZQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVJbmRpY2F0b3IoY29udGV4dCkgewogICAgICB2YXIgc2V0dGluZ3MgPSBjb250ZXh0LnNldHRpbmdzLAogICAgICAgIHRpbWVJbmRpY2F0b3IgPSBudWxsLAogICAgICAgIFZpZXdDb25zdHJ1Y3RvciA9CiAgICAgICAgICBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvclZpZXdzW3NldHRpbmdzLnRpbWVJbmRpY2F0b3Iudmlld10sCiAgICAgICAgdmlldyA9IG51bGw7CgogICAgICBpZiAoVmlld0NvbnN0cnVjdG9yICE9PSBudWxsKSB7CiAgICAgICAgdmlldyA9IG5ldyBWaWV3Q29uc3RydWN0b3IoCiAgICAgICAgICBzZXR0aW5ncy50aW1lSW5kaWNhdG9yLnNlbGVjdG9yLAogICAgICAgICAgc2V0dGluZ3MudGltZUluZGljYXRvci5vcHRpb25zCiAgICAgICAgKTsKICAgICAgICB0aW1lSW5kaWNhdG9yID0gbmV3IFRpbWVJbmRpY2F0b3IoJCwgdmlldywgc2V0dGluZ3MudGltZW91dCk7CiAgICAgICAgY29udGV4dC50aW1lSW5kaWNhdG9yID0gdGltZUluZGljYXRvcjsKICAgICAgICBjb250ZXh0LnRpbWVycy5wdXNoKHRpbWVJbmRpY2F0b3IpOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBBdHRhY2hlcyBldmVudHMgdG8gbmF2aWdhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge1NsaWRlckNvbnRleHR9IGNvbnRleHQgICBhIGNvbnRleHQgb2YgYSBTbGlkZXIgY2xhc3MgaW5zdGFuY2UKICAgICAqLwogICAgZnVuY3Rpb24gaW5pdGlhbGl6ZU5hdmlnYXRpb24oY29udGV4dCkgewogICAgICBjb250ZXh0LnNldHRpbmdzLm5hdmlnYXRpb24uc2xpZGVzQ291bnQgPSBjb250ZXh0LiRzbGlkZXMubGVuZ3RoOwogICAgICBjb250ZXh0Lm5hdmlnYXRpb24gPSBuZXcgTmF2aWdhdGlvbigKICAgICAgICAkLAogICAgICAgIGNvbnRleHQuJHdyYXBwZXIsCiAgICAgICAgY29udGV4dC5zZXR0aW5ncy5uYXZpZ2F0aW9uCiAgICAgICk7CgogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBhdHRhY2hOYXZpZ2F0aW9uRXZlbnRzKGNvbnRleHQpOwogICAgICB9LCAxMDAwKTsKCiAgICAgIGlmIChjb250ZXh0LnNldHRpbmdzLmlzUGF1c2VFbmFibGVkKSB7CiAgICAgICAgYXR0YWNoUGF1c2VFdmVudChjb250ZXh0KTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogSW5pdGlhbGl6ZXMgdHJhbnNpdGlvbiBmb3IgYSBnaXZlbiBjb250ZXh0LgogICAgICoKICAgICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgIGEgY29udGV4dCBvZiBhIFNsaWRlciBjbGFzcyBpbnN0YW5jZQogICAgICovCiAgICBmdW5jdGlvbiBpbml0aWFsaXplVHJhbnNpdGlvbihjb250ZXh0KSB7CiAgICAgIHZhciBUcmFuc2l0aW9uQ29uc3RydWN0b3IgPSBudWxsLAogICAgICAgIG93bmVyID0gY29udGV4dC5vd25lcjsKCiAgICAgIGNvbnRleHQudHJhbnNpdGlvblNldHRpbmdzLmNhbGxiYWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNvbnRleHQuY2FuQ2hhbmdlU2xpZGUgPSB0cnVlOwoKICAgICAgICBpZiAoY29udGV4dC5wcmV2ZW50U2NoZWR1bGluZykgewogICAgICAgICAgb3duZXIuZXhlY3V0ZU9uVGltZXJzKCJyZXNldCIsIGNvbnRleHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvd25lci5zY2hlZHVsZVNsaWRlKGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIFRyYW5zaXRpb25Db25zdHJ1Y3RvciA9CiAgICAgICAgWEEuY29tcG9uZW50LmNhcm91c2Vscy5UcmFuc2l0aW9uc1tjb250ZXh0LnNldHRpbmdzLnRyYW5zaXRpb25dOwogICAgICBpZiAoCiAgICAgICAgVHJhbnNpdGlvbkNvbnN0cnVjdG9yID09PSBudWxsIHx8CiAgICAgICAgVHJhbnNpdGlvbkNvbnN0cnVjdG9yID09PSB1bmRlZmluZWQKICAgICAgKSB7CiAgICAgICAgVHJhbnNpdGlvbkNvbnN0cnVjdG9yID0KICAgICAgICAgIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuVHJhbnNpdGlvbnNbY29udGV4dC5kZWZhdWx0cy50cmFuc2l0aW9uXTsKICAgICAgfQogICAgICBjb250ZXh0LnRyYW5zaXRpb24gPSBuZXcgVHJhbnNpdGlvbkNvbnN0cnVjdG9yKCk7CiAgICAgIGNvbnRleHQudHJhbnNpdGlvbi5pbml0KGNvbnRleHQudHJhbnNpdGlvblNldHRpbmdzKTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAvKioKICAgICAgICogSW5pdGlhbGl6ZXMgU2xpZGVyIG9iamVjdCB3aXRoIGEgZ2l2ZW4gY29udGV4dC4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtTbGlkZXJDb250ZXh0fSBjb250ZXh0ICAgYSBjb250ZXh0IG9mIGEgU2xpZGVyIGNsYXNzIGluc3RhbmNlCiAgICAgICAqLwogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgIGluaXRpYWxpemVOYXZpZ2F0aW9uKGNvbnRleHQpOwogICAgICAgIGluaXRpYWxpemVUcmFuc2l0aW9uKGNvbnRleHQpOwoKICAgICAgICBpZiAoY29udGV4dC5zZXR0aW5ncy50aW1lSW5kaWNhdG9yLmlzRW5hYmxlZCkgewogICAgICAgICAgY3JlYXRlSW5kaWNhdG9yKGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfSwKICAgIH07CiAgfSkoJCk7CiAgLyoqCiAgICogZW5kIG9mIFNsaWRlckluaXRpYWxpemVyCiAgICovCgogIC8qKgogICAqIENhcm91c2VsIGNsYXNzIGRpc3BsYXlzIG9uZSBzbGlkZSAoc29tZSBjb250ZW50KSBhdCB0aGUgdGltZS4KICAgKiBJdHMgYmVoYXZpb3VyIGRlcGVuZHMgb24gc2V0dGluZ3MgKHBhc3NlZCB0byBpbml0KCkgbWV0aG9kKS4KICAgKiBGb3IgbW9yZSBkZXRhaWxzIEBzZWUgU2xpZGVyLCBAc2VlIFNsaWRlckluaXRpYWxpemVyLCBAc2VlIE5hdmlnYXRpb24sCiAgICogQHNlZSBOYXZpZ2F0aW9uQnVpbGRlciwgQHNlZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zLlRyYW5zaXRpb24sCiAgICogQHNlZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvclZpZXdzLlZpZXcKICAgKgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIENhcm91c2VsKCkgewogICAgdmFyIGNvbnRleHQgPSB0aGlzOwoKICAgIC8qKgogICAgICogSW5zdGFuY2Ugb2YgYSBTbGlkZXIgY2xhc3MgKEBzZWUgU2xpZGVyKS4KICAgICAqCiAgICAgKiBAbWVtYmVyIENhcm91c2VsCiAgICAgKi8KICAgIHRoaXMuc2xpZGVyID0gbnVsbDsKICAgIC8qKgogICAgICogRGlzcGxheWVkIHNsaWRlIChqUXVlcnkgb2JqZWN0KS4KICAgICAqCiAgICAgKiBAbWVtYmVyIENhcm91c2VsCiAgICAgKi8KICAgIHRoaXMuJGN1cnJlbnRTbGlkZSA9IG51bGw7CiAgICAvKioKICAgICAqIEFsbCBzbGlkZXMgKGpRdWVyeSBvYmplY3QpLgogICAgICoKICAgICAqIEBtZW1iZXIgQ2Fyb3VzZWwKICAgICAqLwogICAgdGhpcy4kc2xpZGVzID0gbnVsbDsKCiAgICAvKioKICAgICAqIENoYW5nZXMgY3VycmVudCBzbGlkZSB0byBhICRuZXdTbGlkZS4KICAgICAqCiAgICAgKiBAbWVtYmVyIENhcm91c2VsCiAgICAgKiBAcGFyYW0ge09iamVjdH0gJG5ld1NsaWRlICB0aGUgbmV3IHNsaWRlIChqUXVlcnkpIG9iamVjdC4KICAgICAqLwogICAgdGhpcy5jaGFuZ2VDdXJyZW50U2xpZGUgPSBmdW5jdGlvbiAoJG5ld1NsaWRlKSB7CiAgICAgIGNvbnRleHQuJGN1cnJlbnRTbGlkZSA9ICRuZXdTbGlkZTsKICAgICAgY29udGV4dC5zbGlkZXIuc2VsZWN0TmF2aWdhdGlvbkl0ZW0oJG5ld1NsaWRlLmluZGV4KCkpOwogICAgfTsKCiAgICAvKioKICAgICAqIFJldHVybnMgY3VycmVudCBzbGlkZS4KICAgICAqCiAgICAgKiBAbWVtYmVyIENhcm91c2VsCiAgICAgKiBAcmV0dXJuIGN1cnJlbnQgc2xpZGUgKGpRdWVyeSkgb2JqZWN0LgogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKi8KICAgIHRoaXMuZ2V0Q3VycmVudFNsaWRlID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gY29udGV4dC4kY3VycmVudFNsaWRlOwogICAgfTsKCiAgICB0aGlzLmRhdGEgPSB7fTsKICB9CgogIC8qKgogICAqIFJlc2V0cyB0aGUgY2Fyb3VzZWwuCiAgICoKICAgKiBAbWVtYmVyIENhcm91c2VsCiAgICovCiAgQ2Fyb3VzZWwucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy4kc2xpZGVzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAkKHRoaXMpLmhpZGUoKTsKICAgIH0pOwoKICAgIHRoaXMuY2hhbmdlQ3VycmVudFNsaWRlKHRoaXMuJHNsaWRlcy5maXJzdCgpKTsKICAgIHRoaXMuJGN1cnJlbnRTbGlkZS5zaG93KCk7CiAgfTsKCiAgLyoqCiAgICogSW5pdGlhbGl6ZXMgdGhlIGNhcm91c2VsLgogICAqIFdyYXBwcyBjYXJvdXNlbCBjb250ZW50IHdpdGggPGRpdiBjbGFzcz0id3JhcHBlciIgLz4gZWxlbWVudCwKICAgKiBzZWxlY3RzIHNsaWRlcyAoPGxpIC8+IGVsZW1lbnRzKSBmcm9tIDx1bCBjbGFzcz0ic2xpZGVzIiAvPiBlbGVtZW50LAogICAqIGluaXRpYWxpemVzIFNsaWRlciBjbGFzcyBpbmN0YW5jZSwgcmVzZXRzIHRoZSBjYXJvdXNlbCBhbmQgc3RhcnQgYXV0b21hdGljIHNsaWRlcyBjaGFuZ2luZy4KICAgKgogICAqIEBtZW1iZXIgQ2Fyb3VzZWwKICAgKiBAcGFyYW0ge09iamVjdH0gJGNvbnRhaW5lciAgICAgalF1ZXJ5IG9iamVjdCB3aXRoIGEgbWFpbiBodG1sIGVsZW1lbnQgb2YgdGhlIGNhcm91c2VsCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgICAgIGNhcm91c2VsIG9wdGlvbnMgb2JqZWN0CiAgICovCiAgQ2Fyb3VzZWwucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoJGNvbnRhaW5lciwgb3B0aW9ucykgewogICAgdmFyICR3cmFwcGVyID0gJCgiPGRpdi8+IiwgewogICAgICAgIGNsYXNzOiAid3JhcHBlciIsCiAgICAgIH0pLAogICAgICBzbGlkZXJDb250ZXh0ID0gbnVsbDsKCiAgICAkd3JhcHBlci5hcHBlbmQoJGNvbnRhaW5lci5jaGlsZHJlbigpLmRldGFjaCgpKTsKICAgICRjb250YWluZXIuYXBwZW5kKCR3cmFwcGVyKTsKICAgIHRoaXMuJHNsaWRlcyA9ICRjb250YWluZXIuZmluZCgiLnNsaWRlcyBsaS5zbGlkZSIpOwoKICAgIHNsaWRlckNvbnRleHQgPSBuZXcgU2xpZGVyQ29udGV4dCgpOwogICAgc2xpZGVyQ29udGV4dC5jaGFuZ2VDdXJyZW50U2xpZGUgPSB0aGlzLmNoYW5nZUN1cnJlbnRTbGlkZTsKICAgIHNsaWRlckNvbnRleHQuZ2V0Q3VycmVudFNsaWRlID0gdGhpcy5nZXRDdXJyZW50U2xpZGU7CiAgICBzbGlkZXJDb250ZXh0LiRzbGlkZXMgPSB0aGlzLiRzbGlkZXM7CiAgICBzbGlkZXJDb250ZXh0LiR3cmFwcGVyID0gJHdyYXBwZXI7CgogICAgdGhpcy5zbGlkZXIgPSBuZXcgU2xpZGVyKCQsIHNsaWRlckNvbnRleHQsIG9wdGlvbnMpOwogICAgU2xpZGVySW5pdGlhbGl6ZXIuaW5pdGlhbGl6ZShzbGlkZXJDb250ZXh0KTsKCiAgICB0aGlzLnJlc2V0KCk7CiAgICB0aGlzLnNsaWRlci5ydW4oKTsKICB9OwogIC8qKgogICAqIGVuZCBvZiBDYXJvdXNlbCBjbGFzcwogICAqLwoKICAvKioKICAgKiBSZWdpc3RlcnMgZWFjaCBlbGVtZW50cyB0aGF0IG1hdGNoIHRoZSBwcm92aWRlZCBzZWxlY3RvciBhcyBhIGNhcm91c2VsIHdpdGggYSBnaXZlbiBvcHRpb25zLgogICAqIENhcm91c2VsIG9wdGlvbnMgb2JqZWN0IDoKICAgKiB7CiAgICogICAgIC8vCiAgICogICAgIC8vIG5hdmlnYXRpb246IE9iamVjdAogICAqICAgICAvLwogICAqICAgICAvLyBUaGUgbmF2aWdhdGlvbiBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgKiAgICAgLy8KICAgKiAgICAgJ25hdmlnYXRpb24nOiB7CiAgICogICAgICAgICAvLwogICAqICAgICAgICAgLy9pc0VuYWJsZWQ6IEJvb2xlYW4KICAgKiAgICAgICAgIC8vCiAgICogICAgICAgICAvLyBTZXRzIHdoZXRoZXIgdGhlIG5hdmlnYXRpb24gaXMgZW5hYmxlZC4KICAgKiAgICAgICAgIC8vCiAgICogICAgICAgICAnaXNFbmFibGVkJzogdHJ1ZSwKICAgKiAgICAgICAgIC8vCiAgICogICAgICAgICAvLyBoYXNQcmV2TmV4dEl0ZW1zOiBCb29sZWFuCiAgICogICAgICAgICAvLwogICAqICAgICAgICAgLy8gU2V0cyB3aGV0aGVyIHRoZSBuYXZpZ2F0aW9uIGhhcyBwcmV2aW91cyBhbmQgbmV4dCBidXR0b25zLgogICAqICAgICAgICAgLy8KICAgKiAgICAgICAgICdoYXNQcmV2TmV4dEl0ZW1zJzogdHJ1ZSwKICAgKiAgICAgICAgIC8vCiAgICogICAgICAgICAvLyBpdGVtOiBPYmplY3QKICAgKiAgICAgICAgIC8vCiAgICogICAgICAgICAvLyBOYXZpZ2F0aW9uIGl0ZW0gY29uZmlndXJhdGlvbiBvYmplY3QuCiAgICogICAgICAgICAvLwogICAqICAgICAgICAgJ2l0ZW0nOiB7CiAgICogICAgICAgICAgICAgLy8KICAgKiAgICAgICAgICAgICAvLyBsYWJlbDogU3RyaW5nCiAgICogICAgICAgICAgICAgLy8KICAgKiAgICAgICAgICAgICAvLyBMYWJlbCB0ZW1wbGF0ZTsgZWFjaCAnI3tpbmRleH0nIHN0cmluZyB3aWxsIGJlIHJlcGxhY2VkIGJ5IHRoZSBudW1iZXIgb2YgYSBzbGlkZS4KICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgICdsYWJlbCc6ICcje2luZGV4fScsCiAgICogICAgICAgICAgICAgLy8KICAgKiAgICAgICAgICAgICAvLyBzZWxlY3RvcjogU3RyaW5nCiAgICogICAgICAgICAgICAgLy8KICAgKiAgICAgICAgICAgICAvLyBOYXZpZ2F0aW9uIGl0ZW1zIGNvbnRhaW5lciBzZWxlY3RvcjsgaWYgZXF1YWxzIG51bGwsIHRoZSBjb250YWluZXIgd2lsbCBiZSBnZW5lcmF0ZWQKICAgKiAgICAgICAgICAgICAvLyAoJ2RpdicgZWxlbWVudCB3aXRoICduYXYnIGNsYXNzIGF0dHJpYnV0ZSBpbnNpZGUgdGhlIGNhcm91c2VsKS4KICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgICdzZWxlY3Rvcic6IG51bGwKICAgKiAgICAgICAgfSwKICAgKiAgICAgICAgIC8vCiAgICogICAgICAgICAvLyBwcmV2SXRlbTogT2JqZWN0CiAgICogICAgICAgICAvLwogICAqICAgICAgICAgLy8gTmF2aWdhdGlvbiAncHJldmlvdXMgaXRlbScgY29uZmlndXJhdGlvbiBvYmplY3QuCiAgICogICAgICAgICAvLwogICAqICAgICAgICAgJ3ByZXZJdGVtJzogewogICAqICAgICAgICAgICAgIC8vCiAgICogICAgICAgICAgICAgLy8gbGFiZWw6IFN0cmluZwogICAqICAgICAgICAgICAgIC8vCiAgICogICAgICAgICAgICAgLy8gVGhlICdwcmV2aW91cyBpdGVtJyBsYWJlbC4KICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgICdsYWJlbCc6ICc8JywKICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgIC8vIHNlbGVjdG9yOiBTdHJpbmcKICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgIC8vIE5hdmlnYXRpb24gJ3ByZXZpb3VzIGl0ZW0nIHNlbGVjdG9yOyBpZiBlcXVhbHMgbnVsbCwgdGhlIGl0ZW0gd2lsbCBiZSBnZW5lcmF0ZWQKICAgKiAgICAgICAgICAgICAvLyAoJ2EnIGVsZW1lbnQgd2l0aCAncHJldicgY2xhc3MgYXR0cmlidXRlIGluc2lkZSB0aGUgbmF2aWdhdGlvbiBjb250YWluZXIpLgogICAqICAgICAgICAgICAgIC8vCiAgICogICAgICAgICAgICAgJ3NlbGVjdG9yJzogbnVsbCwKICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgIC8vIGlzQ29udGFpbmVyOiBCb29sZWFuCiAgICogICAgICAgICAgICAgLy8KICAgKiAgICAgICAgICAgICAvLyBTZXRzIHdoZXRoZXIgdGhlIGVsZW1lbnQgZm91bmQgYnkgc2VsZWN0b3Igc2hvdWxkIGJlIHRyZWF0ZWQgYXMgYSBjb250YWluZXIgKGlmIHRydWUpCiAgICogICAgICAgICAgICAgLy8gb3Igc2hvdWxkIGJlIGFkb3B0ZWQgYXMgYSAncHJldmlvdXMgaXRlbScgKGlmIGZhbHNlKS4gSWYgc2VsZWN0b3IgZXF1YWxzIG51bGwgdGhpcyBwcm9wZXJ0eSBpcyBtZWFuaW5nbGVzcy4KICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgICdpc0NvbnRhaW5lcic6IGZhbHNlCiAgICogICAgICAgICB9LAogICAqICAgICAgICAgLy8KICAgKiAgICAgICAgIC8vIG5leHRJdGVtOiBPYmplY3QKICAgKiAgICAgICAgIC8vCiAgICogICAgICAgICAvLyBOYXZpZ2F0aW9uICduZXh0IGl0ZW0nIGNvbmZpZ3VyYXRpb24gb2JqZWN0LgogICAqICAgICAgICAgLy8KICAgKiAgICAgICAgICduZXh0SXRlbSc6IHsKICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgIC8vIGxhYmVsOiBTdHJpbmcKICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgIC8vIFRoZSAnbmV4dCBpdGVtJyBsYWJlbC4KICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgICdsYWJlbCc6ICc+JywKICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgIC8vIHNlbGVjdG9yOiBTdHJpbmcKICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgIC8vIE5hdmlnYXRpb24gJ25leHQgaXRlbScgc2VsZWN0b3I7IGlmIGVxdWFscyBudWxsLCB0aGUgaXRlbSB3aWxsIGJlIGdlbmVyYXRlZAogICAqICAgICAgICAgICAgIC8vICgnYScgZWxlbWVudCB3aXRoICduZXh0JyBjbGFzcyBhdHRyaWJ1dGUgaW5zaWRlIHRoZSBuYXZpZ2F0aW9uIGNvbnRhaW5lcikuCiAgICogICAgICAgICAgICAgLy8KICAgKiAgICAgICAgICAgICAnc2VsZWN0b3InOiBudWxsLAogICAqICAgICAgICAgICAgIC8vCiAgICogICAgICAgICAgICAgLy8gaXNDb250YWluZXI6IEJvb2xlYW4KICAgKiAgICAgICAgICAgICAvLwogICAqICAgICAgICAgICAgIC8vIFNldHMgd2hldGhlciB0aGUgZWxlbWVudCBmb3VuZCBieSBzZWxlY3RvciBzaG91bGQgYmUgdHJlYXRlZCBhcyBhIGNvbnRhaW5lciAoaWYgdHJ1ZSkKICAgKiAgICAgICAgICAgICAvLyBvciBzaG91bGQgYmUgYWRvcHRlZCBhcyBhICduZXh0IGl0ZW0nIChpZiBmYWxzZSkuIElmIHNlbGVjdG9yIGVxdWFscyBudWxsIHRoaXMgcHJvcGVydHkgaXMgbWVhbmluZ2xlc3MuCiAgICogICAgICAgICAgICAgLy8KICAgKiAgICAgICAgICAgICAnaXNDb250YWluZXInOiBmYWxzZQogICAqICAgICAgICAgfQogICAqICAgICB9LAogICAqICAgICAvLwogICAqICAgICAvLyB0aW1lb3V0OiBOdW1iZXIKICAgKiAgICAgLy8KICAgKiAgICAgLy8gVGhlIGludGVydmFsIGJldHdlZW4gdGhlIHNsaWRlcyBpbiBtaWxpc2Vjb25kcy4KICAgKiAgICAgLy8KICAgKiAgICAgJ3RpbWVvdXQnOiAxMDAwMCwKICAgKiAgICAgLy8KICAgKiAgICAgLy8gdHJhbnNpdGlvbjogU3RyaW5nCiAgICogICAgIC8vCiAgICogICAgIC8vIE5hbWUgb2YgdGhlIHRyYW5zaXRpb24gY2xhc3MsIHdoaWNoIHdpbGwgYmUgdXNlZC4gUG9zc2libGUgdmFsdWVzIGFyZToKICAgKiAgICAgLy8gLSBCYXNpY1RyYW5zaXRpb24gLSB3aXRob3V0IGFueSBhbmltYXRpb24sCiAgICogICAgIC8vIC0gRmFkZUluVHJhbnNpdGlvbiAtIG5ldyBzbGlkZSBmYWRlcyBpbiwKICAgKiAgICAgLy8gLSBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24gLSBuZXcgc2xpZGUgbW92ZXMgZnJvbSByaWdodCAoZnJvbSBsZWZ0IGlmIHVzZXIgc2VsZWN0cyBzbGlkZSB3aXRoIGxvd2VyIGlkIG9yIGNsaWNrcyBvbiAncHJldmlvdXMgaXRlbScpLAogICAqICAgICAvLyAtIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24gLSBuZXcgc2xpZGUgbW92ZXMgZnJvbSB0b3AgKGZyb20gYm90dG9tIGlmIHVzZXIgc2VsZWN0cyBzbGlkZSB3aXRoIGxvd2VyIGlkIG9yIGNsaWNrcyBvbiAncHJldmlvdXMgaXRlbScpLAogICAqICAgICAvLyAtIG90aGVyIC0gaWYgaW1wbGVtZW50ZWQgKGRlcml2ZWQgZnJvbSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zLlRyYW5zaXRpb24gY2xhc3MpIGFuZCBhZGRlZCB0byBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zIG1vZHVsZS4KICAgKiAgICAgLy8KICAgKiAgICAgJ3RyYW5zaXRpb24nOiAnQmFzaWNUcmFuc2l0aW9uJywKICAgKiAgICAgLy8KICAgKiAgICAgLy8gaXNQYXVzZUVuYWJsZWQ6IEJvb2xlYW4KICAgKiAgICAgLy8KICAgKiAgICAgLy8gU2V0cyB3aGV0aGVyIHRoZSBwYXVzZSBmZWF0dXJlIGlzIGVuYWJsZWQuCiAgICogICAgIC8vIFBhdXNlIGZlYXR1cmUgcGF1c2VzIGNvdW50ZG93biBvZiBjaGFuZ2luZyBzbGlkZXMsIHdoZW4gbW91c2UgaXMgaW4gYSBjYXJvdXNlbCBhcmVhLgogICAqICAgICAvLwogICAqICAgICAnaXNQYXVzZUVuYWJsZWQnOiB0cnVlLAogICAqICAgICAvLwogICAqICAgICAvLyB0aW1lSW5kaWNhdG9yOiBPYmplY3QKICAgKiAgICAgLy8KICAgKiAgICAgLy8gJ1RpbWUgaW5kaWNhdG9yJyBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgKiAgICAgLy8KICAgKiAgICAgJ3RpbWVJbmRpY2F0b3InOiB7CiAgICogICAgICAgICAvLwogICAqICAgICAgICAgLy8gaXNFbmFibGVkOiBCb29sZWFuCiAgICogICAgICAgICAvLwogICAqICAgICAgICAgLy8gU2V0cyB3aGV0aGVyIHRoZSAndGltZSBpbmRpY2F0b3InIGlzIGVuYWJsZWQuCiAgICogICAgICAgICAvLwogICAqICAgICAgICAgJ2lzRW5hYmxlZCc6IGZhbHNlLAogICAqICAgICAgICAgLy8KICAgKiAgICAgICAgIC8vIHNlbGVjdG9yOiBTdHJpbmcKICAgKiAgICAgICAgIC8vCiAgICogICAgICAgICAvLyAnVGltZSBpbmRpY2F0b3InIHNlbGVjdG9yLgogICAqICAgICAgICAgLy8KICAgKiAgICAgICAgICdzZWxlY3Rvcic6IG51bGwsCiAgICogICAgICAgICAvLwogICAqICAgICAgICAgLy8gdmlldzogU3RyaW5nCiAgICogICAgICAgICAvLwogICAqICAgICAgICAgLy8gTmFtZSBvZiB0aGUgdmlldyBjbGFzcywgd2hpY2ggd2lsbCBiZSB1c2VkLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOgogICAqICAgICAgICAgLy8gLSBWaWV3IC0gd2l0aG91dCBhbnkgYW5pbWF0aW9uIChiYXNlIGNsYXNzKSwKICAgKiAgICAgICAgIC8vIC0gUHJvZ3Jlc3NCYXJWaWV3IC0gc2hvd3MgdGhlIHByb2dyZXNzIG9mIHRpbWUgYXMgcHJvZ3Jlc3MgYmFyLAogICAqICAgICAgICAgLy8gLSBSb3RhdG9yVmlldyAtIHNob3dzIHRoZSBwcm9ncmVzcyBvZiB0aW1lIHdpdGggdGhlIGZpbGxpbmcgdXAgcmluZwogICAqICAgICAgICAgLy8gLSBvdGhlciAtIGlmIGltcGxlbWVudGVkIChkZXJpdmVkIGZyb20gWEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3cy5WaWV3IGNsYXNzKSBhbmQgYWRkZWQgdG8gWEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3cyBtb2R1bGUuCiAgICogICAgICAgICAvLwogICAqICAgICAgICAgJ3ZpZXcnOiAnVmlldycsCiAgICogICAgICAgICAvLwogICAqICAgICAgICAgLy8gb3B0aW9uczogT2JqZWN0CiAgICogICAgICAgICAvLwogICAqICAgICAgICAgLy8gJ1RpbWUgaW5kaWNhdG9yJyB2aWV3IHNldHRpbmdzIG9iamVjdC4gRGVwZW5kcyBvbiB2aWV3LgogICAqICAgICAgICAgLy8KICAgKiAgICAgICAgICdvcHRpb25zJzoge30KICAgKiAgICAgfQogICAqIH0KICAgKi8KCiAgLyogcHViLnJlZ2lzdGVyID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBvcHRpb25zKSB7CiAgICAgdmFyICRjYXJvdXNlbHMgPSAkKHNlbGVjdG9yKTsKICAgICAkY2Fyb3VzZWxzLmVhY2goZnVuY3Rpb24gKCkgewogICAgIC8vdmFyIGNhcm91c2VsID0gbmV3IENhcm91c2VsKCQpOwogICAgIGNvbnNvbGUubG9nKCQodGhpcykpOwogICAgIC8vY2Fyb3VzZWwuaW5pdCgkKHRoaXMpLCBvcHRpb25zKTsKICAgICB9KTsKICAgICB9OyovCgogIC8qIENhcm91c2VsIHRvdWNoIHN1cHBvcnQgKi8KICBDYXJvdXNlbC5wcm90b3R5cGUuc3dpcGVTbGlkZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciAkd3JhcHBlciA9IHRoaXMuc2xpZGVyLmNvbnRleHQuJHdyYXBwZXIsCiAgICAgIHN3aXBlciA9IG5ldyBTd2lwZXIoJHdyYXBwZXJbMF0pOwoKICAgIHN3aXBlci5vblN3aXBlTGVmdCgoZSkgPT4KICAgICAgdGhpcy5zbGlkZXIuY29udGV4dC5vd25lci5vbkNoYW5nZUN1cnJlbnRTbGlkZShlLCAxLCB0aGlzLnNsaWRlci5jb250ZXh0KQogICAgKTsKICAgIHN3aXBlci5vblN3aXBlUmlnaHQoKGUpID0+CiAgICAgIHRoaXMuc2xpZGVyLmNvbnRleHQub3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZSwgLTEsIHRoaXMuc2xpZGVyLmNvbnRleHQpCiAgICApOwogIH07CgogIENhcm91c2VsLnByb3RvdHlwZS5kaXNhYmxlRW1wdHlTbGlkZXMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZW1wdHlQbGFjZWhvbGRlcnMgPSB0aGlzLiRzbGlkZXMuZmluZCgiLnNjRW1wdHlQbGFjZWhvbGRlciIpLAogICAgICBwbGFjZWhvbGRlckNvZGVUYWcsCiAgICAgICRwbGFjZWhvbGRlciwKICAgICAgcGxhY2Vob2xkZXJJZCwKICAgICAgcGxhY2Vob2xkZXJLZXksCiAgICAgIGVkaXRGcmFtZSwKICAgICAgY2hyb21lS2V5LAogICAgICBoOwoKICAgIF8uZWFjaChlbXB0eVBsYWNlaG9sZGVycywgZnVuY3Rpb24gKHBsYWNlaG9sZGVyKSB7CiAgICAgICRwbGFjZWhvbGRlciA9ICQocGxhY2Vob2xkZXIpOwogICAgICBwbGFjZWhvbGRlcklkID0gJHBsYWNlaG9sZGVyLmF0dHIoInNjLXBsYWNlaG9sZGVyLWlkIik7CgogICAgICAvL2Rpc2FibGUgZWRpdCBmcmFtZXMKICAgICAgcGxhY2Vob2xkZXJDb2RlVGFnID0gJHBsYWNlaG9sZGVyLnNpYmxpbmdzKAogICAgICAgICJjb2RlW2Nocm9tZXR5cGU9J3BsYWNlaG9sZGVyJ11baWQ9JyIgKyBwbGFjZWhvbGRlcklkICsgIiddIgogICAgICApOwogICAgICB0cnkgewogICAgICAgIHBsYWNlaG9sZGVyS2V5ID0gcGxhY2Vob2xkZXJDb2RlVGFnLmF0dHIoImtleSIpOwogICAgICAgIGlmICh0eXBlb2YgcGxhY2Vob2xkZXJLZXkgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICBlZGl0RnJhbWUgPSBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lTWFuYWdlci5jaHJvbWVzKCkuZmlsdGVyKAogICAgICAgICAgICBmdW5jdGlvbiAoY2hyb21lKSB7CiAgICAgICAgICAgICAgY2hyb21lS2V5ID0gY2hyb21lLm9wZW5pbmdNYXJrZXIoKTsKICAgICAgICAgICAgICBpZiAoIWNocm9tZUtleSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2hyb21lS2V5ID0gY2hyb21lS2V5LmF0dHIoImtleSIpOwogICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICB0eXBlb2YgY2hyb21lS2V5ICE9PSAidW5kZWZpbmVkIiAmJgogICAgICAgICAgICAgICAgY2hyb21lS2V5LmluZGV4T2YocGxhY2Vob2xkZXJLZXkpID09PSAwCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgKTsKCiAgICAgICAgICBlZGl0RnJhbWVbMF0udHlwZS5jaHJvbWUuZGF0YS5jdXN0b20uZWRpdGFibGUgPSAiZmFsc2UiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyA2NjY7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgLy9mYWxsYmFjayAtIGRlbGV0ZSBjb2RlIHRhZ3MgdG8gcHJldmVudCBpbnNlcnRpbmcgaW50byBwbGFjZWhvbGRlcnMKICAgICAgICAkcGxhY2Vob2xkZXIuc2libGluZ3MoImNvZGVbY2hyb21ldHlwZT0ncGxhY2Vob2xkZXInXSIpLnJlbW92ZSgpOwogICAgICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUgKi8KICAgICAgICBjb25zb2xlLmxvZygiQ291bGQgbm90IGRpc2FibGUgZWRpdGluZyBmb3IgcGxhY2Vob2xkZXIiLCBlKTsKICAgICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLWNvbnNvbGUgKi8KICAgICAgfQoKICAgICAgLy9hZGp1c3QgaGVpZ2h0LCBhbmQgcmVtb3ZlIHBsYWNlaG9sZGVyICJkYXNoZWQiIGJhY2tncm91bmQKICAgICAgaCA9ICRwbGFjZWhvbGRlci5oZWlnaHQoKSArICJweCI7CiAgICAgICRwbGFjZWhvbGRlci5yZW1vdmVDbGFzcygic2NFbXB0eVBsYWNlaG9sZGVyIik7CiAgICAgICRwbGFjZWhvbGRlci5jc3MoImhlaWdodCIsIGgpOwoKICAgICAgLy9zZXQgZWRpdCBoZXJlIHRleHQKICAgICAgJHBsYWNlaG9sZGVyLmFwcGVuZCgkKCI8cD5bTm8gY29tcG9uZW50cyBpbiBzbGlkZV08L3A+IikpOwogICAgfSk7CiAgfTsKCiAgQ2Fyb3VzZWwucHJvdG90eXBlLnJlc2l6ZVdyYXBwZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcGFnZUhlaWdodCA9ICQoZG9jdW1lbnQpLm91dGVySGVpZ2h0KCksCiAgICAgIGhlYWRlckhlaWdodCA9ICQoIiNoZWFkZXIiKS5vdXRlckhlaWdodCgpLAogICAgICBjb250ZW50UGFkZGluZ1RvcCA9IHBhcnNlSW50KCQoIiNjb250ZW50IikuY3NzKCJwYWRkaW5nLXRvcCIpLCAxMCksCiAgICAgIGNvbnRlbnRQYWRkaW5nQm90dG9tID0gcGFyc2VJbnQoJCgiI2NvbnRlbnQiKS5jc3MoInBhZGRpbmctYm90dG9tIiksIDEwKSwKICAgICAgY29udGVudFBhZGRpbmcgPSBjb250ZW50UGFkZGluZ1RvcCArIGNvbnRlbnRQYWRkaW5nQm90dG9tLAogICAgICBmb290ZXJIZWlnaHQgPSAkKCIjZm9vdGVyIikub3V0ZXJIZWlnaHQoKSwKICAgICAgd3JhcHBlciA9IHRoaXMuc2xpZGVyLmNvbnRleHQuJHdyYXBwZXIsCiAgICAgIGNhcm91c2VsSGVpZ2h0ID0gMDsKCiAgICBjYXJvdXNlbEhlaWdodCA9CiAgICAgIHBhZ2VIZWlnaHQgLSAoaGVhZGVySGVpZ2h0ICsgZm9vdGVySGVpZ2h0ICsgY29udGVudFBhZGRpbmcpOwoKICAgIHdyYXBwZXIuY3NzKHsKICAgICAgaGVpZ2h0OiBjYXJvdXNlbEhlaWdodCwKICAgIH0pOwoKICAgIHdyYXBwZXIuZmluZCgiLnNsaWRlcyIpLmNzcyh7CiAgICAgIGhlaWdodDogY2Fyb3VzZWxIZWlnaHQsCiAgICB9KTsKICB9OwoKICBwdWIuaW5pdCA9IGZ1bmN0aW9uICgpIHsKICAgICQoIi5jYXJvdXNlbDpub3QoLmluaXRpYWxpemVkKSIpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICB2YXIgcHJvcGVydGllcyA9ICQodGhpcykuZGF0YSgicHJvcGVydGllcyIpLAogICAgICAgIGNvbXBvbmVudCA9ICQodGhpcykuZmluZCgiLmNhcm91c2VsLWlubmVyIiksCiAgICAgICAgaWQgPSBjb21wb25lbnQuYXR0cigiZGF0YS1pZCIpLAogICAgICAgIHNlbGYgPSB0aGlzLAogICAgICAgIHF1ZXJ5U2xpZGVJbmRleCA9IE51bWJlci5wYXJzZUludCgKICAgICAgICAgIFhBLnF1ZXJ5U3RyaW5nLmdldFF1ZXJ5UGFyYW0oCiAgICAgICAgICAgIGNvbXBvbmVudC5jbG9zZXN0KCIuY29tcG9uZW50LmNhcm91c2VsIikuYXR0cigiaWQiKSB8fCAiY2Fyb3VzZWwiCiAgICAgICAgICApCiAgICAgICAgKSwKICAgICAgICB2YWxpZFF1ZXJ5UGFyYW0gPQogICAgICAgICAgdHlwZW9mIHF1ZXJ5U2xpZGVJbmRleCAhPT0gInVuZGVmaW5lZCIgJiYKICAgICAgICAgICFOdW1iZXIuaXNOYU4ocXVlcnlTbGlkZUluZGV4KSAmJgogICAgICAgICAgcXVlcnlTbGlkZUluZGV4IDwgY29tcG9uZW50LmZpbmQoIi5zeGEtbnVtYmVycyIpLmxlbmd0aCwKICAgICAgICBjb250ZXh0LAogICAgICAgIHNldHRpbmdzLAogICAgICAgICRjdXJyZW50U2xpZGUsCiAgICAgICAgJHNsaWRlczsKCiAgICAgIGlmIChwcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKCFwcm9wZXJ0aWVzLm5hdmlnYXRpb24pIHsKICAgICAgICAgIHByb3BlcnRpZXMubmF2aWdhdGlvbiA9IHsKICAgICAgICAgICAgaXRlbToge30sCiAgICAgICAgICAgIHByZXZJdGVtOiB7fSwKICAgICAgICAgICAgbmV4dEl0ZW06IHt9LAogICAgICAgICAgICBpc0VuYWJsZWQ6IHZhbGlkUXVlcnlQYXJhbSA/IGZhbHNlIDogdHJ1ZSwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHByb3BlcnRpZXMubmF2aWdhdGlvbi5pdGVtLnNlbGVjdG9yID0KICAgICAgICAgICJbZGF0YS1pZD0nIiArIGlkICsgIiddIC5uYXYtaXRlbXMiOyAvL3Byb3BlcnRpZXMubmF2aWdhdGlvbi5pdGVtLnNlbGVjdG9yOwogICAgICAgIHByb3BlcnRpZXMubmF2aWdhdGlvbi5wcmV2SXRlbS5zZWxlY3RvciA9ICIjIiArIGlkICsgIiAubmF2IjsKICAgICAgICBwcm9wZXJ0aWVzLm5hdmlnYXRpb24ubmV4dEl0ZW0uc2VsZWN0b3IgPSAiIyIgKyBpZCArICIgLm5hdiI7CgogICAgICAgIHZhciBjYXJvdXNlbCA9IG5ldyBDYXJvdXNlbCgkKTsKICAgICAgICBjYXJvdXNlbC5pbml0KGNvbXBvbmVudCwgcHJvcGVydGllcyk7CgogICAgICAgICQod2luZG93KS5vbigibG9hZCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICgkKHNlbGYpLmhhc0NsYXNzKCJjYXJvdXNlbC1jbGllbnRzIikpIHsKICAgICAgICAgICAgY2Fyb3VzZWwucmVzaXplV3JhcHBlcigpOwogICAgICAgICAgfQogICAgICAgICAgY2Fyb3VzZWwuZGlzYWJsZUVtcHR5U2xpZGVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIGlmICh2YWxpZFF1ZXJ5UGFyYW0pIHsKICAgICAgICAgIChjb250ZXh0ID0gY2Fyb3VzZWwuc2xpZGVyLmNvbnRleHQpLAogICAgICAgICAgICAoc2V0dGluZ3MgPSBjb250ZXh0LnRyYW5zaXRpb25TZXR0aW5ncyksCiAgICAgICAgICAgICgkY3VycmVudFNsaWRlID0gY29udGV4dC5nZXRDdXJyZW50U2xpZGUoKSksCiAgICAgICAgICAgICgkc2xpZGVzID0gY29udGV4dC4kc2xpZGVzKTsKCiAgICAgICAgICBjb250ZXh0LmNhbkNoYW5nZVNsaWRlID0gZmFsc2U7CiAgICAgICAgICBzZXR0aW5ncy4kY3VycmVudFNsaWRlID0gJGN1cnJlbnRTbGlkZTsKICAgICAgICAgIHNldHRpbmdzLiRuZXh0U2xpZGUgPSAkKCRzbGlkZXNbcXVlcnlTbGlkZUluZGV4XSk7CgogICAgICAgICAgY29udGV4dC5jaGFuZ2VDdXJyZW50U2xpZGUoc2V0dGluZ3MuJG5leHRTbGlkZSk7CiAgICAgICAgICBjb250ZXh0LnRyYW5zaXRpb24ucGVyZm9ybShjb250ZXh0LnRyYW5zaXRpb25TZXR0aW5ncyk7CiAgICAgICAgICBjb250ZXh0Lm93bmVyLmV4ZWN1dGVPblRpbWVycygicmVzZXQiLCBjb250ZXh0KTsKCiAgICAgICAgICBjb250ZXh0Lm5hdmlnYXRpb24ucHJlcGFyZUl0ZW1zKAogICAgICAgICAgICBwcm9wZXJ0aWVzLm5hdmlnYXRpb24uaXRlbSwKICAgICAgICAgICAgJHNsaWRlcy5sZW5ndGgsCiAgICAgICAgICAgICQoY29udGV4dC4kd3JhcHBlcikKICAgICAgICAgICk7CiAgICAgICAgICBjb250ZXh0Lm5hdmlnYXRpb24uc2VsZWN0SXRlbShxdWVyeVNsaWRlSW5kZXgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYXJvdXNlbC5zd2lwZVNsaWRlKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAkKHRoaXMpLmFkZENsYXNzKCJpbml0aWFsaXplZCIpOwogICAgfSk7CiAgfTsKCiAgcmV0dXJuIHB1YjsKfSkoalF1ZXJ5KTsKLyoqCiAqIGVuZCBvZiBYQS5jb21wb25lbnQuY2Fyb3VzZWxzIG1vZHVsZS4KICovCgpYQS5yZWdpc3RlcigiY2Fyb3VzZWxzIiwgWEEuY29tcG9uZW50LmNhcm91c2Vscyk7CgovKioKICogWEFDb250ZXh0CiAqCiAqIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuVHJhbnNpdGlvbnMgbW9kdWxlLgogKgogKiBFeHBvc2VzIFRyYW5zaXRpb24gY2xhc3MsIHdoaWNoIGlzIGJhc2UgY2xhc3Mgb2YgYWxsIHRyYW5zaXRpb25zIHVzZWQgYnkgY2Fyb3VzZWxzIChAc2VlIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMsIEBzZWUgU2xpZGVyLCBAc2VlIFRyYW5zaXRpb24pLgogKiBBbHNvIGV4cG9zZXMgaW1wbGVtZW50YXRpb24gb2YgYmFzaWMgZWZmZWN0czoKICogLSBCYXNpY1RyYW5zaXRpb24gLSB3aXRob3V0IGFueSBhbmltYXRpb24sCiAqIC0gRmFkZUluVHJhbnNpdGlvbiAtIG5ldyBzbGlkZSBmYWRlcyBpbiwKICogLSBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24gLSBuZXcgc2xpZGUgbW92ZXMgZnJvbSByaWdodCAoZnJvbSBsZWZ0IGlmIHVzZXIgc2VsZWN0cyBzbGlkZSB3aXRoIGxvd2VyIGlkIG9yIGNsaWNrcyBvbiAncHJldmlvdXMgaXRlbScpLAogKiAtIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24gLSBuZXcgc2xpZGUgbW92ZXMgZnJvbSB0b3AgKGZyb20gYm90dG9tIGlmIHVzZXIgc2VsZWN0cyBzbGlkZSB3aXRoIGxvd2VyIGlkIG9yIGNsaWNrcyBvbiAncHJldmlvdXMgaXRlbScpLgogKiBDYXJvdXNlbCB0YWtlcyB0aGUgY2xhc3MgY29uc3RydWN0b3IgYnkgbmFtZSBmcm9tIHRoaXMgbW9kdWxlIChpdCBpcyBnaXZlbiBpbiBvcHRpb25zIG9iamVjdCBvZiBjYXJvdXNlbDsgQHNlZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzKS4KICogSWYgdGhlcmUgaXMgYSBuZWVkIHRvIGltcGxlbWVudCB0aGUgbmV3IGVmZmVjdCwgY3JlYXRlIGEgbmV3IGNsYXNzLCBieSBpbmhlcml0aW5nIGZyb20gVHJhbnNpdGlvbiBjbGFzcyBhbmQgYWRkIGl0IHRvIHRoaXMgbW9kdWxlLgogKgogKiBFeGFtcGxlIGVmZmVjdCBpbXBsZW1lbnRhdGlvbiAoY3VycmVudGx5IGRpc3BsYXllZCBzbGlkZSBpcyBzaHJpbmtpbmcgdG8gY2VudGVyIG9mIHRoZSBjYXJvdXNlbCk6CiAqIChmdW5jdGlvbiAoKSB7CiogICAgIGZ1bmN0aW9uIFNhbXBsZVRyYW5zaXRpb24oKSB7IH0KKgoqICAgICAvL2luaGVyaXQgZnJvbSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zLlRyYW5zaXRpb24KKiAgICAgU2FtcGxlVHJhbnNpdGlvbi5wcm90b3R5cGUgPSBuZXcgWEEuY29tcG9uZW50LmNhcm91c2Vscy5UcmFuc2l0aW9ucy5UcmFuc2l0aW9uKCk7CiogICAgIFNhbXBsZVRyYW5zaXRpb24uY29uc3RydWN0b3IgPSBTYW1wbGVUcmFuc2l0aW9uOwoqCiogICAgIFNhbXBsZVRyYW5zaXRpb24ucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoc2V0dGluZ3MpIHsKKiAgICAgICAgIC8vcG9zaXRpb25pbmcgYWxsIHNsaWRlcyBpbiB0aGUgdG9wIGxlZnQgY29ybmVyIG9mIHRoZSBjYXJvdXNlbAoqICAgICAgICAgc2V0dGluZ3MuJHNsaWRlcy5jc3MoewoqICAgICAgICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsCiogICAgICAgICAgICAgJ3RvcCc6ICcwcHgnLAoqICAgICAgICAgICAgICdsZWZ0JzogJzBweCcKKiAgICAgICAgIH0pOwoqICAgICB9OwoqCiogICAgIFNhbXBsZVRyYW5zaXRpb24ucHJvdG90eXBlLm9uQW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbihzZXR0aW5ncywgd2lkdGgsIGhlaWdodCkgewoqICAgICAgICAgdmFyIHpJbmRleEF0dHJpYiA9ICd6LWluZGV4JywKKiAgICAgICAgICRjdXJyZW50ID0gc2V0dGluZ3MuJGN1cnJlbnRTbGlkZTsKKgoqICAgICAgICAgJGN1cnJlbnQuaGlkZSgpOwogICAgICAgICAgLy9yZXZlcnRpbmcgY2hhbmdlcyBpbiBjc3MgcHJvcGVydGllcwoqICAgICAgICAgJGN1cnJlbnQuY3NzKHsKKiAgICAgICAgICAgICAnd2lkdGgnOiB3aWR0aCwKKiAgICAgICAgICAgICAnaGVpZ2h0JzogaGVpZ2h0LAoqICAgICAgICAgICAgICdsZWZ0JzogMCwKKiAgICAgICAgICAgICAndG9wJzogMAoqICAgICAgICAgfSk7CiogICAgICAgICAkY3VycmVudC5jc3MoekluZGV4QXR0cmliLCAnJyk7CiogICAgICAgICBzZXR0aW5ncy4kc2xpZGVzLnBhcmVudCgpLmNzcyh6SW5kZXhBdHRyaWIsICcnKTsKKgoqICAgICAgICAgLy9ub3RpZnlpbmcgdGhlIGNhcm91c2VsLCB0aGF0IGFuaW1hdGlvbiBpcyBjb21wbGV0ZWQKKiAgICAgICAgIHNldHRpbmdzLmNhbGxiYWNrKCk7CiogICAgIH07CioKKiAgICAgU2FtcGxlVHJhbnNpdGlvbi5wcm90b3R5cGUucGVyZm9ybSA9IGZ1bmN0aW9uIChzZXR0aW5ncykgewoqICAgICAgICAgdmFyIGhlaWdodCA9IHNldHRpbmdzLiRjdXJyZW50U2xpZGUuaGVpZ2h0KCksCiogICAgICAgICB3aWR0aCA9IHNldHRpbmdzLiRjdXJyZW50U2xpZGUud2lkdGgoKSwKKiAgICAgICAgIG9uQW5pbWF0aW9uQ29tcGxldGVkID0gdGhpcy5vbkFuaW1hdGlvbkNvbXBsZXRlLAoqICAgICAgICAgekluZGV4QXR0cmliID0gJ3otaW5kZXgnLAoqICAgICAgICAgJHBhcmVudCA9IHNldHRpbmdzLiRzbGlkZXMucGFyZW50KCksCiogICAgICAgICAkY3VycmVudCA9IHNldHRpbmdzLiRjdXJyZW50U2xpZGUsCiogICAgICAgICAkbmV4dCA9IHNldHRpbmdzLiRuZXh0U2xpZGU7CioKKiAgICAgICAgIC8vc2V0dGluZyBhIG5ldyBzbGlkZSB1bmRlciB0aGUgY3VycmVudCBzbGlkZQoqICAgICAgICAgJHBhcmVudC5jc3MoekluZGV4QXR0cmliLCAwKTsKKiAgICAgICAgICRjdXJyZW50LmNzcyh6SW5kZXhBdHRyaWIsIDEpOwoqICAgICAgICAgJG5leHQuc2hvdygpOwoqCiogICAgICAgICAvL2FuaW1hdGUgY3VycmVudCBzbGlkZQoqICAgICAgICAgJGN1cnJlbnQuYW5pbWF0ZSh7CiogICAgICAgICAgICAgJ3dpZHRoJzogJzBweCcsCiogICAgICAgICAgICAgJ2hlaWdodCc6ICcwcHgnLAoqICAgICAgICAgICAgICdsZWZ0Jzogd2lkdGggLyAyLAoqICAgICAgICAgICAgICd0b3AnOiBoZWlnaHQgLyAyCiogICAgICAgICB9LCBmdW5jdGlvbigpIHsKKiAgICAgICAgICAgICBvbkFuaW1hdGlvbkNvbXBsZXRlZChzZXR0aW5ncywgd2lkdGgsIGhlaWdodCk7CiogICAgICAgICB9KTsKKiAgICAgfTsKKgoqICAgICAvL2FkZGluZyBuZXcgZWZmZWN0IHRvIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuVHJhbnNpdGlvbnMgbW9kdWxlLgoqICAgICBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zLlNhbXBsZVRyYW5zaXRpb24gPSBTYW1wbGVUcmFuc2l0aW9uOwoqIH0gKCkpOwogKgogKi8KWEEuY29tcG9uZW50LmNhcm91c2Vscy5UcmFuc2l0aW9ucyA9IChmdW5jdGlvbiAoKSB7CiAgdmFyIHB1YiA9IHt9OwoKICAvKioKICAgKiBUcmFuc2l0aW9uU2V0dGluZ3MgY2xhc3MgaG9sZHMgZGF0YSBuZWVkZWQgZm9yIGNoYW5naW5nIHNsaWRlcwogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIFRyYW5zaXRpb25TZXR0aW5ncygpIHt9CiAgLyoqCiAgICogQ3VycmVudCBzbGlkZSAoY3VycmVudGx5IGRpc3BsYXllZCkgalF1ZXJ5IG9iamVjdAogICAqCiAgICogQG1lbWJlciBUcmFuc2l0aW9uU2V0dGluZ3MKICAgKi8KICBUcmFuc2l0aW9uU2V0dGluZ3MucHJvdG90eXBlLiRjdXJyZW50U2xpZGUgPSBudWxsOwogIC8qKgogICAqIE5leHQgc2xpZGUgalF1ZXJ5IG9iamVjdAogICAqCiAgICogQG1lbWJlciBUcmFuc2l0aW9uU2V0dGluZ3MKICAgKi8KICBUcmFuc2l0aW9uU2V0dGluZ3MucHJvdG90eXBlLiRuZXh0U2xpZGUgPSBudWxsOwogIC8qKgogICAqIEFsbCBzbGlkZXMgKGpRdWVyeSBvYmplY3QpCiAgICoKICAgKiBAbWVtYmVyIFRyYW5zaXRpb25TZXR0aW5ncwogICAqLwogIFRyYW5zaXRpb25TZXR0aW5ncy5wcm90b3R5cGUuJHNsaWRlcyA9IG51bGw7CiAgLyoqCiAgICogT2Zmc2V0IGJldHdlZW4gJGN1cnJlbnRTbGlkZSBhbmQgJG5leHRTbGlkZQogICAqCiAgICogQG1lbWJlciBUcmFuc2l0aW9uU2V0dGluZ3MKICAgKi8KICBUcmFuc2l0aW9uU2V0dGluZ3MucHJvdG90eXBlLm9mZnNldCA9IDA7CiAgLyoqCiAgICogQ2FsbGJhY2sgZnVuY3Rpb24gd2hpY2ggbXVzdCBiZSBjYWxsZWQgYWZ0ZXIgYW5pbWF0aW9uLgogICAqCiAgICogQG1lbWJlciBUcmFuc2l0aW9uU2V0dGluZ3MKICAgKi8KICBUcmFuc2l0aW9uU2V0dGluZ3MucHJvdG90eXBlLmNhbGxiYWNrID0gbnVsbDsKICAvKioKICAgKiBlbmQgb2YgVHJhbnNpdGlvblNldHRpbmdzIGNsYXNzCiAgICovCiAgcHViLlRyYW5zaXRpb25TZXR0aW5ncyA9IFRyYW5zaXRpb25TZXR0aW5nczsKCiAgLyoqCiAgICogVHJhbnNpdGlvbiBjbGFzcyBpcyBhIGJhc2UgY2xhc3Mgb2YgYWxsIHRyYW5zaXRpb25zLgogICAqCiAgICogSW1wb3J0YW50OiBzZXR0aW5ncy5jYWxsYmFjaygpIChAc2VlIFRyYW5zaXRpb25TZXR0aW5ncykgaGF2ZSB0byBiZSBjYWxsZWQgYXQgdGhlIGVuZCBvZiBleGVjdXRpb24gdGhlIHBlcmZvcm0oKSBtZXRob2QuCiAgICoKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBUcmFuc2l0aW9uKCkge30KICBUcmFuc2l0aW9uLnByb3RvdHlwZSA9IG5ldyBUcmFuc2l0aW9uKCk7CiAgLyoqCiAgICogSW5pdGlhbGl6ZXMgYSB0cmFuc2l0aW9uIHdpdGggZ2l2ZW4gc2V0dGluZ3MgKEBzZWUgVHJhbnNpdGlvblNldHRpbmdzKS4KICAgKgogICAqIEBtZW1iZXIgVHJhbnNpdGlvbgogICAqIEBwYXJhbSB7VHJhbnNpdGlvblNldHRpbmdzfSBzZXR0aW5ncyAgdHJhbnNpdGlvbiBzZXR0aW5ncwogICAqLwogIC8qIGVzbGludC1kaXNhYmxlICovCiAgVHJhbnNpdGlvbi5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgLy9pbXBsZW1lbnRhdGlvbiB1c2luZyBzZXR0aW5ncwogIH07CiAgLyogZXNsaW50LWVuYWJsZSAqLwogIC8qKgogICAqIFJldHVybnMgYSBmYWN0b3IgYXNzb2NpYXRlZCB3aXRoIHNldHRpbmdzLm9mZnNldCAoQHNlZSBUcmFuc2l0aW9uU2V0dGluZ3MpLCB3aGljaAogICAqIGNhbiBiZSB1c2VmdWxsIGZvciBzb21lIGFuaW1hdGlvbnMuCiAgICoKICAgKiBAbWVtYmVyIFRyYW5zaXRpb24KICAgKiBAcGFyYW0ge1RyYW5zaXRpb25TZXR0aW5nc30gc2V0dGluZ3MgIHRyYW5zaXRpb24gc2V0dGluZ3MKICAgKiBAcmV0dXJuIFRoZSBmYWN0b3I7IDEgaWYgb2Zmc2V0IGlzIGhpZ2hlciB0aGFuIDAsIC0xIG90aGVyd2lzZQogICAqIEB0eXBlIE51bWJlcgogICAqLwogIFRyYW5zaXRpb24ucHJvdG90eXBlLmZhY3RvciA9IGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgcmV0dXJuIHNldHRpbmdzLm9mZnNldCA+IDAgPyAxIDogLTE7CiAgfTsKICAvKioKICAgKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgdXNlZCBieSBjYXJvdXNlbHMgdG8gY2hhbmdlIHNsaWRlcy4KICAgKgogICAqIEltcG9ydGFudDogc2V0dGluZ3MuY2FsbGJhY2soKSAoQHNlZSBUcmFuc2l0aW9uU2V0dGluZ3MpIGhhdmUgdG8gYmUgY2FsbGVkIGF0IHRoZSBlbmQgb2YgdGhpcyBtZXRob2QgZXhlY3V0aW9uLgogICAqCiAgICogQG1lbWJlciBUcmFuc2l0aW9uCiAgICogQHBhcmFtIHtUcmFuc2l0aW9uU2V0dGluZ3N9IHNldHRpbmdzICB0cmFuc2l0aW9uIHNldHRpbmdzCiAgICovCiAgVHJhbnNpdGlvbi5wcm90b3R5cGUucGVyZm9ybSA9IGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgc2V0dGluZ3MuY2FsbGJhY2soKTsKICB9OwogIC8qKgogICAqIEVuZCBvZiBUcmFuc2l0aW9uIGNsYXNzCiAgICovCiAgcHViLlRyYW5zaXRpb24gPSBUcmFuc2l0aW9uOwoKICAvKioKICAgKiBCYXNpY1RyYW5zaXRpb24gY2xhc3MgY2hhbmdlcyBzbGlkZXMgd2l0aG91dCBhbnkgYW5pbWF0aW9uLgogICAqIERvIG5vdCByZW1vdmUgdGhpcyBjbGFzcywgYmVjYW91c2UgY2Fyb3VzZWxzIHdpbGwgdXNlIGl0IGJ5IGRlZmF1bHQsCiAgICogaWYgcmVxdWVzdGVkIHRyYW5zaXRpb24gY2Fubm90IGJlIGZvdW5kLgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIEJhc2ljVHJhbnNpdGlvbigpIHt9CiAgQmFzaWNUcmFuc2l0aW9uLnByb3RvdHlwZSA9IG5ldyBUcmFuc2l0aW9uKCk7CiAgQmFzaWNUcmFuc2l0aW9uLmNvbnN0cnVjdG9yID0gQmFzaWNUcmFuc2l0aW9uOwogIC8qKgogICAqIEBtZW1iZXIgQmFzaWNUcmFuc2l0aW9uCiAgICovCiAgQmFzaWNUcmFuc2l0aW9uLnByb3RvdHlwZS5wZXJmb3JtID0gZnVuY3Rpb24gKHNldHRpbmdzKSB7CiAgICBzZXR0aW5ncy4kY3VycmVudFNsaWRlLmhpZGUoKTsKICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuc2hvdygpOwoKICAgIHNldHRpbmdzLmNhbGxiYWNrKCk7CiAgfTsKICAvKioKICAgKiBFbmQgb2YgQmFzaWNUcmFuc2l0aW9uIGNsYXNzCiAgICovCiAgcHViLkJhc2ljVHJhbnNpdGlvbiA9IEJhc2ljVHJhbnNpdGlvbjsKCiAgLyoqCiAgICogRmFkZUluVHJhbnNpdGlvbiBjbGFzcyBjaGFuZ2VzIHNsaWRlcyBieSBmYWRpbmcgaW4gbmV3IHNsaWRlLgogICAqIFRoaXMgY2xhc3MgY2FuIGJlIHJlbW92ZWQgaWYgZWZmZWN0IGlzIG5vdCB1c2VkLgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIEZhZGVJblRyYW5zaXRpb24oKSB7fQogIEZhZGVJblRyYW5zaXRpb24ucHJvdG90eXBlID0gbmV3IFRyYW5zaXRpb24oKTsKICBGYWRlSW5UcmFuc2l0aW9uLmNvbnN0cnVjdG9yID0gRmFkZUluVHJhbnNpdGlvbjsKICAvKioKICAgKiBAbWVtYmVyIEZhZGVJblRyYW5zaXRpb24KICAgKi8KICBGYWRlSW5UcmFuc2l0aW9uLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKCkgewogICAgLypzZXR0aW5ncy4kc2xpZGVzLmNzcyh7CiAgICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsCiAgICAgICAgICd0b3AnOiAnMHB4JywKICAgICAgICAgJ2xlZnQnOiAnMHB4JwogICAgICAgICB9KTsqLwogIH07CiAgLyoqCiAgICogQG1lbWJlciBGYWRlSW5UcmFuc2l0aW9uCiAgICovCiAgRmFkZUluVHJhbnNpdGlvbi5wcm90b3R5cGUucGVyZm9ybSA9IGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgdmFyIHpJbmRleEF0dHJpYiA9ICJ6LWluZGV4IiwKICAgICAgJHBhcmVudCA9IHNldHRpbmdzLiRzbGlkZXMucGFyZW50KCksCiAgICAgICRuZXh0U2xpZGUgPSBzZXR0aW5ncy4kbmV4dFNsaWRlOwoKICAgICRwYXJlbnQuY3NzKHpJbmRleEF0dHJpYiwgMCk7CiAgICAkbmV4dFNsaWRlLmNzcyh6SW5kZXhBdHRyaWIsIDEpOwogICAgc2V0dGluZ3MuJHNsaWRlcy5jc3MoewogICAgICBwb3NpdGlvbjogInJlbGF0aXZlIiwKICAgIH0pOwoKICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuY3NzKHsKICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgIHRvcDogIjUwJSIsCiAgICAgIGxlZnQ6ICI1MCUiLAogICAgICB0cmFuc2Zvcm06ICJ0cmFuc2xhdGUoLTUwJSwtNTAlKSIsCiAgICB9KTsKCiAgICAkbmV4dFNsaWRlLmZhZGVJbihmdW5jdGlvbiAoKSB7CiAgICAgIHNldHRpbmdzLiRjdXJyZW50U2xpZGUuaGlkZSgpOwoKICAgICAgc2V0dGluZ3MuJG5leHRTbGlkZS5jc3MoewogICAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICAgIGxlZnQ6ICIwIiwKICAgICAgICB0cmFuc2Zvcm06ICJub25lIiwKICAgICAgfSk7CgogICAgICAkbmV4dFNsaWRlLmNzcyh6SW5kZXhBdHRyaWIsICIiKTsKICAgICAgJHBhcmVudC5jc3MoekluZGV4QXR0cmliLCAiIik7CgogICAgICBzZXR0aW5ncy5jYWxsYmFjaygpOwogICAgfSk7CiAgfTsKICAvKioKICAgKiBFbmQgb2YgRmFkZUluVHJhbnNpdGlvbiBjbGFzcwogICAqLwogIHB1Yi5GYWRlSW5UcmFuc2l0aW9uID0gRmFkZUluVHJhbnNpdGlvbjsKCiAgLyoqCiAgICogU2xpZGVIb3Jpem9udGFsbHlUcmFuc2l0aW9uIGNsYXNzIGNoYW5nZXMgc2xpZGVzIGJ5IHNsaWRpbmcgdGhlbSBob3Jpem9udGFsbHkuCiAgICogVGhpcyBjbGFzcyBjYW4gYmUgcmVtb3ZlZCBpZiBlZmZlY3QgaXMgbm90IHVzZWQuCiAgICogSWYgb2Zmc2V0IChkaWZmZXJlbmNlIGJldHdlZW4gaW5kZXggb2YgY3VycmVudGx5IGRpc3BsYXllZCBzbGlkZSBhbmQgaW5kZXggb2Ygc2xpZGUgdGhhdCB3aWxsIGJlIHNob3duKQogICAqIGlzIGdyZWF0ZXIgdGhhbiAwLCBzbGlkZXMgYXJlIHNsaWRpbmcgdG8gdGhlIGxlZnQuIE90aGVyd2lzZSAob2Zmc2V0IGlzIGxvd2VyIHRoYW4gMCksIHNsaWRlcyBhcmUgc2xpZGluZwogICAqIHRvIHRoZSBsZWZ0LgogICAqIFdoZW4gc2xpZGUgY2hhbmdlIGlzIHJhaXNlZCBhdXRvbWF0aWNhbGx5LCBzbGlkZXMgYXJlIGFsd2F5cyBzbGlkaW5nIHRvIHJpZ2h0IChvZmZzZXQgPT0gMSkuCiAgICogSWYgdXNlciByYWlzZXMgc2xpZGVzIGNoYW5nZSwgc2xpZGVzIGFyZSBzbGlkaW5nOgogICAqIC0gdG8gbGVmdCwgaWYgb2Zmc2V0IGlzIGdyZWF0ZXIgdGhhbiAwIChzbGlkZSB3aXRoIGhpZ2hlciBpbmRleCB3aWxsIGJlIHNob3duIG9yIHVzZXIgY2xpY2tzIG9uICduZXh0JyBuYXZpZ2F0aW9uIGl0ZW0pLAogICAqIC0gdG8gcmlnaHQsIGlmIG9mZnNldCBpcyBsb3dlciB0aGFuIDAgKHNsaWRlIHdpdGggbG93ZXIgaW5kZXggd2lsbCBiZSBzaG93biBvciB1c2VyIGNsaWNrcyBvbiAncHJldicgbmF2aWdhdGlvbiBpdGVtKS4KICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24oKSB7fQogIFNsaWRlSG9yaXpvbnRhbGx5VHJhbnNpdGlvbi5wcm90b3R5cGUgPSBuZXcgVHJhbnNpdGlvbigpOwogIFNsaWRlSG9yaXpvbnRhbGx5VHJhbnNpdGlvbi5jb25zdHJ1Y3RvciA9IFNsaWRlSG9yaXpvbnRhbGx5VHJhbnNpdGlvbjsKICAvKioKICAgKiBAbWVtYmVyIFNsaWRlSG9yaXpvbnRhbGx5VHJhbnNpdGlvbgogICAqLwogIFNsaWRlSG9yaXpvbnRhbGx5VHJhbnNpdGlvbi5wcm90b3R5cGUub25BbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uICgKICAgIHNldHRpbmdzLAogICAgJHBhcmVudAogICkgewogICAgc2V0dGluZ3MuJGN1cnJlbnRTbGlkZS5oaWRlKCk7CiAgICBzZXR0aW5ncy4kbmV4dFNsaWRlLmNzcyh7CiAgICAgIHBvc2l0aW9uOiAiIiwKICAgICAgdG9wOiAiIiwKICAgICAgbGVmdDogIiIsCiAgICB9KTsKCiAgICAkcGFyZW50LmNzcygibWFyZ2luLWxlZnQiLCAiIik7CgogICAgc2V0dGluZ3MuY2FsbGJhY2soKTsKICB9OwogIC8qKgogICAqIEBtZW1iZXIgU2xpZGVIb3Jpem9udGFsbHlUcmFuc2l0aW9uCiAgICovCiAgU2xpZGVIb3Jpem9udGFsbHlUcmFuc2l0aW9uLnByb3RvdHlwZS5wZXJmb3JtID0gZnVuY3Rpb24gKHNldHRpbmdzKSB7CiAgICB2YXIgZmFjdG9yID0gdGhpcy5mYWN0b3Ioc2V0dGluZ3MpLAogICAgICBvbkFuaW1hdGlvbkNvbXBsZXRlID0gdGhpcy5vbkFuaW1hdGlvbkNvbXBsZXRlLAogICAgICB3aWR0aCA9IHNldHRpbmdzLiRjdXJyZW50U2xpZGUud2lkdGgoKSwKICAgICAgJHBhcmVudCA9IHNldHRpbmdzLiRzbGlkZXMucGFyZW50KCk7CgogICAgc2V0dGluZ3MuJG5leHRTbGlkZS5jc3MoewogICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgdG9wOiAiMHB4IiwKICAgICAgbGVmdDogZmFjdG9yICogd2lkdGgsCiAgICB9KTsKICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuc2hvdygpOwoKICAgICRwYXJlbnQuYW5pbWF0ZSgKICAgICAgewogICAgICAgICJtYXJnaW4tbGVmdCI6IC1mYWN0b3IgKiB3aWR0aCwKICAgICAgfSwKICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIG9uQW5pbWF0aW9uQ29tcGxldGUoc2V0dGluZ3MsICRwYXJlbnQpOwogICAgICB9CiAgICApOwogIH07CiAgLyoqCiAgICogRW5kIG9mIFNsaWRlSG9yaXpvbnRhbGx5VHJhbnNpdGlvbiBjbGFzcwogICAqLwogIHB1Yi5TbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24gPSBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb247CgogIC8qKgogICAqIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24gY2xhc3MgY2hhbmdlcyBzbGlkZXMgYnkgc2xpZGluZyB0aGVtIHZlcnRpY2FsbHkuCiAgICogVGhpcyBjbGFzcyBjYW4gYmUgcmVtb3ZlZCBpZiB0aGlzIGVmZmVjdCBpcyBub3QgdXNlZC4KICAgKiBJZiBvZmZzZXQgKGRpZmZlcmVuY2UgYmV0d2VlbiBpbmRleCBvZiBjdXJyZW50bHkgZGlzcGxheWVkIHNsaWRlIGFuZCBpbmRleCBvZiBzbGlkZSB0aGF0IHdpbGwgYmUgc2hvd24pCiAgICogaXMgZ3JlYXRlciB0aGFuIDAsIHNsaWRlcyBhcmUgc2xpZGluZyBmcm9tIHVwIHRvIGRvd24uIE90aGVyd2lzZSAob2Zmc2V0IGlzIGxvd2VyIHRoYW4gMCksIHNsaWRlcyBhcmUgc2xpZGluZwogICAqIGZyb20gZG93biB0byB1cC4KICAgKiBXaGVuIHNsaWRlIGNoYW5nZSBpcyByYWlzZWQgYXV0b21hdGljYWxseSwgc2xpZGVzIGFyZSBhbHdheXMgc2xpZGluZyBmcm9tIHVwIHRvIGRvd24gKG9mZnNldCA9PSAxKS4KICAgKiBJZiB1c2VyIHJhaXNlcyBzbGlkZXMgY2hhbmdlLCBzbGlkZXMgYXJlIHNsaWRpbmc6CiAgICogLSBmcm9tIHVwIHRvIGRvd24sIGlmIG9mZnNldCBpcyBncmVhdGVyIHRoYW4gMCAoc2xpZGUgd2l0aCBoaWdoZXIgaW5kZXggd2lsbCBiZSBzaG93biBvciB1c2VyIGNsaWNrcyBvbiAnbmV4dCcgbmF2aWdhdGlvbiBpdGVtKSwKICAgKiAtIGZyb20gZG93biB0byB1cCwgaWYgb2Zmc2V0IGlzIGxvd2VyIHRoYW4gMCAoc2xpZGUgd2l0aCBsb3dlciBpbmRleCB3aWxsIGJlIHNob3duIG9yIHVzZXIgY2xpY2tzIG9uICdwcmV2JyBuYXZpZ2F0aW9uIGl0ZW0pLgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24oKSB7fQogIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24ucHJvdG90eXBlID0gbmV3IFRyYW5zaXRpb24oKTsKICBTbGlkZVZlcnRpY2FsbHlUcmFuc2l0aW9uLmNvbnN0cnVjdG9yID0gU2xpZGVWZXJ0aWNhbGx5VHJhbnNpdGlvbjsKICAvKioKICAgKiBAbWVtYmVyIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24KICAgKi8KICBTbGlkZVZlcnRpY2FsbHlUcmFuc2l0aW9uLnByb3RvdHlwZS5vbkFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24gKAogICAgc2V0dGluZ3MsCiAgICAkcGFyZW50CiAgKSB7CiAgICBzZXR0aW5ncy4kY3VycmVudFNsaWRlLmhpZGUoKTsKICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuY3NzKHsKICAgICAgcG9zaXRpb246ICIiLAogICAgICB0b3A6ICIiLAogICAgICBsZWZ0OiAiIiwKICAgIH0pOwoKICAgICRwYXJlbnQuY3NzKCJtYXJnaW4tdG9wIiwgIiIpOwoKICAgIHNldHRpbmdzLmNhbGxiYWNrKCk7CiAgfTsKICAvKioKICAgKiBAbWVtYmVyIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24KICAgKi8KICBTbGlkZVZlcnRpY2FsbHlUcmFuc2l0aW9uLnByb3RvdHlwZS5wZXJmb3JtID0gZnVuY3Rpb24gKHNldHRpbmdzKSB7CiAgICB2YXIgZmFjdG9yID0gdGhpcy5mYWN0b3Ioc2V0dGluZ3MpLAogICAgICBvbkFuaW1hdGlvbkNvbXBsZXRlID0gdGhpcy5vbkFuaW1hdGlvbkNvbXBsZXRlLAogICAgICBoZWlnaHQgPSBzZXR0aW5ncy4kY3VycmVudFNsaWRlLmhlaWdodCgpLAogICAgICAkcGFyZW50ID0gc2V0dGluZ3MuJHNsaWRlcy5wYXJlbnQoKTsKCiAgICBzZXR0aW5ncy4kbmV4dFNsaWRlLmNzcyh7CiAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICB0b3A6IC1mYWN0b3IgKiBoZWlnaHQsCiAgICAgIGxlZnQ6ICIwcHgiLAogICAgfSk7CiAgICBzZXR0aW5ncy4kbmV4dFNsaWRlLnNob3coKTsKCiAgICAkcGFyZW50LmFuaW1hdGUoCiAgICAgIHsKICAgICAgICAibWFyZ2luLXRvcCI6IGZhY3RvciAqIGhlaWdodCwKICAgICAgfSwKICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIG9uQW5pbWF0aW9uQ29tcGxldGUoc2V0dGluZ3MsICRwYXJlbnQpOwogICAgICB9CiAgICApOwogIH07CiAgLyoqCiAgICogU2xpZGVWZXJ0aWNhbGx5VHJhbnNpdGlvbiBjbGFzcwogICAqLwogIHB1Yi5TbGlkZVZlcnRpY2FsbHlUcmFuc2l0aW9uID0gU2xpZGVWZXJ0aWNhbGx5VHJhbnNpdGlvbjsKCiAgcmV0dXJuIHB1YjsKfSkoalF1ZXJ5KTsKLyoqCiAqIGVuZCBvZiBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zIG1vZHVsZS4KICovCgovKioKICogWEFDb250ZXh0CiAqCiAqIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuSW5kaWNhdG9yVmlld3MgbW9kdWxlLgogKgogKiBFeHBvc2VzIFZpZXcgY2xhc3MsIHdoaWNoIGlzIGEgYmFzZSBjbGFzcyBvZiBhbGwgJ3RpbWUgaW5kaWNhdG9yJyB2aWV3cyB1c2VkIGJ5IGNhcm91c2VscyAoQHNlZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLCBAc2VlIFZpZXcpLgogKiBBbHNvIGV4cG9zZXMgaW1wbGVtZW50YXRpb24gb2YgdGhlc2UgJ3RpbWUgaW5kaWNhdG9yJyB2aWV3czoKICogLSBQcm9ncmVzc0JhclZpZXcgLSBzaG93cyB0aGUgcHJvZ3Jlc3Mgb2YgdGltZSwgdGhhdCBsb29rcyBsaWtlIGEgcHJvZ3Jlc3MgYmFyLAogKiAtIFJvdGF0b3JWaWV3IC0gc2hvd3MgdGhlIHByb2dyZXNzIG9mIHRpbWUgd2l0aCB0aGUgZmlsbGluZyB1cCByaW5nLgogKiBDYXJvdXNlbCB0YWtlcyB0aGUgY2xhc3MgY29uc3RydWN0b3IgYnkgbmFtZSBmcm9tIHRoaXMgbW9kdWxlIChpdCBpcyBnaXZlbiBpbiBvcHRpb25zIG9iamVjdCBvZiBjYXJvdXNlbDsgQHNlZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzKS4KICogSWYgdGhlcmUgaXMgYSBuZWVkIHRvIGltcGxlbWVudCB0aGUgbmV3ICd0aW1lIGluZGljYXRvcicgdmlldywgY3JlYXRlIGEgbmV3IGNsYXNzLAogKiBieSBpbmhlcml0aW5nIGZyb20gVmlldyBjbGFzcyBhbmQgYWRkIGl0IHRvIHRoaXMgbW9kdWxlLiBEdXJpbmcgaW1wbGVtZW50YXRpb24gb2YgYSBuZXcgJ3RpbWUgaW5kaWNhdG9yJwogKiB2aWV3IHRoZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvcnNWaWV3LlRvb2xzIG5hbWVzcGFjZSBtYXkgYmUgdXNlZnVsbC4gSXQgY29udGFpbnM6CiAqIC0gaXNDc3NTdXBwb3J0ZWQocHJvcHMpIGZ1bmN0aW9uLCB3aGljaCBjaGVja3MgaWYgYW55IG9mIENTUyBwcm9wZXJ0aWVzIGlzIHN1cHBvcnRlZCAocHJvcHMgLSBhcnJheSBvZiBwcm9wZXJ0aWVzKSwKICogLSBpc1RyYW5zZm9ybVN1cHBvcnRlZCgpIGZ1bmN0aW9uLCB3aGljaCBjaGVja3MgaWYgQ1NTIDMgJ3RyYW5zZm9ybScgaXMgc3VwcG9ydGVkLgogKgogKiBFeGFtcGxlIHZpZXcgaW1wbGVtZW50YXRpb24gKG9wYWNpdHkgaW5jcmVhc2VzIHdpdGggYSBwcm9ncmVzcyBvZiB0aGUgdGltZSk6CiAqIChmdW5jdGlvbigpIHsKICogICAgIHZhciBWaWV3ID0gWEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3cy5WaWV3OwogKgogKiAgICAgZnVuY3Rpb24gU2FtcGxlVmlldyAoc2VsZWN0b3IsIG9wdGlvbnMpIHsKICogICAgICAgICAvL2Jhc2UgY29uc3RydWN0b3IgaGF2ZSB0byBiZSBjYWxsZWQKICogICAgICAgICBWaWV3LmNhbGwodGhpcywgc2VsZWN0b3IpOwogKiAgICAgfQogKgogKiAgICAgU2FtcGxlVmlldy5wcm90b3R5cGUgPSBuZXcgVmlldygpOwogKiAgICAgU2FtcGxlVmlldy5jb25zdHJ1Y3RvciA9IFNhbXBsZVZpZXc7CiAqCiAqICAgICBTYW1wbGVWaWV3LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKHRpbWVvdXQpIHsKICogICAgICAgICAvL2Jhc2UgbWV0aG9kIGhhdmUgdG8gYmUgY2FsbGVkCiAqICAgICAgICAgVmlldy5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHRpbWVvdXQpOwogKgogKiAgICAgICAgIC8vaW5pdGlhbGl6YXRpb24gY29kZSAtIG5vdCBuZWVkZWQgaW4gdGhpcyBleGFtcGxlCiAqICAgICB9OwogKgogKiAgICAgU2FtcGxlVmlldy5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiAoKSB7CiAqICAgICAgICAgLy9iYXNlIG1ldGhvZCBoYXZlIHRvIGJlIGNhbGxlZAogKiAgICAgICAgIFZpZXcucHJvdG90eXBlLnJlc2V0LmNhbGwodGhpcyk7CiAqCiAqICAgICAgICAgLy9yZXNldGluZyAndGltZSBpbmRpY2F0b3InIHZpZXcKICogICAgICAgICB0aGlzLiRpbmRpY2F0b3Iuc3RvcCh0cnVlKTsKICogICAgICAgICB0aGlzLiRpbmRpY2F0b3IuY3NzKCdvcGFjaXR5JywgMCk7CiAqICAgICB9OwogKgogKiAgICAgU2FtcGxlVmlldy5wcm90b3R5cGUucGF1c2UgPSBmdW5jdGlvbiAoKSB7CiAqICAgICAgICAgLy9zdG9waW5nICd0aW1lIGluZGljYXRvcicgdmlldyBhbmltYXRpb24KICogICAgICAgICB0aGlzLiRpbmRpY2F0b3Iuc3RvcCh0cnVlKTsKICogICAgIH07CiAqCiAqICAgICBTYW1wbGVWaWV3LnByb3RvdHlwZS5wbGF5ID0gZnVuY3Rpb24gKCkgewogKiAgICAgICAgIC8vc3RhcnRpbmcvcmVzdW1pbmcgJ3RpbWUgaW5kaWNhdG9yJyB2aWV3IGFuaW1hdGlvbgogKiAgICAgICAgIHRoaXMuJGluZGljYXRvci5hbmltYXRlKHsKICogICAgICAgICAgICAgJ29wYWNpdHknOiAxCiAqICAgICAgICAgfSwgdGhpcy50aW1lb3V0IC0gdGhpcy50aW1lRWxhcHNlZCwgJ2xpbmVhcicpOwogKiAgICAgfTsKICoKICogICAgIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuSW5kaWNhdG9yVmlld3MuU2FtcGxlVmlldyA9IFNhbXBsZVZpZXc7CiAqIH0oKSk7CiAqCiAqLwpYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvclZpZXdzID0gKGZ1bmN0aW9uICgkKSB7CiAgdmFyIHB1YiA9IHt9LAogICAgc3VwcG9ydEVsZW1lbnRTdHlsZSA9IG51bGw7CgogIC8qKgogICAqIENoZWNrcyBpZiBhbnkgb2YgQ1NTIHByb3BlcnRpZXMgaXMgc3VwcG9ydGVkLgogICAqCiAgICogQHBhcmFtIHtBcnJheX0gcHJvcHMgICAgIGFycmF5IG9mIHByb3BlcnRpZXMgdG8gYmUgY2hlY2tlZAogICAqIEByZXR1cm4gdHJ1ZSBpZiBhbnkgb2YgQ1NTIHByb3BlcnRpZXMgaXMgc3VwcG9ydGVkLCBmYWxzZSBvdGhlcndpc2UKICAgKiBAdHlwZSBCb29sZWFuCiAgICovCiAgZnVuY3Rpb24gaXNDc3NTdXBwb3J0ZWQocHJvcHMpIHsKICAgIHZhciBpLAogICAgICBpc1N1cHBvcnRlZCA9IGZhbHNlOwoKICAgIGlmIChzdXBwb3J0RWxlbWVudFN0eWxlID09PSBudWxsKSB7CiAgICAgIHN1cHBvcnRFbGVtZW50U3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdXBwb3J0RWxlbWVudCIpLnN0eWxlOwogICAgfQoKICAgIGZvciAoaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoc3VwcG9ydEVsZW1lbnRTdHlsZVtwcm9wc1tpXV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlzU3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBpc1N1cHBvcnRlZDsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBDU1MgMyAndHJhbnNmb3JtJyBpcyBzdXBwb3J0ZWQuCiAgICoKICAgKiBAcmV0dXJuIHRydWUgaWYgQ1NTIDMgJ3RyYW5zZm9ybScgaXMgc3VwcG9ydGVkLCBmYWxzZSBvdGhlcndpc2UKICAgKiBAdHlwZSBCb29sZWFuCiAgICovCiAgZnVuY3Rpb24gaXNUcmFuc2Zvcm1TdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gaXNDc3NTdXBwb3J0ZWQoWwogICAgICAidHJhbnNmb3JtUHJvcGVydHkiLAogICAgICAiV2Via2l0VHJhbnNmb3JtIiwKICAgICAgIk1velRyYW5zZm9ybSIsCiAgICAgICJPVHJhbnNmb3JtIiwKICAgICAgIm1zVHJhbnNmb3JtIiwKICAgIF0pOwogIH0KCiAgLyoqCiAgICAgKiBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvclZpZXdzLlRvb2xzIG5hbWVzcGFjZQogICAgICoKICAgICBUaGlzIG5hbWVzcGFjZSBjYW4gYmUgcmVtb3ZlZCBpZiBSb3RhdG9yVmlldyBjbGFzcyBpcyBub3QgdXNlZCAoQHNlZSBSb3RhdG9yVmlldykKICAgICAqLwogIHB1Yi5Ub29scyA9IHt9OwogIHB1Yi5Ub29scy5pc0Nzc1N1cHBvcnRlZCA9IGlzQ3NzU3VwcG9ydGVkOwogIHB1Yi5Ub29scy5pc1RyYW5zZm9ybVN1cHBvcnRlZCA9IGlzVHJhbnNmb3JtU3VwcG9ydGVkOwogIC8qKgogICAqIEVuZCBvZiBuYW1lc3BhY2UKICAgKi8KCiAgLyoqCiAgICogVmlldyBjbGFzcyBpcyBhIGJhc2UgY2xhc3Mgb2YgYWxsICd0aW1lIGluZGljYXRvcicgdmlld3MKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge1N0cmluZ30gc2VsZWN0b3IgYSBzZWxlY3RvciB1c2VkIGZvciBzZWFyY2hpbmcKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAgIFZpZXcgb3B0aW9ucyBvYmplY3QKICAgKi8KICAvKiBlc2xpbnQtZGlzYWJsZSAqLwogIGZ1bmN0aW9uIFZpZXcoc2VsZWN0b3IsIG9wdGlvbnMpIHsKICAgIC8qKgogICAgICogQSBqUXVlcnkgb2JqZWN0IGNvbnRhaW5pbmcgZWxlbWVudCwgd2hpY2ggd2lsbCBiZSBhbmltYXRlZCB0byBzaG93IHBvZ3Jlc3Mgb2YgdGhlIHRpbWUuCiAgICAgKgogICAgICogQG1lbWJlciBWaWV3CiAgICAgKi8KICAgIHRoaXMuJGluZGljYXRvciA9ICQoc2VsZWN0b3IpOwogIH0KICAvKiBlc2xpbnQtZW5hYmxlICovCiAgLyoqCiAgICogSW5pdGlhbGl6ZXMgdGhlIHZpZXcuCiAgICoKICAgKiBAbWVtYmVyIFZpZXdpb24KICAgKiBAcGFyYW0ge051bWJlcn0gdGltZW91dCAgIGEgdGltZW91dCB0byB0aGUgZW5kIG9mIHdob2xlIGluZGljYXRvciBhbmltYXRpb24KICAgKi8KICBWaWV3LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKHRpbWVvdXQpIHsKICAgIHRoaXMudGltZUVsYXBzZWQgPSAwOwogICAgdGhpcy50aW1lb3V0ID0gdGltZW91dDsKICB9OwogIC8qKgogICAqIFJlc2V0cyB0aGUgdmlldwogICAqCiAgICogQG1lbWJlciBWaWV3CiAgICovCiAgVmlldy5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnRpbWVFbGFwc2VkID0gMDsKICB9OwogIC8qKgogICAqIFN0YXJ0cy9SZW5ld3MgdGhlIHZpZXcgYW5pbWF0aW9uLgogICAqCiAgICogQG1lbWJlciBWaWV3CiAgICovCiAgVmlldy5wcm90b3R5cGUucGxheSA9IGZ1bmN0aW9uICgpIHt9OwogIC8qKgogICAqIFBhdXNlcyB0aGUgdmlldyBhbmltYXRpb24uCiAgICoKICAgKiBAbWVtYmVyIFZpZXcKICAgKi8KICBWaWV3LnByb3RvdHlwZS5wYXVzZSA9IGZ1bmN0aW9uICgpIHt9OwogIC8qKgogICAqIFVwZGF0ZXMgdGhlIHRpbWUgdGhhdCBlbGFwc2VkIHNpbmNlIGFuaW1hdGlvbiBiZWdpbi4KICAgKgogICAqIEBtZW1iZXIgVmlldwogICAqLwogIFZpZXcucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICh0aW1lRWxhcHNlZCkgewogICAgdGhpcy50aW1lRWxhcHNlZCA9IHRpbWVFbGFwc2VkOwogIH07CiAgLyoqCiAgICogZW5kIG9mIFZpZXcgY2xhc3MKICAgKi8KICBwdWIuVmlldyA9IFZpZXc7CgogIC8qKgogICAqIFByb2dyZXNzQmFyVmlldyBjbGFzcyBwcm92aWRlcyBhIGxvZ2ljIGZvciBhbmltYXRlIGEgJ3RpbWUgaW5kaWNhdG9yJywKICAgKiB0aGF0IGxvb2tzIGxpa2UgcHJvZ3Jlc3MgYmFyLgogICAqCiAgICogT3B0aW9ucyBvYmplY3Q6CiAgICogewogICAqICAgICAnb3BhY2l0eSc6IE51bWJlciB2YWx1ZSAvL2JldHdlZW4gMCBhbmQgMTsgZGVmYXVsdCBpcyAwLjgKICAgKiB9CiAgICoKICAgKiBUaGlzIGNsYXNzIGNhbiBiZSByZW1vdmVkIGlmIHRoaXMga2luZCBvZiB2aWV3IGlzIG5vdCB1c2VkLgogICAqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yIGEgc2VsZWN0b3IgdXNlZCBmb3Igc2VhcmNoaW5nCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgICBWaWV3IG9wdGlvbnMgb2JqZWN0CiAgICovCiAgZnVuY3Rpb24gUHJvZ3Jlc3NCYXJWaWV3KHNlbGVjdG9yLCBvcHRpb25zKSB7CiAgICBWaWV3LmNhbGwodGhpcywgc2VsZWN0b3IpOwoKICAgIHZhciBkZWZhdWx0cyA9IHsKICAgICAgb3BhY2l0eTogMC44LAogICAgfTsKCiAgICB0aGlzLnNldHRpbmdzID0gJC5leHRlbmQodHJ1ZSwge30sIGRlZmF1bHRzLCBvcHRpb25zKTsKCiAgICB0aGlzLiRjb250YWluZXIgPSB0aGlzLiRpbmRpY2F0b3I7CiAgICB0aGlzLiRpbmRpY2F0b3IgPSB0aGlzLiRpbmRpY2F0b3IuZmluZCgiZGl2Iik7CiAgfQogIFByb2dyZXNzQmFyVmlldy5wcm90b3R5cGUgPSBuZXcgVmlldygpOwogIFByb2dyZXNzQmFyVmlldy5jb25zdHJ1Y3RvciA9IFByb2dyZXNzQmFyVmlldzsKICAvKioKICAgKiBAbWVtYmVyIFByb2dyZXNzQmFyVmlldwogICAqLwogIFByb2dyZXNzQmFyVmlldy5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uICh0aW1lb3V0KSB7CiAgICBWaWV3LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcywgdGltZW91dCk7CgogICAgdmFyIG9wYWNpdHkgPSB0aGlzLnNldHRpbmdzLm9wYWNpdHk7CiAgICB0aGlzLiRjb250YWluZXIuY3NzKCJvcGFjaXR5Iiwgb3BhY2l0eSk7CiAgICB0aGlzLiRpbmRpY2F0b3IuY3NzKCJvcGFjaXR5Iiwgb3BhY2l0eSk7CiAgfTsKICAvKioKICAgKiBAbWVtYmVyIFByb2dyZXNzQmFyVmlldwogICAqLwogIFByb2dyZXNzQmFyVmlldy5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICBWaWV3LnByb3RvdHlwZS5yZXNldC5jYWxsKHRoaXMpOwoKICAgIHRoaXMuJGluZGljYXRvci5zdG9wKHRydWUpOwogICAgdGhpcy4kaW5kaWNhdG9yLmNzcygid2lkdGgiLCAiMHB4Iik7CiAgfTsKICAvKioKICAgKiBAbWVtYmVyIFByb2dyZXNzQmFyVmlldwogICAqLwogIFByb2dyZXNzQmFyVmlldy5wcm90b3R5cGUucGF1c2UgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLiRpbmRpY2F0b3Iuc3RvcCh0cnVlKTsKICB9OwogIC8qKgogICAqIEBtZW1iZXIgUHJvZ3Jlc3NCYXJWaWV3CiAgICovCiAgUHJvZ3Jlc3NCYXJWaWV3LnByb3RvdHlwZS5wbGF5ID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy4kaW5kaWNhdG9yLmFuaW1hdGUoCiAgICAgIHsKICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICB9LAogICAgICB0aGlzLnRpbWVvdXQgLSB0aGlzLnRpbWVFbGFwc2VkLAogICAgICAibGluZWFyIgogICAgKTsKICB9OwogIC8qKgogICAqIGVuZCBvZiBQcm9ncmVzc0JhclZpZXcgY2xhc3MKICAgKi8KICBwdWIuUHJvZ3Jlc3NCYXJWaWV3ID0gUHJvZ3Jlc3NCYXJWaWV3OwoKICAvKioKICAgKiBSb3RhdG9yVmlldyBjbGFzcyBwcm92aWRlcyBhIGxvZ2ljIGZvciBhbmltYXRlIGEgJ3RpbWUgaW5kaWNhdG9yJywKICAgKiB0aGF0IHNob3dzIHRoZSBwcm9ncmVzcyBvZiB0aW1lIHdpdGggdGhlIGZpbGxpbmcgdXAgcmluZwogICAqCiAgICogT3B0aW9ucyBvYmplY3Q6CiAgICogewogICAqICAgICAnb3BhY2l0eSc6IE51bWJlciB2YWx1ZSAvL2JldHdlZW4gMCBhbmQgMTsgZGVmYXVsdCBpcyAwLjUKICAgKiB9CiAgICoKICAgKiBUaGlzIGNsYXNzIGNhbiBiZSByZW1vdmVkIGlmIHRoaXMga2luZCBvZiB2aWV3IGlzIG5vdCB1c2VkLgogICAqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yIGEgc2VsZWN0b3IgdXNlZCBmb3Igc2VhcmNoaW5nCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgICBWaWV3IG9wdGlvbnMgb2JqZWN0CiAgICovCiAgZnVuY3Rpb24gUm90YXRvclZpZXcoc2VsZWN0b3IsIG9wdGlvbnMpIHsKICAgIFZpZXcuY2FsbCh0aGlzLCBzZWxlY3Rvcik7CgogICAgdmFyIGRlZmF1bHRzID0gewogICAgICBvcGFjaXR5OiAwLjUsCiAgICB9OwoKICAgIHRoaXMuc2V0dGluZ3MgPSAkLmV4dGVuZCh0cnVlLCB7fSwgZGVmYXVsdHMsIG9wdGlvbnMpOwogICAgdGhpcy4kbWFzayA9IHRoaXMuJGluZGljYXRvci5maW5kKCJzcGFuLm1hc2siKS5maXJzdCgpOwogICAgdGhpcy4kcm90YXRvciA9IHRoaXMuJGluZGljYXRvci5maW5kKCJzcGFuLnJvdGF0b3IiKS5maXJzdCgpOwoKICAgIGZ1bmN0aW9uIHJvdGF0ZUNzcyhkZWcpIHsKICAgICAgdmFyIHZhbHVlID0gInJvdGF0ZSgiICsgZGVnICsgImRlZykiOwoKICAgICAgcmV0dXJuIHsKICAgICAgICAiLXdlYmtpdC10cmFuc2Zvcm0iOiB2YWx1ZSwKICAgICAgICAiLW1vei10cmFuc2Zvcm0iOiB2YWx1ZSwKICAgICAgICAiLW8tdHJhbnNmb3JtIjogdmFsdWUsCiAgICAgICAgIi1tcy10cmFuc2Zvcm0iOiB2YWx1ZSwKICAgICAgICB0cmFuc2Zvcm06IHZhbHVlLAogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGFuaW1hdGVSb3RhdG9yKCRyb3RhdG9yLCBvcHRpb25zKSB7CiAgICAgIHZhciBkZWZhdWx0cyA9IHsKICAgICAgICAgIGZvbnRTaXplOiAiMTgwcHgiLAogICAgICAgICAgYW5pbWF0ZU9wdGlvbnM6IHsKICAgICAgICAgICAgc3RlcDogZnVuY3Rpb24gKG5vdykgewogICAgICAgICAgICAgICRyb3RhdG9yLmNzcyhyb3RhdGVDc3Mobm93KSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVhc2luZzogImxpbmVhciIsCiAgICAgICAgICB9LAogICAgICAgIH0sCiAgICAgICAgc2V0dGluZ3MgPSAkLmV4dGVuZCh0cnVlLCB7fSwgZGVmYXVsdHMsIG9wdGlvbnMpOwoKICAgICAgJHJvdGF0b3IuYW5pbWF0ZSgKICAgICAgICB7CiAgICAgICAgICAiZm9udC1zaXplIjogc2V0dGluZ3MuZm9udFNpemUsCiAgICAgICAgfSwKICAgICAgICBzZXR0aW5ncy5hbmltYXRlT3B0aW9ucwogICAgICApOwogICAgfQoKICAgIGZ1bmN0aW9uIHBoYXNlVHdvQW5pbWF0aW9uKCRtYXNrLCAkcm90YXRvciwgZHVyYXRpb24pIHsKICAgICAgJHJvdGF0b3IuYWRkQ2xhc3MoImhhbGYiKTsKICAgICAgJG1hc2suYWRkQ2xhc3MoImhhbGYiKTsKCiAgICAgIGFuaW1hdGVSb3RhdG9yKCRyb3RhdG9yLCB7CiAgICAgICAgZm9udFNpemU6ICIzNjBweCIsCiAgICAgICAgYW5pbWF0ZU9wdGlvbnM6IHsKICAgICAgICAgIGR1cmF0aW9uOiBkdXJhdGlvbiwKICAgICAgICB9LAogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBwaGFzZU9uZUFuaW1hdGlvbigkbWFzaywgJHJvdGF0b3IsIGR1cmF0aW9uLCBwaGFzZVR3b0R1cmF0aW9uKSB7CiAgICAgIGFuaW1hdGVSb3RhdG9yKCRyb3RhdG9yLCB7CiAgICAgICAgYW5pbWF0ZU9wdGlvbnM6IHsKICAgICAgICAgIGR1cmF0aW9uOiBkdXJhdGlvbiwKICAgICAgICAgIGNvbXBsZXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHBoYXNlVHdvQW5pbWF0aW9uKCRtYXNrLCAkcm90YXRvciwgcGhhc2VUd29EdXJhdGlvbik7CiAgICAgICAgICB9LAogICAgICAgIH0sCiAgICAgIH0pOwogICAgfQoKICAgIHRoaXMucmVzZXRDc3MgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuJHJvdGF0b3IucmVtb3ZlQ2xhc3MoImhhbGYiKTsKICAgICAgdGhpcy4kcm90YXRvci5jc3Mocm90YXRlQ3NzKDApKTsKICAgICAgdGhpcy4kcm90YXRvci5jc3MoImZvbnQtc2l6ZSIsICIwcHgiKTsKCiAgICAgIHRoaXMuJG1hc2sucmVtb3ZlQ2xhc3MoImhhbGYiKTsKICAgIH07CgogICAgdGhpcy5wbGF5UGhhc2VPbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkdXJhdGlvbiA9IHRoaXMudGltZW91dCAvIDIgLSB0aGlzLnRpbWVFbGFwc2VkOwogICAgICBwaGFzZU9uZUFuaW1hdGlvbih0aGlzLiRtYXNrLCB0aGlzLiRyb3RhdG9yLCBkdXJhdGlvbiwgdGhpcy50aW1lb3V0IC8gMik7CiAgICB9OwoKICAgIHRoaXMucGxheVBoYXNlVHdvID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgZHVyYXRpb24gPSB0aGlzLnRpbWVvdXQgLSB0aGlzLnRpbWVFbGFwc2VkOwogICAgICBwaGFzZVR3b0FuaW1hdGlvbih0aGlzLiRtYXNrLCB0aGlzLiRyb3RhdG9yLCBkdXJhdGlvbik7CiAgICB9OwogIH0KICBSb3RhdG9yVmlldy5wcm90b3R5cGUgPSBuZXcgVmlldygpOwogIFJvdGF0b3JWaWV3LmNvbnN0cnVjdG9yID0gUm90YXRvclZpZXc7CiAgLyoqCiAgICogQG1lbWJlciBSb3RhdG9yVmlldwogICAqLwogIFJvdGF0b3JWaWV3LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKHRpbWVvdXQpIHsKICAgIFZpZXcucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzLCB0aW1lb3V0KTsKCiAgICBpZiAoaXNUcmFuc2Zvcm1TdXBwb3J0ZWQoKSkgewogICAgICB0aGlzLiRpbmRpY2F0b3Iuc2hvdygpOwogICAgICB0aGlzLiRtYXNrLmNzcygib3BhY2l0eSIsIHRoaXMuc2V0dGluZ3Mub3BhY2l0eSk7CiAgICB9CiAgfTsKICAvKioKICAgKiBAbWVtYmVyIFJvdGF0b3JWaWV3CiAgICovCiAgUm90YXRvclZpZXcucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gKCkgewogICAgVmlldy5wcm90b3R5cGUucmVzZXQuY2FsbCh0aGlzKTsKCiAgICB0aGlzLiRyb3RhdG9yLnN0b3AodHJ1ZSk7CiAgICB0aGlzLnJlc2V0Q3NzKCk7CiAgfTsKICAvKioKICAgKiBAbWVtYmVyIFJvdGF0b3JWaWV3CiAgICovCiAgUm90YXRvclZpZXcucHJvdG90eXBlLnBhdXNlID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy4kcm90YXRvci5zdG9wKHRydWUpOwogIH07CiAgLyoqCiAgICogQG1lbWJlciBSb3RhdG9yVmlldwogICAqLwogIFJvdGF0b3JWaWV3LnByb3RvdHlwZS5wbGF5ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHBoYXNlID0gdGhpcy5wbGF5UGhhc2VPbmU7CiAgICBpZiAodGhpcy50aW1lRWxhcHNlZCA+PSB0aGlzLnRpbWVvdXQgLyAyKSB7CiAgICAgIHBoYXNlID0gdGhpcy5wbGF5UGhhc2VUd287CiAgICB9CgogICAgcGhhc2UuY2FsbCh0aGlzKTsKICB9OwogIC8qKgogICAqIGVuZCBvZiBSb3RhdG9yVmlldyBjbGFzcwogICAqLwogIHB1Yi5Sb3RhdG9yVmlldyA9IFJvdGF0b3JWaWV3OwoKICByZXR1cm4gcHViOwp9KShqUXVlcnkpOwovKioKICogZW5kIG9mIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuSW5kaWNhdG9yVmlld3MgbW9kdWxlLgogKi8K
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 64191
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20160727T141858Z
    - ID: "5dd74568-4d4b-44c1-b513-0af5f4cda34f"
      Hint: __Created by
      Value: |
        sitecore\admin
    - ID: "8cdc337e-a112-42fb-bbb4-4143751e123f"
      Hint: __Revision
      Value: "4aaaf280-e5bc-4e25-ab44-ef41a16095b9"
